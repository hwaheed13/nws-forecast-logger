<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üå°Ô∏è NWS Forecast Logger Dashboard (Live)</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --ink:#17324a; --muted:#5c728a;
      --brand:#175398; --brand-2:#1976d2; --ok:#2e7d32; --warn:#f59e0b;
      --ring:#e6eef7; --shadow:0 8px 24px rgba(17,38,146,.08);
    }
    body{
      font-family:"Inter", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background:var(--bg); margin:0; color:var(--ink);
      font-feature-settings:"tnum" 1, "lnum" 1;
    }
    .container{
      max-width:1100px; background:var(--card); margin:32px auto; border-radius:16px;
      box-shadow:var(--shadow); padding:32px 40px 42px;
      border:1px solid var(--ring);
    }
    h1{ margin:0 0 8px 0; color:var(--brand); letter-spacing:.2px; }
    .note{ color:var(--muted); margin:0 0 14px 0; }
    .badge{ display:inline-block; margin-left:8px; padding:4px 8px; font-size:12px;
      border-radius:999px; background:#e8f2ff; color:var(--brand-2); border:1px solid var(--ring); }
    .controls{ display:flex; gap:12px; align-items:center; margin:20px 0 24px;
      position:sticky; top:0; padding:10px 0; background:linear-gradient(#fff,#fff0);
      z-index:1; border-top:1px solid var(--ring); border-bottom:1px solid var(--ring); }
    input[type="date"]{ font-size:14px; padding:7px 8px; border-radius:8px; border:1px solid #cfd9e6; }
    .btn{ background:var(--brand-2); color:#fff; border:none; border-radius:10px;
      padding:8px 14px; cursor:pointer; font-weight:600;
      box-shadow:0 2px 10px rgba(25,118,210,.18);
      transition:transform .04s ease, box-shadow .2s ease, opacity .15s ease; }
    .btn:hover{ box-shadow:0 6px 18px rgba(25,118,210,.22); }
    .btn:active{ transform:translateY(1px); }

    .stats{ display:flex; gap:16px; margin:14px 0 8px 0; }
    .stat-box{ background:#f7fbff; border:1px solid var(--ring);
      border-radius:14px; padding:14px 18px; flex:1; box-shadow:var(--shadow); }
    .stat-val{ font-size:24px; color:var(--brand-2); font-weight:700; }

    #dataTable{ width:100%; border-collapse:collapse; font-size:14px; table-layout:fixed; }
    th, td{ border:1px solid #e6edf6; padding:10px 6px; text-align:center; }
    th{ background:var(--brand-2); color:#fff; position:sticky; top:54px; z-index:1; }
    tr:nth-child(even){ background:#f8fbff; }
    tr:hover td{ background:#eef6ff; }

    .forecast-row{ background:#fffdf3 !important; }
    .actual-row{ background:#f2faf2 !important; }
    .best{ box-shadow:inset 0 0 0 2px #9be19b; }

    .recent-line{ color:var(--brand-2); font-size:15px; font-weight:600; letter-spacing:.02em; }
    .correction-box{ margin:18px 0 16px 0; background:#fffbe9;
      border-left:7px solid #ffd95b; border-radius:8px;
      padding:22px 30px; font-size:1.05em; box-shadow:0 2px 8px #0001; }

    /* Skeleton loader */
    .skel td::before{
      content:""; display:block; height:10px; margin:6px auto; width:70%;
      background:linear-gradient(90deg,#eef3f9,#f8fbff,#eef3f9);
      background-size:200% 100%; animation:sh 1.2s infinite linear;
      border-radius:6px;
    }
    @keyframes sh{ from{background-position:0 0;} to{background-position:200% 0;} }
  </style>
</head>
<body>
  <div class="container">
    <h1>üå°Ô∏è NWS Forecast Logger Dashboard <span class="badge">Live</span></h1>
    <div class="note">
      Automatically logs every NWS forecast update for Central Park and compares to the official daily high.
    </div>
    <div id="recentForecast" class="recent-line">Last logged forecast: ...</div>

    <!-- Summary boxes -->
    <div class="stats">
      <div class="stat-box"><div style="font-size:14px;">Today‚Äôs Forecasted High</div><div id="box-today-forecast" class="stat-val">‚Äì</div></div>
      <div class="stat-box"><div style="font-size:14px;">Today‚Äôs Actual High</div><div id="box-today-actual" class="stat-val">‚Äì</div></div>
      <div class="stat-box"><div style="font-size:14px;">Tomorrow‚Äôs Forecasted High</div><div id="box-tomorrow-forecast" class="stat-val">‚Äì</div></div>
    </div>

    <!-- Corrected prediction boxes -->
    <div class="stats">
      <div id="correctionBoxToday" class="correction-box" style="flex:1;">Loading...</div>
      <div id="correctionBoxTomorrow" class="correction-box" style="flex:1;">Loading...</div>
    </div>

    <div class="controls">
      <label for="from">From:</label><input type="date" id="fromDate"/>
      <label for="to">To:</label><input type="date" id="toDate"/>
      <button class="btn" onclick="applyDateFilter()">Filter</button>
      <button class="btn" onclick="resetFilter()">Show All</button>
      <button class="btn" onclick="reloadCSV()">Reload</button>
    </div>

    <div class="stats" id="stats">
      <div class="stat-box">Total Days: <span class="stat-val">0</span></div>
      <div class="stat-box">Avg Absolute Error: <span class="stat-val">--¬∞F</span></div>
      <div class="stat-box">Avg Best Error: <span class="stat-val">--¬∞F</span></div>
    </div>

    <div class="chart"><canvas id="dailyChart" width="1000" height="400"></canvas></div>
    <div style="overflow-x:auto; margin-top:18px;">
      <table id="dataTable">
        <thead>
          <tr><th>Date Pulled</th><th>Forecast Time</th><th>For Date</th><th>Forecasted High</th><th>Actual High</th><th>High Time</th><th>Error (¬∞F)</th><th>Best?</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let allRows = [], filteredRows = [];

    function showSkeleton(rows=6){
      const tb=document.querySelector("#dataTable tbody"); tb.innerHTML="";
      for(let i=0;i<rows;i++){ const tr=document.createElement("tr"); tr.className="skel"; tr.innerHTML="<td></td>".repeat(8); tb.appendChild(tr);}
    }

    function reloadCSV() {
      showSkeleton();
      fetch("https://raw.githubusercontent.com/hwaheed13/nws-forecast-logger/main/nws_forecast_log.csv?"+Date.now())
        .then(r=>r.text()).then(parseCSV).then(()=>{
          resetFilter();
          showMostRecent();
          updateSummaryBoxes();
          updateCorrectionBoxes();
        })
        .catch(err=>alert("Could not load CSV. "+err));
    }

    function csvToRows(text){
      const rows=[]; let row=[], field="", inQuotes=false;
      for(let i=0;i<text.length;i++){ const c=text[i],n=text[i+1];
        if(c==='"'){ if(inQuotes&&n==='"'){field+='"';i++;} else inQuotes=!inQuotes; }
        else if(c===","&&!inQuotes){ row.push(field);field=""; }
        else if((c==="\n"||c==="\r")&&!inQuotes){ if(c==="\r"&&n==="\n")i++; row.push(field);field=""; if(row.some(x=>x!==""))rows.push(row); row=[]; }
        else field+=c;
      }
      if(field!==""||row.length){ row.push(field); if(row.some(x=>x!==""))rows.push(row);}
      return rows;
    }

    function parseCSV(text){
      const rows=csvToRows(text); if(!rows.length) return;
      const header=rows[0].map(h=>h.trim()); allRows=[];
      for(let i=1;i<rows.length;i++){ const vals=rows[i], rec={};
        for(let j=0;j<header.length;j++){ let v=(vals[j]??"").trim();
          if(v.startsWith('"')&&v.endsWith('"'))v=v.slice(1,-1).replace(/""/g,'"');
          rec[header[j]]=v;
        } allRows.push(rec);
      }
    }

    function resetFilter(){
      filteredRows=allRows.slice();
      document.getElementById("fromDate").value=""; document.getElementById("toDate").value="";
      displayTable(); showStats(); showChart(); showMostRecent(); updateCorrectionBoxes();
    }

    function applyDateFilter(){
      const from=document.getElementById("fromDate").value,to=document.getElementById("toDate").value;
      filteredRows=allRows.filter(r=>{
        const d=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!d)return false; if(from&&d<from)return false; if(to&&d>to)return false; return true;
      });
      displayTable(); showStats(); showChart(); showMostRecent(); updateCorrectionBoxes();
    }

    function showMostRecent(){
      const fcRows=allRows.filter(r=>r.forecast_or_actual==="forecast"&&r.predicted_high&&r.target_date);
      if(!fcRows.length){document.getElementById("recentForecast").innerHTML="";return;}
      fcRows.sort((a,b)=>(b.timestamp||b.forecast_time).localeCompare(a.timestamp||a.forecast_time));
      const recent=fcRows[0];
      document.getElementById("recentForecast").innerHTML=`Last logged forecast: <b>${recent.forecast_time||recent.timestamp}</b> ‚Äî <b>${recent.predicted_high}¬∞F</b> (for <b>${recent.target_date}</b>)`;
    }

    function calcBiases(lastN=14){
      const biasList=[], dayMap={};
      allRows.forEach(r=>{
        const d=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!d)return; if(!dayMap[d])dayMap[d]=[]; dayMap[d].push(r);
      });
      const dates=Object.keys(dayMap).sort();
      dates.forEach(d=>{
        const rows=dayMap[d], actual=rows.find(r=>r.forecast_or_actual==="actual"&&r.actual_high);
        if(!actual) return; const actualHigh=Number(actual.actual_high);
        let bestErr=999,lastFc=null;
        rows.forEach(r=>{
          if(r.forecast_or_actual!=="forecast"||!r.predicted_high)return;
          const err=Math.abs(Number(r.predicted_high)-actualHigh);
          if(err<bestErr){bestErr=err; lastFc=r;}
        });
        if(lastFc) biasList.push(actualHigh-Number(lastFc.predicted_high));
      });
      return biasList.slice(-lastN);
    }

    function updateCorrectionBoxes(){
      const biasList=calcBiases(); const avgBias=biasList.length?biasList.reduce((a,b)=>a+b,0)/biasList.length:0;
      const today=new Date().toISOString().slice(0,10);
      const tomorrow=new Date(Date.now()+86400000).toISOString().slice(0,10);

      const todayFc=allRows.filter(r=>r.forecast_or_actual==="forecast"&&r.target_date===today);
      const tomorrowFc=allRows.filter(r=>r.forecast_or_actual==="forecast"&&r.target_date===tomorrow);

      const todayPred=todayFc.length?Number(todayFc[todayFc.length-1].predicted_high)+avgBias:null;
      const tomorrowPred=tomorrowFc.length?Number(tomorrowFc[tomorrowFc.length-1].predicted_high)+avgBias:null;

      document.getElementById("correctionBoxToday").innerHTML=
        `<b>Today's Corrected Prediction:</b><br><span style="font-size:1.6em;">${today}: <b>${todayPred?todayPred.toFixed(1)+"¬∞F":"‚Äì"}</b></span>`;
      document.getElementById("correctionBoxTomorrow").innerHTML=
        `<b>Tomorrow's Corrected Prediction:</b><br><span style="font-size:1.6em;">${tomorrow}: <b>${tomorrowPred?tomorrowPred.toFixed(1)+"¬∞F":"‚Äì"}</b></span>`;
    }

    /* --- Stats, chart, table functions remain same as before --- */
    function showStats(){/* ... keep your existing code ... */}
    function showChart(){/* ... keep your existing code ... */}
    function displayTable(){/* ... keep your existing code ... */}

    reloadCSV();
  </script>
</body>
</html>
