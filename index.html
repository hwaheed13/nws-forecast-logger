<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üå°Ô∏è NWS Forecast Logger Dashboard (Live)</title>
<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 20px;
    background: #fafafa;
    color: #222;
  }

  h1 { margin-bottom: 10px; }

  .controls {
    margin-bottom: 18px;
  }

  /* Table styling */
  .table-wrap {
    overflow-x: auto;   /* allow horizontal scroll if narrow screen */
    overflow-y: visible; /* page scrolls, not inner div */
    margin-top: 18px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    font-size: 14px;
    background: #fff;
    border: 1px solid #ddd;
  }

  th, td {
    padding: 8px 12px;
    border: 1px solid #ddd;
    text-align: center;
  }

  thead th {
    position: sticky;
    top: 0; /* sticks to the very top of viewport */
    background: #004080;
    color: #fff;
    z-index: 5;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
  }

  tbody tr:nth-child(even) {
    background: #f9f9f9;
  }

  /* Stats cards */
  .stats{ display:flex; gap:16px; margin:14px 0 8px 0; }
  .stat-box{ background:#f7fbff; border:1px solid var(--ring);
    border-radius:14px; padding:14px 18px; flex:1; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
  .stat-val{ font-size:24px; color:#004080; font-weight:700; }

  /* Distinct colors for the three summary cards */
  #card-today-forecast  { background:#fff5eb; border-color:#ffe6c7; }
  #card-today-actual    { background:#f0fff4; border-color:#c8f2d0; }
  #card-tomorrow-forecast { background:#ebf5ff; border-color:#cfe6ff; }

</style>
</head>
<body>
  <h1>üå°Ô∏è NWS Forecast Logger Dashboard (Live)</h1>

  <!-- Summary cards -->
  <div class="stats">
    <div class="stat-box" id="card-today-forecast">
      <div id="todayForecastBox"></div>
    </div>
    <div class="stat-box" id="card-today-actual">
      <div id="todayActualBox"></div>
    </div>
    <div class="stat-box" id="card-tomorrow-forecast">
      <div id="tomorrowForecastBox"></div>
    </div>
  </div>

  <!-- Data Table -->
  <div class="table-wrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Date Pulled</th>
          <th>Forecast Time</th>
          <th>For Date</th>
          <th>Forecasted High</th>
          <th>Actual High</th>
          <th>High Time</th>
          <th>Error (¬∞F)</th>
          <th>Best?</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
// Dummy loader ‚Äì replace with fetch of your CSV
let allRows = []; // will hold parsed rows

// Example: parse and populate data
function loadCSV(){
  // In production, fetch from nws_forecast_log.csv and parse
  // allRows = [...]
  updateTable();
  updateCorrectionBoxes();
}

function updateTable(){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  allRows.forEach(r=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${r.cli_date||""}</td>
      <td>${r.forecast_time||""}</td>
      <td>${r.target_date||""}</td>
      <td>${r.predicted_high||""}</td>
      <td>${r.actual_high||""}</td>
      <td>${r.high_time||""}</td>
      <td>${r.error||""}</td>
      <td>${r.best?"‚úì":""}</td>`;
    tbody.appendChild(tr);
  });
}

/* --------- Bias calculation with pre-high filter --------- */
function compareTimes(a, b){
  // compares "HH:MM" strings
  return a.localeCompare(b);
}

function calcBiases(){
  const biasList=[];
  const dayMap={};

  allRows.forEach(r=>{
    const d=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
    if(!d)return;
    if(!dayMap[d])dayMap[d]=[];
    dayMap[d].push(r);
  });

  const dates=Object.keys(dayMap).sort();
  dates.forEach(d=>{
    const rows=dayMap[d];
    const actual=rows.find(r=>r.forecast_or_actual==="actual"&&r.actual_high);
    if(!actual)return;
    const actualHigh=Number(actual.actual_high);
    const highTime=actual.high_time||"";

    let fcVals=[];
    rows.forEach(r=>{
      if(r.forecast_or_actual!=="forecast"||!r.predicted_high) return;
      if(highTime){
        const fcHour=(r.forecast_time||"").substr(11,5);
        if(fcHour && compareTimes(fcHour, highTime) > 0) return;
      }
      fcVals.push(Number(r.predicted_high));
    });

    if(fcVals.length){
      const meanFc=fcVals.reduce((a,b)=>a+b,0)/fcVals.length;
      biasList.push(actualHigh - meanFc);
    }
  });
  return biasList;
}

/* --------- Correction boxes --------- */
function mean(arr){ return arr.reduce((a,b)=>a+b,0)/arr.length; }

function meanForecastForDate(date){
  const vals=allRows.filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high)
    .map(r=>Number(r.predicted_high));
  if(!vals.length)return null;
  return mean(vals);
}

function updateCorrectionBoxes(){
  const biasList=calcBiases();
  const avgBias=biasList.length?mean(biasList):0;
  const biasTxt=(avgBias>0?"+":"")+avgBias.toFixed(2);

  const today=new Date().toISOString().slice(0,10);
  const tomorrow=new Date(Date.now()+86400000).toISOString().slice(0,10);

  const todayPred=meanForecastForDate(today);
  const tomorrowPred=meanForecastForDate(tomorrow);

  document.getElementById("todayForecastBox").innerHTML=
    `<b>Today's Corrected Prediction:</b><br>
     <span class="stat-val">${todayPred==null?"‚Äì":(todayPred+avgBias).toFixed(1)}¬∞F</span><br>
     <span style="color:#666;">Bias: ${biasTxt}¬∞F (avg of ${biasList.length} days)</span>`;

  const actualRow=allRows.find(r=>r.forecast_or_actual==="actual" && r.cli_date===today && r.actual_high);
  document.getElementById("todayActualBox").innerHTML=
    `<b>Today's Actual High:</b><br>
     <span class="stat-val">${actualRow?actualRow.actual_high+"¬∞F":"‚Äì"}</span>`;

  document.getElementById("tomorrowForecastBox").innerHTML=
    `<b>Tomorrow's Corrected Prediction:</b><br>
     <span class="stat-val">${tomorrowPred==null?"‚Äì":(tomorrowPred+avgBias).toFixed(1)}¬∞F</span><br>
     <span style="color:#666;">Bias: ${biasTxt}¬∞F (avg of ${biasList.length} days)</span>`;
}

// run
loadCSV();
</script>
</body>
</html>
