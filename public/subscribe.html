<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscribe – Daily Dew Point</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --b:#cbd5e1; --b2:#94a3b8; --blue:#2563eb; --blue2:#1e40af; --ok:#16a34a;}
    html,body{height:100%}
    body { font-family:'Inter',system-ui,sans-serif; display:flex; align-items:center; justify-content:center;
           min-height:100%; margin:0; background:var(--bg); color:var(--fg); padding:16px; }
    .card { background:#fff; padding:28px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.08);
            width:100%; max-width:460px; text-align:center; border:1px solid #e2e8f0; }
    h1 { font-size:22px; margin:0 0 6px; }
    p.sub { margin:0 0 14px; color:var(--muted); font-size:14px; }
    .plans { display:flex; gap:12px; justify-content:center; margin:18px 0 6px; flex-wrap:wrap; }
    .plan { flex:1; min-width:180px; padding:16px; border:2px solid var(--b); border-radius:10px; cursor:pointer; }
    .plan small{ display:block; margin-top:4px; color:var(--muted); }
    .plan.active { border-color:var(--blue); background:#eff6ff; }
    button { width:100%; padding:14px; border:none; border-radius:10px; background:var(--blue); color:white;
             font-weight:700; font-size:15px; cursor:pointer; margin-top:14px; }
    button:hover { background:var(--blue2); }
    button[disabled]{ opacity:.6; cursor:default; }
    .note { font-size:12px; margin-top:10px; color:var(--muted); }
    .top-links{ display:flex; justify-content:center; gap:12px; margin-top:10px; font-size:13px }
    .top-links a{ color:var(--blue); text-decoration:none }
    .alert{ margin-top:12px; font-size:13px; padding:10px 12px; border-radius:8px; border:1px solid var(--b); color:#334155; background:#f1f5f9; display:none}
    .alert.ok{ border-color:#a7f3d0; color:#065f46; background:#ecfdf5; display:block}
    .alert.err{ border-color:#fecaca; color:#7f1d1d; background:#fef2f2; display:block}
  </style>
</head>
<body>
  <div class="card">
    <h1>Choose your plan</h1>
    <p class="sub">You’ll be redirected to Stripe Checkout.</p>

    <div class="plans" role="radiogroup" aria-label="Plans">
      <div class="plan" tabindex="0" role="radio" aria-checked="false" data-plan="monthly">
        <strong>$3 / month</strong>
        <small>Billed monthly. Cancel anytime.</small>
      </div>
      <div class="plan" tabindex="0" role="radio" aria-checked="false" data-plan="yearly">
        <strong>$30 / year</strong>
        <small>Best value. Billed annually.</small>
      </div>
    </div>

    <button id="btn-subscribe">Subscribe</button>
    <div class="top-links">
      <a href="/index.html">Back to dashboard</a>
      <span>·</span>
      <a href="/login.html?switch=1">Back to login / sign-up</a>\
    </div>
    <div id="toast" class="alert"></div>
    <div class="note">Already subscribed? You’ll be sent back to the dashboard automatically.</div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  const supabase = createClient(
    "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw"
  );

  const PRICE_IDS = {
    monthly: "price_1S1U96JZv8wNnhLtlNWL0gqK",
    yearly:  "price_1S1U7hJZv8wNnhLtRLRLoVf3"
  };

  const $ = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const toast = $("#toast");
  const params = new URLSearchParams(location.search);
  const ALLOW = new Set(["active","trialing"]);

  function showToast(msg, kind="err"){
    toast.textContent = msg;
    toast.className = "alert " + kind;
  }

  // Show basic messages if coming back from Stripe
  if (params.get("success")) showToast("Payment succeeded. Finalizing…", "ok");
  if (params.get("canceled")) showToast("Checkout canceled.", "err");

  async function routeIfActive(userId){
    const { data: profile } = await supabase
      .from("profiles")
      .select("subscription_status")
      .eq("id", userId)
      .maybeSingle();
    const status = profile?.subscription_status ?? "inactive";
    if (ALLOW.has(status)) {
      window.location.href = "/index.html";
      return true;
    }
    return false;
  }

  // Gate the page: must be logged in; if active/trialing, bounce to dashboard.
  (async () => {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user?.id) { window.location.href = "/login.html"; return; }

    // If coming back from Stripe success, poll briefly for webhook to land.
    if (params.get("success")) {
      // small retry loop (about ~6s total)
      for (let i = 0; i < 8; i++) {
        await supabase.auth.refreshSession();
        const done = await routeIfActive(session.user.id);
        if (done) return;
        await new Promise(r => setTimeout(r, 750));
      }
      // If still not active, we’ll fall through and show plans.
      showToast("Almost there—your payment is processing. If this doesn’t update soon, refresh.", "ok");
    } else {
      // Normal load: immediately route if already active/trialing
      const done = await routeIfActive(session.user.id);
      if (done) return;
    }
  })();

  // ── Plan selection UI ────────────────────────────────────────────────────────
  let selectedPlan = null;
  function setActivePlan(el){
    $$(".plan").forEach(p => { p.classList.remove("active"); p.setAttribute("aria-checked","false"); });
    el.classList.add("active");
    el.setAttribute("aria-checked","true");
    selectedPlan = el.dataset.plan;
  }
  $$(".plan").forEach(el => {
    el.addEventListener("click", () => setActivePlan(el));
    el.addEventListener("keydown", (e) => {
      if (e.key === " " || e.key === "Enter") { e.preventDefault(); setActivePlan(el); }
    });
  });

  // ── Subscribe button → create Stripe Checkout session ────────────────────────
  const btn = $("#btn-subscribe");
  btn.addEventListener("click", async () => {
    if (!selectedPlan) return showToast("Select a plan first.");
    btn.disabled = true; showToast("Creating checkout session…", "ok");

    const { data: { session }, error } = await supabase.auth.getSession();
    if (error || !session) { btn.disabled = false; window.location.href = "/login.html"; return; }

    try {
      const r = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          priceId: PRICE_IDS[selectedPlan],
          plan: selectedPlan,
          supabaseAccessToken: session.access_token,
          // Make sure your server uses this as success_url:
          // e.g., `${origin}/subscribe.html?success=1`
        })
      });

      const data = await r.json();
      if (!r.ok || !data?.url) {
        btn.disabled = false;
        return showToast(data?.error || "Could not start checkout. Check server logs.");
      }
      window.location.href = data.url; // Stripe Checkout
    } catch (e) {
      btn.disabled = false;
      showToast(e.message || "Network error starting checkout.");
    }
  });
</script>
</body>
</html>
