<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subscribe – Daily Dew Point</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#f8fafc; --fg:#0f172a; --muted:#64748b; --b:#cbd5e1; --blue:#2563eb; --blue2:#1e40af;}
    html,body{height:100%}
    body { font-family:'Inter',system-ui,sans-serif; display:flex; align-items:center; justify-content:center;
      min-height:100%; margin:0; background:var(--bg); color:var(--fg); padding:16px; }
    .card { background:#fff; padding:28px; border-radius:12px; box-shadow:0 4px 16px rgba(0,0,0,.08);
      width:100%; max-width:460px; text-align:center; border:1px solid #e2e8f0; }
    h1 { font-size:22px; margin:0 0 6px; }
    p.sub { margin:0 0 14px; color:var(--muted); font-size:14px; }
    .plans { display:flex; gap:12px; justify-content:center; margin:18px 0 6px; flex-wrap:wrap; }
    .plan { flex:1; min-width:180px; padding:16px; border:2px solid var(--b); border-radius:10px; cursor:pointer; }
    .plan small{ display:block; margin-top:4px; color:var(--muted); }
    .plan.active { border-color:var(--blue); background:#eff6ff; }
    button { width:100%; padding:14px; border:none; border-radius:10px; background:var(--blue); color:white;
      font-weight:700; font-size:15px; cursor:pointer; margin-top:14px; }
    button:hover { background:var(--blue2); }
    button[disabled]{ opacity:.6; cursor:default; }
    .note { font-size:12px; margin-top:10px; color:var(--muted); }
    .top-links{ display:flex; justify-content:center; gap:12px; margin-top:10px; font-size:13px }
    .top-links a{ color:var(--blue); text-decoration:none }
    .alert{ margin-top:12px; font-size:13px; padding:10px 12px; border-radius:8px; border:1px solid #e2e8f0; color:#334155; background:#f1f5f9; display:none}
    .alert.ok{ border-color:#a7f3d0; color:#065f46; background:#ecfdf5; display:block}
    .alert.err{ border-color:#fecaca; color:#7f1d1d; background:#fef2f2; display:block}
    #btn-trial{ background:#0ea5e9; } #btn-trial:hover{ background:#0284c7; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Choose your plan</h1>
    <p class="sub">You’ll be redirected to Stripe Checkout.</p>

    <div class="plans" role="radiogroup" aria-label="Plans">
      <div class="plan" tabindex="0" role="radio" aria-checked="false" data-plan="monthly">
        <strong>$3 / month</strong>
        <small>Billed monthly. Cancel anytime.</small>
      </div>
      <div class="plan" tabindex="0" role="radio" aria-checked="false" data-plan="yearly">
        <strong>$30 / year</strong>
        <small>Best value. Billed annually.</small>
      </div>
    </div>

    <button id="btn-subscribe">Subscribe</button>
    <!-- Trial button lives in DOM; we toggle visibility in JS -->
    <button id="btn-trial" style="display:none;margin-top:10px;">Try free for 3 days</button>

    <div class="top-links">
      <a href="/index.html">Back to dashboard</a>
      <span>·</span>
      <a href="/login.html">Back to login / sign-up</a>
    </div>
    <div id="toast" class="alert"></div>
    <div class="note">Already subscribed? You’ll be sent back to the dashboard automatically.</div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  // --- Supabase ---
  const supabase = createClient(
    "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw",
    { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
  );

  // --- Config ---
  const PRICE_IDS = {
    monthly: "price_1S1U96JZv8wNnhLtlNWL0gqK",
    yearly:  "price_1S1U7hJZv8wNnhLtRLRLoVf3"
  };

  // --- Dom utils ---
  const $ = (s,p=document)=>p.querySelector(s);
  const $$= (s,p=document)=>Array.from(p.querySelectorAll(s));
  const toast = $("#toast");
  function showToast(msg, kind="err"){ toast.textContent = msg; toast.className = "alert " + kind; }

  // --- Global error surfacing ---
  window.addEventListener("error", (e) => {
    console.error("Runtime error:", e.error || e.message);
    showToast((e?.error?.message || e.message || "Script error"), "err");
  });

  // --- Return messages / welcome toast ---
  const params = new URLSearchParams(location.search);
  if (params.get("success")) showToast("Payment succeeded. Finalizing…", "ok");
  if (params.get("canceled")) showToast("Checkout canceled.", "err");
  const hash = new URLSearchParams(location.hash.slice(1));
  if (params.get("welcome") || hash.get("type") === "signup") {
    showToast("Email confirmed — pick a plan to continue.", "ok");
  }

  // --- Plan selection (bind early so UI works even if async redirects later) ---
  let selectedPlan = null;
  function setActivePlan(el){
    $$(".plan").forEach(p => { p.classList.remove("active"); p.setAttribute("aria-checked","false"); });
    el.classList.add("active");
    el.setAttribute("aria-checked","true");
    selectedPlan = el.dataset.plan;
  }
  $$(".plan").forEach(el=>{
    el.addEventListener("click", ()=>setActivePlan(el));
    el.addEventListener("keydown",(e)=>{
      if (e.key === " " || e.key === "Enter") { e.preventDefault(); setActivePlan(el); }
    });
  });

  // --- Gate + trial visibility (single, hardened IIFE) ---
  (async ()=>{
    const { data: { session }, error: sessErr } = await supabase.auth.getSession();
    if (sessErr) { console.error("getSession err:", sessErr); return (window.location.href="/login.html"); }
    if (!session) return (window.location.href="/login.html");

    const { data: profile, error: profErr } = await supabase
      .from("profiles")
      .select("subscription_status, free_trial_used")
      .eq("id", session.user.id)
      .single();

    if (profErr) {
      console.error("profiles select error:", profErr);
      // Let new users see the trial even if select fails (RLS/missing row)
      document.getElementById("btn-trial").style.display = "block";
      return;
    }

    if (profile?.subscription_status === "active") {
      return (window.location.href = "/index.html");
    }

    if (!profile?.free_trial_used) {
      document.getElementById("btn-trial").style.display = "block";
    }
  })();

  // --- Subscribe flow ---
  $("#btn-subscribe").addEventListener("click", async ()=>{
    if (!selectedPlan) return showToast("Select a plan first.");
    $("#btn-subscribe").disabled = true; showToast("Creating checkout session…", "ok");

    const { data: { session }, error } = await supabase.auth.getSession();
    if (error || !session) { $("#btn-subscribe").disabled = false; return (window.location.href="/login.html"); }

    try{
      const r = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          priceId: PRICE_IDS[selectedPlan],
          plan: selectedPlan,
          supabaseAccessToken: session.access_token
        })
      });
      const data = await r.json();
      if (!r.ok || !data?.url) {
        $("#btn-subscribe").disabled = false;
        return showToast(data?.error || "Could not start checkout.", "err");
      }
      window.location.href = data.url;
    }catch(e){
      $("#btn-subscribe").disabled = false;
      showToast(e.message || "Network error.", "err");
    }
  });

  // --- Free trial flow ---
  $("#btn-trial").addEventListener("click", async ()=>{
    const btn = $("#btn-trial");
    btn.disabled = true; showToast("Starting your free trial…", "ok");

    const { data: { session }, error } = await supabase.auth.getSession();
    if (error || !session) { btn.disabled = false; return (window.location.href="/login.html"); }

    try{
      const r = await fetch("/api/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ trial: true, supabaseAccessToken: session.access_token })
      });
      const data = await r.json();
      if (!r.ok || !data?.url) {
        btn.disabled = false;
        if (data?.error === "already_subscribed") return showToast("You already have a subscription.", "err");
        if (data?.error === "trial_already_used") return showToast("You’ve already used your free trial.", "err");
        return showToast(data?.error || "Could not start trial.", "err");
      }
      window.location.href = data.url;
    }catch(e){
      btn.disabled = false;
      showToast(e.message || "Network error.", "err");
    }
  });
</script>
</body>
</html>
