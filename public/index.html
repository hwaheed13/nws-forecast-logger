<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå°Ô∏è Daily Dew Point Dashboard</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-accent: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --border-subtle: #e2e8f0;
      --border-default: #cbd5e1;
      --accent-blue: #2563eb;
      --accent-blue-light: #dbeafe;
      --accent-green: #059669;
      --accent-green-light: #d1fae5;
      --accent-amber: #d97706;
      --accent-amber-light: #fef3c7;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, .05);
    }

    * { box-sizing: border-box; }

    /* Gate (shows immediately, then hidden on boot) */
    #gate {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh;
      background: var(--bg-primary); color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      padding: 24px; text-align: center;
    }
    .gate-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle);
      border-radius: 16px; padding: 24px 22px; box-shadow: var(--shadow-sm);
      max-width: 520px; width: 100%;
    }
    .gate-title { font-size: 18px; font-weight: 800; margin: 0 0 6px; }
    .gate-sub { font-size: 14px; color: var(--text-muted); margin: 0 0 12px; }
    .gate-note { font-size: 12px; color: var(--text-light); }
    .gate-spinner { width: 28px; height: 28px; border-radius: 50%;
      border: 3px solid var(--border-subtle); border-top-color: var(--accent-blue);
      margin: 12px auto 8px; animation: spin 1s linear infinite;
    }
    .gate-error { color: #dc2626; font-size: 14px; margin: 12px 0; }
    .gate-btn { 
      background: var(--accent-blue); color: white; border: none; 
      padding: 8px 16px; border-radius: 8px; cursor: pointer; 
      font-size: 14px; margin: 4px; transition: opacity 0.2s;
    }
    .gate-btn:hover { opacity: 0.8; }
    body.app-ready #gate { display: none !important; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* App */
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg-primary); color: var(--text-primary);
      margin: 0; line-height: 1.6;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 0; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px);
    }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 0 20px;
      display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; justify-content: space-between; gap: 14px; }
    .brand-left { display: flex; align-items: center; gap: 12px; }
    .brand-mark { display: grid; place-items: center; width: 40px; height: 40px;
      border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light));
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-subtle); position: relative; top: -3px; }
    .brand-mark svg { display: block; transform: translate(1px, 1px); }
    .brand-title { margin: 0; font-weight: 800; letter-spacing: .2px;
      font-size: 28px; line-height: 1.15; color: var(--text-primary); }
    .brand-title .thin { font-weight: 600; color: var(--text-secondary); }
    .brand-sub { margin: 2px 0 0; font-size: 13px; color: var(--text-muted); }
    .brand-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .brand-right .pill-group { display: flex; gap: 6px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; font-size: 12px; font-weight: 700;
      color: var(--text-secondary); background: var(--bg-accent); border: 1px solid var(--border-subtle); border-radius: 999px; }
    .pill.live { background: var(--accent-green-light); color: var(--accent-green); border-color: transparent; }
    .pill.live .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .pill.logout-btn { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-default); cursor: pointer; }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .metric-card { background: var(--bg-secondary); border: 1.5px solid var(--border-subtle); border-radius: 18px; padding: 24px;
      box-shadow: var(--shadow-sm); position: relative; overflow: hidden; margin-bottom: 20px; }
    .metric-card::before { content: ''; position: absolute; inset: 0 0 auto; height: 4px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green)); }
    .metric-label { font-size: 14px; color: var(--text-muted); margin-bottom: 6px; font-weight: 700; letter-spacing: .02em; }
    .metric-value { font-size: 36px; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; line-height: 1; }
    .metric-subtitle { font-size: 13px; color: var(--text-light); }

    .footer { margin-top: 28px; padding: 18px 24px; background: var(--bg-tertiary); border-top: 1px solid var(--border-subtle);
      text-align: center; font-size: 12px; color: var(--text-light); }
    .footer a { color: var(--accent-blue); text-decoration: none; }

    #todayDate { display: block; font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 10px; }
  </style>
</head>

<body>
  <!-- ====== LOGIN GATE ====== -->
  <div id="gate" role="status" aria-live="polite">
    <div class="gate-card">
      <div class="gate-title">Checking access‚Ä¶</div>
      <div class="gate-sub">Loading the dashboard.</div>
      <div class="gate-spinner" aria-hidden="true"></div>
      <div class="gate-note">This will update automatically.</div>
      <div id="gate-error" class="gate-error" style="display: none;"></div>
      <div>
        <button id="gate-retry" class="gate-btn" style="display: none;">Retry</button>
        <button id="gate-skip" class="gate-btn" style="display: none;">Skip to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- ====== APP ====== -->
  <div id="app" style="display:none">
    <header class="header">
      <div class="header-content brand">
        <div class="brand-left">
          <div class="brand-mark" aria-hidden="true">
            <svg viewBox="0 0 64 64" width="38" height="38" role="img">
              <defs>
                <linearGradient id="dpGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="var(--accent-blue)" />
                  <stop offset="100%" stop-color="var(--accent-green)" />
                </linearGradient>
              </defs>
              <path fill="url(#dpGrad)" d="M32 6c6 10 16 18 16 30 0 9.94-8.06 18-18 18s-18-8.06-18-18C12 24 26 16 32 6z"/>
            </svg>
          </div>
          <div class="brand-copy">
            <h1 class="brand-title"><span class="thin">Daily</span> Dew&nbsp;Point</h1>
            <p class="brand-sub">Automatically logs every NWS forecast update for Central Park and compares to the official daily high</p>
          </div>
        </div>
        <div class="brand-right">
          <div class="pill-group">
            <span class="pill live"><span class="dot"></span> Live</span>
            <span class="pill">NYC</span>
            <span class="pill">KNYC</span>
          </div>
          <button id="btn-billing" class="pill">Manage billing</button>
          <button id="btn-logout" class="pill logout-btn">Log out</button>
        </div>
      </div>
    </header>

    <div class="container">
      <span id="todayDate"></span>
      
      <div class="metric-card">
        <div class="metric-label">Dashboard Status</div>
        <div class="metric-value">Active</div>
        <div class="metric-subtitle">Dashboard loaded successfully</div>
      </div>
    </div>

    <footer class="footer">
      ¬© 2025 Dewdrop Ventures, LLC ¬∑
      <a href="/terms.html">Terms</a> ¬∑
      <a href="/privacy.html">Privacy</a> ¬∑
      <span>Informational only ‚Äî not financial advice. Do your own due diligence before placing any bets or making financial decisions.</span>
    </footer>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    console.log('Script starting...');
    
    // Global functions - define these FIRST
    function showApp() {
      console.log('showApp() called');
      const gate = document.getElementById('gate');
      const app = document.getElementById('app');
      
      if (gate) {
        gate.style.display = 'none';
        console.log('Gate hidden');
      }
      if (app) {
        app.style.display = 'block';
        console.log('App shown');
      }
      document.body.classList.add('app-ready');
    }

    function showError(message, showButtons = true) {
      console.error('Gate error:', message);
      const errorEl = document.getElementById('gate-error');
      const retryBtn = document.getElementById('gate-retry');
      const skipBtn = document.getElementById('gate-skip');
      const spinner = document.querySelector('.gate-spinner');
      
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
      if (spinner) {
        spinner.style.display = 'none';
      }
      if (showButtons) {
        if (retryBtn) retryBtn.style.display = 'inline-block';
        if (skipBtn) skipBtn.style.display = 'inline-block';
      }
    }

    function updateGateMessage(message) {
      console.log('Gate message:', message);
      const sub = document.querySelector('.gate-sub');
      if (sub) sub.textContent = message;
    }

    function initializeBasicApp() {
      console.log('Initializing basic app...');
      const todayDate = document.getElementById('todayDate');
      if (todayDate) {
        todayDate.textContent = new Intl.DateTimeFormat('en-US', {
          weekday: 'short',
          month: 'short', 
          day: 'numeric',
          year: 'numeric'
        }).format(new Date());
      }
    }

    // Timeout wrapper
    function withTimeout(promise, ms, label = "operation") {
      return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
          reject(new Error(`${label} timed out after ${ms}ms`));
        }, ms);
        
        promise.then(
          value => {
            clearTimeout(timer);
            resolve(value);
          },
          error => {
            clearTimeout(timer);
            reject(error);
          }
        );
      });
    }

    // Main access check function
    async function checkAccess() {
      console.log('checkAccess() starting');
      
      try {
        updateGateMessage('Initializing Supabase...');
        
        // Check if Supabase is available
        if (typeof window.supabase === 'undefined') {
          throw new Error('Supabase library not loaded');
        }

        const supabase = window.supabase.createClient(
          "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw"
        );

        updateGateMessage('Checking session...');
        
        // Get session with timeout
        const { data: { session }, error: sessionError } = await withTimeout(
          supabase.auth.getSession(),
          8000,
          'getSession'
        );

        if (sessionError) {
          console.error('Session error:', sessionError);
          throw new Error(`Session error: ${sessionError.message}`);
        }

        if (!session) {
          console.log('No session found, redirecting to login');
          updateGateMessage('No session found. Redirecting to login...');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          return;
        }

        console.log('Session found:', session.user.id);
        updateGateMessage('Checking subscription...');

        // Check subscription with timeout
        const { data: profile, error: profileError } = await withTimeout(
          supabase
            .from('profiles')
            .select('subscription_status, current_period_end, trial_used')
            .eq('id', session.user.id)
            .single(),
          8000,
          'profile check'
        );

        if (profileError) {
          console.error('Profile error:', profileError);
          // Don't fail hard on profile errors - might be network issue
          updateGateMessage('Profile check failed, proceeding anyway...');
          setTimeout(() => {
            showApp();
            initializeBasicApp();
          }, 1000);
          return;
        }

        const status = profile?.subscription_status || 'inactive';
        console.log('Subscription status:', status);

        if (!['active', 'trialing'].includes(status)) {
          const redirectUrl = profile?.trial_used 
            ? 'subscribe.html?reason=trial_expired' 
            : 'subscribe.html';
          
          updateGateMessage('Subscription inactive. Redirecting...');
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 2000);
          return;
        }

        // Success!
        console.log('Access granted');
        updateGateMessage('Access granted! Loading dashboard...');
        setTimeout(() => {
          showApp();
          initializeBasicApp();
          setupEventListeners(supabase);
        }, 500);

      } catch (error) {
        console.error('Access check failed:', error);
        showError(`Access check failed: ${error.message}`, true);
      }
    }

    function setupEventListeners(supabase) {
      console.log('Setting up event listeners...');
      
      // Setup auth state listener
      supabase.auth.onAuthStateChange((event, session) => {
        console.log('Auth state changed:', event);
        if (event === 'SIGNED_OUT' || !session) {
          window.location.href = 'login.html';
        }
      });

      // Setup logout button
      const logoutBtn = document.getElementById('btn-logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          console.log('Logout clicked');
          try {
            await supabase.auth.signOut();
            localStorage.removeItem('dashboard_heartbeat');
            window.location.href = 'login.html';
          } catch (error) {
            console.error('Logout error:', error);
            window.location.href = 'login.html';
          }
        });
      }

      // Setup billing button  
      const billingBtn = document.getElementById('btn-billing');
      if (billingBtn) {
        billingBtn.addEventListener('click', async () => {
          console.log('Billing clicked');
          try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
              window.location.href = 'login.html';
              return;
            }

            const response = await fetch('/api/create-portal-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                supabaseAccessToken: session.access_token
              })
            });

            const data = await response.json();
            if (response.ok && data.url) {
              window.location.href = data.url;
            } else {
              alert(data.error || 'Could not open billing portal');
            }
          } catch (error) {
            console.error('Billing error:', error);
            alert('Could not open billing portal');
          }
        });
      }
    }

    // Button event listeners (set up immediately)
    document.addEventListener('DOMContentLoaded', () => {
      const retryBtn = document.getElementById('gate-retry');
      const skipBtn = document.getElementById('gate-skip');
      
      if (retryBtn) {
        retryBtn.addEventListener('click', () => {
          console.log('Retry clicked');
          location.reload();
        });
      }
      
      if (skipBtn) {
        skipBtn.addEventListener('click', () => {
          console.log('Skip clicked');
          showApp();
          initializeBasicApp();
        });
      }
    });

    // Fail-safe mechanisms
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      const app = document.getElementById('app');
      if (app && app.style.display === 'none') {
        showError('An error occurred. Try refreshing the page.');
      }
    });

    window.addEventListener('unhandledrejection', (event) => {
      console.error('Unhandled promise rejection:', event.reason);
      const app = document.getElementById('app');
      if (app && app.style.display === 'none') {
        showError('A network error occurred. Check your connection.');
      }
    });

    // Ultimate fail-safe: show app after 15 seconds no matter what
    setTimeout(() => {
      const app = document.getElementById('app');
      if (app && app.style.display === 'none') {
        console.warn('Fail-safe: showing app after timeout');
        showError('Taking longer than expected. You can skip to the dashboard.', true);
      }
    }, 15000);

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAccess);
    } else {
      checkAccess();
    }

    console.log('Script loaded successfully');
  </script>
</body>
</html>
