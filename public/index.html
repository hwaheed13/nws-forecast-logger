<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>üå°Ô∏è Daily Dew Point Dashboard</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://static.memberstack.com" crossorigin>
  <link rel="dns-prefetch" href="https://static.memberstack.com">
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">

  <!-- Memberstack v1 (async) -->
  <script
    async
    src="https://static.memberstack.com/scripts/v1/memberstack.js"
    data-memberstack-app="app_cmervlzlv00070wtm9ptvetm4"
    data-memberstack-use-cookies="true">
  </script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-primary:#fafbfc; --bg-secondary:#ffffff; --bg-tertiary:#f8f9fa; --bg-accent:#f1f5f9;
      --text-primary:#0f172a; --text-secondary:#334155; --text-muted:#64748b; --text-light:#94a3b8;
      --border-subtle:#e2e8f0; --border-default:#cbd5e1;
      --accent-blue:#2563eb; --accent-blue-light:#dbeafe;
      --accent-green:#059669; --accent-green-light:#d1fae5;
      --accent-amber:#d97706; --accent-amber-light:#fef3c7;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}

    /* Gate (shows immediately) */
    #gate{
      display:flex; align-items:center; justify-content:center;
      min-height:100vh; background:var(--bg-primary); color:var(--text-primary);
      font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;
      padding:24px; text-align:center;
    }
    .gate-card{
      background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px;
      padding:24px 22px; box-shadow:var(--shadow-sm); max-width:520px; width:100%;
    }
    .gate-title{font-size:18px; font-weight:800; margin:0 0 6px}
    .gate-sub{font-size:14px; color:var(--text-muted); margin:0 0 12px}
    .gate-note{font-size:12px; color:var(--text-light)}
    .gate-spinner{width:28px;height:28px;border-radius:50%;border:3px solid var(--border-subtle); border-top-color:var(--accent-blue); margin:12px auto 8px; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* App */
    body{
      font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;
      background:var(--bg-primary); color:var(--text-primary); margin:0; line-height:1.6;
      font-feature-settings:"tnum" 1,"lnum" 1;
    }
    .header{background:var(--bg-secondary); border-bottom:1px solid var(--border-subtle); padding:20px 0; position:sticky; top:0; z-index:10; backdrop-filter:blur(8px)}
    .header-content{max-width:1400px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between}

    .brand{display:flex; align-items:center; justify-content:space-between; gap:14px}
    .brand-left{display:flex; align-items:center; gap:12px}
    .brand-mark{display:grid; place-items:center; width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg,var(--accent-blue-light),var(--accent-green-light)); box-shadow:var(--shadow-sm); border:1px solid var(--border-subtle); position:relative; top:-3px}
    .brand-mark svg{display:block; transform:translate(1px,1px)}
    .brand-title{margin:0; font-weight:800; letter-spacing:.2px; font-size:28px; line-height:1.15; color:var(--text-primary)}
    .brand-title .thin{font-weight:600; color:var(--text-secondary)}
    .brand-sub{margin:2px 0 0; font-size:13px; color:var(--text-muted)}
    .brand-right{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; font-size:12px; font-weight:700; color:var(--text-secondary); background:var(--bg-accent); border:1px solid var(--border-subtle); border-radius:999px}
    .pill.live{background:var(--accent-green-light); color:var(--accent-green); border-color:transparent}
    .pill.live .dot{width:6px; height:6px; border-radius:50%; background:var(--accent-green); animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    .container{max-width:1400px;margin:0 auto;padding:24px}
    .last-update{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:12px; padding:18px 20px; margin-bottom:20px; box-shadow:var(--shadow-sm)}
    .last-update-label{font-size:12px; color:var(--text-muted); letter-spacing:.06em; text-transform:uppercase; margin-bottom:4px; font-weight:600}
    .last-update-content{font-size:15px; color:var(--text-secondary); font-weight:600}

    .metrics-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:18px; margin-bottom:22px}
    .metric-card{background:var(--bg-secondary); border:1.5px solid var(--border-subtle); border-radius:18px; padding:24px; box-shadow:var(--shadow-sm); position:relative; overflow:hidden}
    .metric-card::before{content:''; position:absolute; inset:0 0 auto; height:4px; background:linear-gradient(90deg,var(--accent-blue),var(--accent-green))}
    .metric-card.today-forecast::before{background:var(--accent-amber)}
    .metric-card.today-obs::before{background:var(--accent-blue)}
    .metric-card.today-actual::before{background:var(--accent-green)}
    .metric-card.tomorrow-forecast::before{background:var(--accent-blue)}

    .metric-label{font-size:14px; color:var(--text-muted); margin-bottom:6px; font-weight:700; letter-spacing:.02em}
    .metric-value{font-size:36px; font-weight:800; color:var(--text-primary); margin-bottom:10px; line-height:1}
    .metric-subtitle{font-size:13px; color:var(--text-light)}
    .mini-forecasts{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
    .mini-chip{background:var(--bg-accent); color:var(--text-secondary); padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--border-subtle)}

    .kalshi-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:18px; margin-bottom:22px}
    .kalshi-card{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:22px}
    .kalshi-badge{background:var(--accent-amber-light); color:var(--accent-amber); padding:8px 14px; border-radius:999px; font-size:14px; font-weight:800; text-decoration:none; display:inline-block}
    .kalshi-pending{background:var(--bg-accent); color:var(--text-muted); padding:8px 14px; border-radius:999px; font-size:14px; font-weight:700; border:2px dashed var(--border-default)}
    .kalshi-note{font-size:12px; color:var(--text-light); margin-top:6px}

    .prediction-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(360px,1fr)); gap:18px; margin-bottom:22px}
    .prediction-card{background:linear-gradient(135deg,var(--accent-blue-light),var(--accent-green-light)); border:1px solid var(--border-subtle); border-radius:16px; padding:24px}
    .prediction-title{font-size:15px; font-weight:800; margin-bottom:12px}
    .prediction-value{font-size:28px; font-weight:800; color:#1f2937}
    .prediction-subtitle{font-size:13px; color:var(--text-secondary)}

    .controls-section{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:18px; margin-bottom:22px}
    .controls-title{font-size:15px; font-weight:800; margin-bottom:10px}
    .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .control-group{display:flex; align-items:center; gap:6px}
    .control-label{font-size:13px; font-weight:700; color:var(--text-secondary)}
    input[type="date"]{padding:8px 10px; border:1px solid var(--border-default); border-radius:10px; font-size:14px; background:var(--bg-secondary)}
    input[type="date"]:focus{outline:none; border-color:var(--accent-blue); box-shadow:0 0 0 3px var(--accent-blue-light)}
    .btn{background:var(--accent-blue); color:#fff; border:none; border-radius:10px; padding:9px 16px; font-size:14px; font-weight:800; cursor:pointer; box-shadow:var(--shadow-sm)}
    .btn.secondary{background:var(--bg-tertiary); color:var(--text-secondary); border:1px solid var(--border-default)}

    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; margin-bottom:22px}
    .stat-card{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:14px; padding:18px; text-align:center}
    .stat-label{font-size:13px; color:var(--text-muted); font-weight:700}
    .stat-value{font-size:28px; font-weight:800; color:var(--accent-blue)}

    .chart-section{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:24px; margin-bottom:22px}
    .chart-title{font-size:16px; font-weight:800; margin-bottom:14px}
    .chart-container{position:relative; height:clamp(220px,38vh,380px); width:100%}

    .table-section{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:0; overflow:hidden}
    .table-container{overflow-x:auto; border-top:1px solid var(--border-subtle); padding:0 18px 18px}
    #dataTable{width:100%; border-collapse:collapse; font-size:14px; background:var(--bg-secondary)}
    #dataTable th{background:var(--bg-tertiary); color:var(--text-primary); padding:12px 10px; text-align:left; font-weight:800; font-size:12px; letter-spacing:.06em; text-transform:uppercase; border-bottom:2px solid var(--border-default); position:sticky; top:0; z-index:1}
    #dataTable td{padding:12px 10px; border-bottom:1px solid var(--border-subtle); color:var(--text-secondary)}
    #dataTable tbody tr:hover{background:var(--bg-accent)}
    .forecast-row{background:var(--accent-blue-light) !important}
    .actual-row{background:var(--accent-green-light) !important}
    .best{box-shadow:inset 0 0 0 2px var(--accent-green)}

    details.table-wrap{border-top:1px solid var(--border-subtle)}
    details.table-wrap summary{ background:var(--bg-accent); border-bottom:1px solid var(--border-subtle); list-style:none; cursor:pointer; padding:16px 18px; font-weight:800; display:flex; align-items:center; justify-content:space-between }
    details.table-wrap summary::-webkit-details-marker{display:none}
    .caret{transition:transform .2s ease}
    details[open] .caret{transform:rotate(90deg)}

    .skel td::before{content:""; display:block; height:12px; margin:4px 0; width:70%; background:linear-gradient(90deg,var(--bg-accent),var(--bg-tertiary),var(--bg-accent)); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:4px}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}

    .footer{margin-top:28px; padding:18px 24px; background:var(--bg-tertiary); border-top:1px solid var(--border-subtle); text-align:center; font-size:12px; color:var(--text-light)}
    .footer a{color:var(--accent-blue); text-decoration:none}

    /* Fluid sizes + mobile */
    .brand-title{font-size:clamp(18px,2.2vw,28px)}
    .metric-value{font-size:clamp(22px,3vw,36px)}
    .prediction-value{font-size:clamp(20px,2.6vw,28px)}
    .stat-value{font-size:clamp(18px,2.4vw,28px)}
    .kalshi-badge{font-size:clamp(11px,1.8vw,14px); padding:6px 10px}
    .pill{font-size:clamp(10px,1.6vw,12px); padding:4px 8px}

    @media (max-width:600px){
      .container{padding:12px}
      .header{padding:12px 0}
      .brand{gap:8px}
      .brand-left{gap:8px}
      .brand-mark{width:32px; height:32px; border-radius:10px; top:-2px}
      .brand-mark svg{width:28px; height:28px; transform:translate(0,0)}
      .brand-sub{font-size:12px; line-height:1.35}
      .metrics-grid,.prediction-grid,.kalshi-grid{grid-template-columns:1fr; gap:10px}
      .metric-card{padding:14px; border-radius:14px}
      .metric-label{font-size:13px}
      .metric-subtitle{font-size:12px}
      .prediction-card{padding:14px}
      .stats-grid{grid-template-columns:repeat(2,1fr); gap:8px}
      .stat-card{padding:10px}
      .stat-label{font-size:11px}
      .stat-value{font-size:22px}
      .mini-forecasts{gap:4px}
      .mini-chip{font-size:11px; padding:3px 8px}
      .controls-section{padding:12px}
      .controls{gap:8px}
      .control-label{font-size:12px}
      input[type="date"]{font-size:13px; padding:7px 8px; border-radius:8px}
      .btn{font-size:13px; padding:8px 12px; border-radius:8px}
      .chart-section{padding:14px}
      .chart-title{font-size:14px; margin-bottom:10px}
      .chart-container{height:260px}
      .table-container{padding:0 12px 12px}
      #dataTable{font-size:12px}
      #dataTable th{font-size:11px; padding:10px 8px}
      #dataTable td{padding:10px 8px}
      .brand-right{gap:6px}
      .pill .dot{width:5px; height:5px}
    }
  </style>
</head>
<body>

  <!-- ====== LOGIN GATE (visible immediately) ====== -->
  <div id="gate" role="status" aria-live="polite">
    <div class="gate-card">
      <div class="gate-title">Checking membership‚Ä¶</div>
      <div class="gate-sub">Hang tight while we verify your access.</div>
      <div class="gate-spinner" aria-hidden="true"></div>
      <div class="gate-note">If you‚Äôre not logged in, a sign-in dialog will appear.</div>
    </div>
  </div>

  <!-- ====== APP (hidden until login confirmed) ====== -->
  <div id="app" style="display:none">
    <header class="header">
      <div class="header-content brand">
        <div class="brand-left">
          <div class="brand-mark" aria-hidden="true">
            <svg viewBox="0 0 64 64" width="38" height="38" role="img">
              <defs>
                <linearGradient id="dpGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%"  stop-color="var(--accent-blue)" />
                  <stop offset="100%" stop-color="var(--accent-green)" />
                </linearGradient>
              </defs>
              <path fill="url(#dpGrad)" d="M32 6c6 10 16 18 16 30 0 9.94-8.06 18-18 18s-18-8.06-18-18C12 24 26 16 32 6z"/>
            </svg>
          </div>
          <div class="brand-copy">
            <h1 class="brand-title"><span class="thin">Daily</span> Dew&nbsp;Point</h1>
            <p class="brand-sub">Automatically logs every NWS forecast update for Central Park and compares to the official daily high</p>
          </div>
        </div>
        <div class="brand-right">
          <span class="pill live"><span class="dot"></span> Live</span>
          <span class="pill">NYC</span>
          <span class="pill">KNYC</span>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="last-update">
        <div class="last-update-label">Latest Forecast Update</div>
        <div id="recentForecast" class="last-update-content">Loading latest forecast data...</div>
      </div>

      <!-- Metrics -->
      <div class="metrics-grid">
        <div class="metric-card today-forecast">
          <div class="metric-label">Today's Latest Forecast</div>
          <div id="box-today-forecast" class="metric-value">‚Äì</div>
          <div class="metric-subtitle">Today's Forecasts</div>
          <div id="mini-today-forecasts" class="mini-forecasts"></div>
        </div>

      <div class="metric-card today-actual">
      <div class="metric-label">Today's DSM (Max so far)</div>
      <div id="box-dsm-max" class="metric-value">‚Äì</div>
      <div id="box-dsm-note" class="metric-subtitle"></div>
    
        <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
        <div class="metric-label" style="margin-bottom:6px;">Today's Actual High (CLI)</div>
        <div id="box-today-actual" class="metric-value">‚Äì</div>
        <div id="box-today-actual-note" class="metric-subtitle">NWS daily cli report</div>
        </div>
        </div>

        <div class="metric-card today-obs">
          <div class="metric-label">Today's High So Far</div>
          <div id="box-today-obs" class="metric-value">‚Äì</div>
          <div id="box-today-obs-note" class="metric-subtitle"></div>

          <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
            <div class="metric-subtitle">Current Temperature</div>
            <div id="box-today-current" class="metric-value">‚Äì</div>
            <div id="box-today-current-note" class="metric-subtitle"></div>
          </div>
        </div>

        <div class="metric-card tomorrow-forecast">
          <div class="metric-label">Tomorrow's Latest Forecast</div>
          <div id="box-tomorrow-forecast" class="metric-value">‚Äì</div>
          <div class="metric-subtitle">Tomorrow's Forecasts</div>
          <div id="mini-tomorrow-forecasts" class="mini-forecasts"></div>
        </div>
      </div> <!-- /metrics-grid -->

      <!-- Bias-corrected -->
      <div class="prediction-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:18px; margin-bottom:22px;">
        <div class="prediction-card">
          <div class="prediction-title">Today's Bias-Corrected Prediction</div>
          <div id="correctionBoxToday" class="prediction-content">Loading...</div>
        </div>
        <div class="prediction-card">
          <div class="prediction-title">Tomorrow's Bias-Corrected Prediction</div>
          <div id="correctionBoxTomorrow" class="prediction-content">Loading...</div>
        </div>
        <div style="grid-column:1/2 span; font-size:12px; color:var(--text-light); margin-top:-4px;">
          Note: ‚Äúdays‚Äù refers only to dates with an actual high and at least one valid forecast logged before that high.
        </div>
      </div>

      <!-- Kalshi -->
      <div class="kalshi-grid">
        <div class="kalshi-card">
          <div class="metric-label">Today's Kalshi Market</div>
          <div id="box-today-kalshi" class="metric-value" style="font-size:18px;">Pending settlement</div>
          <div id="box-today-kalshi-note" class="kalshi-note"></div>
        </div>
        <div class="kalshi-card">
          <div class="metric-label">Yesterday's Kalshi Result</div>
          <div id="box-yday-kalshi" class="metric-value" style="font-size:18px;">‚Äì</div>
          <div id="box-yday-kalshi-note" class="kalshi-note"></div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls-section">
        <div class="controls-title">Filter Data</div>
        <div class="controls">
          <div class="control-group">
            <label class="control-label" for="fromDate">From:</label>
            <input type="date" id="fromDate"/>
          </div>
          <div class="control-group">
            <label class="control-label" for="toDate">To:</label>
            <input type="date" id="toDate"/>
          </div>
          <button class="btn" onclick="applyDateFilter()">Apply Filter</button>
          <button class="btn secondary" onclick="resetFilter()">Show All</button>
          <button class="btn secondary" onclick="reloadCSV()">Refresh Data</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="stats">
        <div class="stat-card"><div class="stat-label">Days Tracked</div><div class="stat-value">0</div></div>
        <div class="stat-card"><div class="stat-label">Days With Actual</div><div class="stat-value">0</div></div>
        <div class="stat-card"><div class="stat-label">Average Absolute Error</div><div class="stat-value">--¬∞F</div></div>
        <div class="stat-card"><div class="stat-label">Average Best Error</div><div class="stat-value">--¬∞F</div></div>
      </div>

      <!-- Chart -->
      <div class="chart-section">
        <div class="chart-title">Temperature Trends: Actual vs Predicted</div>
        <div class="chart-container"><canvas id="dailyChart" width="1000" height="380"></canvas></div>
      </div>

      <!-- Collapsible Table -->
      <div class="table-section">
        <details class="table-wrap">
          <summary>
            <span>Detailed Forecast Log</span>
            <span class="caret">‚ñ∏</span>
          </summary>
          <div class="table-container">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>Date Pulled</th>
                  <th>Forecast Time</th>
                  <th>For Date</th>
                  <th>Forecasted High</th>
                  <th>Actual High</th>
                  <th>High Time</th>
                  <th>Error (¬∞F)</th>
                  <th>Best?</th>
                  <th>Kalshi Range</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>

    <footer class="footer">
      ¬© 2025 Dewdrop Ventures, LLC ¬∑
      <a href="/terms.html">Terms</a> ¬∑
      <a href="/privacy.html">Privacy</a> ¬∑
      <span>Informational only ‚Äî not financial advice. Do your own due diligence before placing any bets or making financial decisions.</span>
    </footer>
  </div> <!-- /#app -->

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- App scripts (deferred) -->
  <script>
    /* ========= AUTH GATE LOGIC ========= */
    const $gate = ()=>document.getElementById('gate');
    const $app  = ()=>document.getElementById('app');

    function showApp(){
      const g=$gate(), a=$app();
      if(g) g.style.display='none';
      if(a) a.style.display='';
    }

    function showGate(msg){
      const g=$gate();
      if(!g) return;
      g.style.display='';
      const card = g.querySelector('.gate-card');
      if(card && msg){
        const sub = card.querySelector('.gate-sub');
        if(sub) sub.textContent = msg;
      }
    }

    async function waitForMS(tries=120, delay=500){
      return new Promise(resolve=>{
        (function loop(n){
          const ms = window.$memberstackDom;
          if(ms && typeof ms.getCurrentMember==="function") return resolve(ms);
          if(n<=0) return resolve(null);
          setTimeout(()=>loop(n-1), delay);
        })(tries);
      });
    }

    async function requireAuthAndBoot(){
      const ms = await waitForMS();
      if(!ms){ showGate("Couldn‚Äôt reach Memberstack. You can try refreshing."); return; }

      try{
        // Check current member
        const { data: member } = await ms.getCurrentMember();

        if(member){
          // Auth ok ‚Üí show app & boot data
          showApp();
          bootApp();
          return;
        }

        // Not logged in ‚Üí open modal and poll until they complete
        await ms.openModal('SIGNUP');

        let authed = false;
        for(let i=0;i<240;i++){ // up to ~2 minutes
          try{
            const { data:m2 } = await ms.getCurrentMember();
       if (m2 && m2.planConnections?.some(pc => pc.status === "active")) {
  authed = true;
  break;
}

          }catch{}
          await new Promise(r=>setTimeout(r, 500));
        }

   if (authed){
  try { await ms.hideModal?.(); } catch(e) {}
  showApp();
  bootApp();
}

        }else{
          showGate("Still waiting for login‚Ä¶ You can close and try again.");
        }

      }catch(e){
        showGate("Membership check had a network issue. Please refresh.");
      }
    }

    /* ========= DATA + UI ========= */
    let allRows=[], filteredRows=[], chartInstance=null;

    function nycISODate(offsetDays=0){
      const fmt=new Intl.DateTimeFormat('en-CA',{timeZone:'America/New_York',year:'numeric',month:'2-digit',day:'2-digit'});
      const parts=fmt.formatToParts(new Date(Date.now()+offsetDays*86400000));
      const g=k=>parts.find(p=>p.type===k).value;
      return `${g('year')}-${g('month')}-${g('day')}`;
    }

    function kalshiAnchorForISO(dateISO){
      const [y,m,d]=dateISO.split('-').map(Number);
      const dt=new Date(Date.UTC(y,m-1,d));
      const mon=['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'][dt.getUTCMonth()];
      const dd=String(dt.getUTCDate()).replace(/^0/,''); const yy=String(dt.getUTCFullYear()).slice(-2);
      return `#kxhighny-${yy}${mon}${dd}`;
    }

    function showSkeleton(rows=6){
      const tb=document.querySelector("#dataTable tbody"); if(!tb) return;
      tb.innerHTML="";
      for(let i=0;i<rows;i++){
        const tr=document.createElement("tr"); tr.className="skel"; tr.innerHTML="<td></td>".repeat(9); tb.appendChild(tr);
      }
    }
    function reloadCSV(){
      showSkeleton();
      fetch("https://raw.githubusercontent.com/hwaheed13/nws-forecast-logger/main/nws_forecast_log.csv?"+Date.now())
        .then(r=>r.text()).then(parseCSV).then(()=>{
          resetFilter(); showMostRecent(); updateSummaryBoxes(); updateCorrectionBoxes(); updateObservations();
        })
        .catch(err=>alert("Could not load CSV. "+err));
    }
    function csvToRows(text){
      const rows=[]; let row=[], field='', q=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(c==='"'){ if(q && n==='"'){ field+='"'; i++; } else q=!q; }
        else if(c===',' && !q){ row.push(field); field=''; }
        else if((c==='\n'||c==='\r') && !q){ if(c==='\r'&&n==='\n') i++; row.push(field); field=''; if(row.length&&row.some(x=>x!=='')) rows.push(row); row=[]; }
        else field+=c;
      }
      if(field!==''||row.length){ row.push(field); if(row.length&&row.some(x=>x!=='')) rows.push(row); }
      return rows;
    }
    function parseCSV(text){
      const rows=csvToRows(text); if(!rows.length) return;
      const header=rows[0].map(h=>h.trim()); allRows=[];
      for(let i=1;i<rows.length;i++){
        const vals=rows[i]; const rec={};
        for(let j=0;j<header.length;j++){
          let v=(vals[j]??'').trim();
          if(v.startsWith('"')&&v.endsWith('"')) v=v.slice(1,-1).replace(/""/g,'"');
          rec[header[j]]=v;
        }
        allRows.push(rec);
      }
    }

    function rNum(x){ const n=Number(x); return Number.isFinite(n)?n:null; }
    function toDateObj(t){
      if(!t) return null;
      const clean=String(t).trim().replace(/:(\d{2})(?=\s*[AP]M)/i,'');
      if(/[AP]M/i.test(clean)){
        const m=clean.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i); if(!m) return null;
        const [,h,mn,amp]=m; const hour=(Number(h)%12)+(amp.toUpperCase()==="PM"?12:0);
        return new Date(2020,1,1,hour,Number(mn));
      }
      if(/^\d{2}:\d{2}$/.test(clean)){ const [h,mn]=clean.split(":"); return new Date(2020,1,1,Number(h),Number(mn)); }
      return null;
    }
    function compareTimes(t1,t2){ const d1=toDateObj(t1), d2=toDateObj(t2); return (d1&&d2)?d1-d2:0; }

    function showMostRecent(){
      const el=document.getElementById("recentForecast");
      if(!allRows.length){ el.textContent=""; return; }
      for(let i=allRows.length-1;i>=0;i--){
        const r=allRows[i];
        if(r && r.forecast_or_actual==="forecast" && r.predicted_high && r.target_date){
          const iso=r.timestamp;
          const when=iso ? new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",hour:"numeric",minute:"2-digit",month:"short",day:"numeric"}).format(new Date(iso)) : (r.forecast_time||"(time unknown)");
          el.innerHTML=`<strong>${when} ET</strong> ‚Äî <strong>${r.predicted_high}¬∞F</strong> for <strong>${r.target_date}</strong>`;
          return;
        }
      }
      el.textContent="";
    }

    function getForecastsForDate(dateISO){
      const rows=allRows
        .filter(r=>r.forecast_or_actual==="forecast" && r.target_date===dateISO && r.predicted_high)
        .map(r=>({tstamp:r.timestamp||r.forecast_time||"", timeHHMM:(r.forecast_time||"").substr(11,5), val:Number(r.predicted_high)}))
        .filter(x=>Number.isFinite(x.val));
      rows.sort((a,b)=>(a.tstamp||"").localeCompare(b.tstamp||""));
      return rows;
    }
    function renderMiniForecastChips(rows, elId){
      const host=document.getElementById(elId); if(!host) return; host.innerHTML="";
      const compact=[]; rows.forEach((r,i)=>{ if(i===0||r.val!==rows[i-1].val) compact.push(r); });
      if(!compact.length){ host.innerHTML=`<span class="mini-chip">No forecasts yet</span>`; return; }
      compact.forEach(r=>{
        const label=`${r.timeHHMM||"‚Äî"} ${r.val.toFixed(0)}¬∞`;
        const chip=document.createElement("span"); chip.className="mini-chip"; chip.textContent=label; host.appendChild(chip);
      });
    }

    const KALSHI_PROXY_BASE="https://kalshi-proxy-theta.vercel.app/api/kalshi";
    const KALSHI_LIVE_BASE ="https://kalshi-proxy-theta.vercel.app/api/kalshi-live";
    const KALSHI_BASE_URL  ="https://kalshi.com/markets/kxhighny/highest-temperature-in-nyc";
    const NWS_OBS_BASE="https://kalshi-proxy-theta.vercel.app/api/nws-high-so-far";
    const NWS_CURRENT_BASE="https://kalshi-proxy-theta.vercel.app/api/nws-current-temp";
    const NWS_DSM_URL   = "https://forecast.weather.gov/product.php?site=NWS&issuedby=NYC&product=DSM&format=CI&version=1&glossary=0";
    const NWS_DSM_PROXY = "https://kalshi-proxy-theta.vercel.app/api/nws-dsm?issuedby=NYC";

    async function fetchTextWithFallback(urls){
  for (const u of urls){
    try{
      const r = await fetch(u, {mode:"cors", cache:"no-cache"});
      if (r.ok) return await r.text();
    }catch(_) {}
  }
  return null;
}

/* Parse DSM ‚ÄúDaily Summary Message‚Äù like:
   KNYC DS 1600 26/08 791504/ 630618// 79/ 63//9930105/...
   We extract date (DD/MM) and first 6-digit block after it:
     791504 -> temp=79, time=15:04 ET
*/
function parseDSM(text){
  if(!text) return null;

  // Grab the first DSM block (strip tags if present)
  const t = text.replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();

  // Find date token (DD/MM or D/MM etc.)
  const dateMatch = t.match(/\b(\d{1,2})\/(\d{2})\b/);
  if(!dateMatch) return null;

  // Find first 6-digit block after the date (max temp + time)
  const after = t.slice(t.indexOf(dateMatch[0]) + dateMatch[0].length);
  const hiBlock = after.match(/\b(\d{6})\b/);
  if(!hiBlock) return null;

  const block = hiBlock[1];
  const tempF = Number(block.slice(0,2));
  const hh    = block.slice(2,4);
  const mm    = block.slice(4,6);

  if(!Number.isFinite(tempF)) return null;

  // Build a pretty time in ET using today's date (year inferred)
  const now = new Date();
  const year = now.getFullYear();
  const dd = String(dateMatch[1]).padStart(2,"0");
  const mmMon = String(dateMatch[2]).padStart(2,"0");

  // Create a Date in ET for display
  const isoLocal = `${year}-${mmMon}-${dd}T${hh}:${mm}:00`;
  const when = new Date(isoLocal);
  const fmtET = new Intl.DateTimeFormat("en-US", {
    timeZone: "America/New_York",
    hour: "numeric", minute: "2-digit"
  }).format(when);

  return {
    tempF,
    timeET: fmtET,
    iso: isoLocal,
    raw: block
  };
}

async function updateDSM(){
  const el = document.getElementById("box-dsm-max");
  const note = document.getElementById("box-dsm-note");
  if(!el || !note) return;

  el.textContent = "‚Äì";
  note.textContent = "";

  // Try proxy first (if you add it), then public page
  const txt = await fetchTextWithFallback([NWS_DSM_PROXY, NWS_DSM_URL]);

  const parsed = parseDSM(txt);
  if(parsed){
    el.textContent = `${parsed.tempF.toFixed(0)}¬∞F`;
    note.textContent = `as of ${parsed.timeET} ET ‚Ä¢ DSM product (NYC)`;
  }else{
    // Quiet failure: keep DSM blank; nothing else breaks.
    el.textContent = "‚Äì";
    note.textContent = "DSM unavailable";
  }
}


    async function fetchKalshiWinningRange(dateISO){
      try{
        let r=await fetch(`${KALSHI_PROXY_BASE}?date=${encodeURIComponent(dateISO)}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"});
        if(r.status===204) return null;
        if(r.status===304){ r=await fetch(`${KALSHI_PROXY_BASE}?date=${encodeURIComponent(dateISO)}&cb=${Date.now()}`,{mode:"cors",headers:{Accept:"application/json"}}); }
        if(!r.ok) return null; return await r.json();
      }catch{return null;}
    }
    async function fetchKalshiLiveLeader(dateISO){
      try{
        const r=await fetch(`${KALSHI_LIVE_BASE}?date=${encodeURIComponent(dateISO)}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"});
        if(!r.ok) return null; return await r.json();
      }catch{return null;}
    }
    const kalshiCache=new Map();
    async function getKalshiLabel(dateISO){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) return null;
      if(kalshiCache.has(dateISO)){
        const cached=kalshiCache.get(dateISO);
        if(cached===null){ const fresh=await fetchKalshiWinningRange(dateISO); kalshiCache.set(dateISO,fresh); return fresh; }
        return cached;
      }
      const data=await fetchKalshiWinningRange(dateISO); kalshiCache.set(dateISO,data); return data;
    }

    async function fetchNwsHighSoFar(station="KNYC"){ try{ const r=await fetch(`${NWS_OBS_BASE}?station=${encodeURIComponent(station)}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"}); if(!r.ok) return null; return await r.json(); }catch{return null;} }
    async function fetchNwsCurrentTemp(station="KNYC"){ try{ const r=await fetch(`${NWS_CURRENT_BASE}?station=${encodeURIComponent(station)}&cb=${Date.now()}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"}); if(!r.ok) return null; return await r.json(); }catch{return null;} }
    function updateObservations(){
      fetchNwsHighSoFar("KNYC").then(obs=>{
        const el=document.getElementById("box-today-obs"); const note=document.getElementById("box-today-obs-note");
        if(!el||!note) return;
        if(obs && obs.highF!=null){
          el.textContent=`${Number(obs.highF).toFixed(1)}¬∞F`;
          const ts=obs.atISO?new Date(obs.atISO):null;
          const tNY=ts? new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",hour:"numeric",minute:"2-digit"}).format(ts):"";
          note.textContent=tNY?`as of ${tNY} ET ‚Ä¢ station ${obs.station}`:`station ${obs.station}`;
        }else{ el.textContent="‚Äì"; note.textContent=""; }
      });
      fetchNwsCurrentTemp("KNYC").then(cur=>{
        const el=document.getElementById("box-today-current"); const note=document.getElementById("box-today-current-note");
        if(!el||!note) return;
        if(cur && cur.currentF!=null){
          el.textContent=`${Number(cur.currentF).toFixed(1)}¬∞F`;
          const ts=cur.atISO?new Date(cur.atISO):null;
          const tNY=ts? new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",hour:"numeric",minute:"2-digit"}).format(ts):"";
          note.textContent=tNY?`as of ${tNY} ET ‚Ä¢ station ${cur.station}`:`station ${cur.station}`;
        }else{ el.textContent="‚Äì"; note.textContent=""; }
      });
    }

    function updateSummaryBoxes(){
      const today    = nycISODate(0);
      const tomorrow = nycISODate(1);
      const yesterday= nycISODate(-1);

      const latestForDate = (date)=>{
        const rows = allRows
          .filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high);
        if(!rows.length) return null;
        rows.sort((a,b)=>{
          const A=a.timestamp||a.forecast_time||"";
          const B=b.timestamp||b.forecast_time||"";
          return B.localeCompare(A);
        });
        return Number(rows[0].predicted_high);
      };

      const tLatest = latestForDate(today);
      const tActRow = allRows.find(r=>r.forecast_or_actual==="actual" && r.cli_date===today && r.actual_high);
      const tActual = tActRow ? Number(tActRow.actual_high) : null;
      const tmLatest = latestForDate(tomorrow);

      document.getElementById("box-today-forecast").textContent   = (tLatest==null) ? "‚Äì" : tLatest.toFixed(1)+"¬∞F";
      document.getElementById("box-today-actual").textContent     = (tActual==null) ? "‚Äì" : tActual.toFixed(1)+"¬∞F";
      document.getElementById("box-tomorrow-forecast").textContent= (tmLatest==null)? "‚Äì" : tmLatest.toFixed(1)+"¬∞F";

      const todayRows    = getForecastsForDate(today);
      const tomorrowRows = getForecastsForDate(tomorrow);
      renderMiniForecastChips(todayRows, "mini-today-forecasts");
      renderMiniForecastChips(tomorrowRows, "mini-tomorrow-forecasts");

      Promise.all([ getKalshiLabel(today), getKalshiLabel(yesterday) ])
        .then(async ([ktoday, kyday])=>{
          const tBox = document.getElementById('box-today-kalshi');
          const tNote= document.getElementById('box-today-kalshi-note');
          const yBox = document.getElementById('box-yday-kalshi');
          const yNote= document.getElementById('box-yday-kalshi-note');

          if(ktoday && ktoday.label){
            tBox.innerHTML=`<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">${ktoday.label}</a>`;
            tNote.textContent = ktoday.exactTemp!=null ? `Settled at ${ktoday.exactTemp.toFixed(1)}¬∞F.` : "";
          }else{
            const live=await fetchKalshiLiveLeader(today);
            if(live && live.leadingLabel){
              const pct=(live.leadingProb!=null)?` (${Math.round(live.leadingProb*100)}%)`:"";
              tBox.innerHTML=`<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">${live.leadingLabel}${pct}</a>`;
              tNote.textContent="Live leader (can flip before settlement).";
            }else{
              tBox.innerHTML=`<span class="kalshi-pending">Pending settlement</span>`;
              tNote.textContent="Closes 11:59 PM ET; settles after NWS daily report.";
            }
          }

          const anchor=kalshiAnchorForISO(yesterday);
          const yHref=`${KALSHI_BASE_URL}${anchor}`;
          if(kyday && kyday.label){
            const exact=kyday.exactTemp!=null? ` (settled ${kyday.exactTemp.toFixed(1)}¬∞F)`:"";
            yBox.innerHTML=`<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer">${kyday.label}${exact}</a>`;
            yNote.textContent="Links directly to yesterday‚Äôs contract.";
          }else{
            yBox.innerHTML=`<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer">Open yesterday‚Äôs market</a>`;
            yNote.textContent="No proxy data; linking via anchor.";
          }
        })
        .catch(()=>{
          const tBox=document.getElementById('box-today-kalshi');
          const tNote=document.getElementById('box-today-kalshi-note');
          const yBox=document.getElementById('box-yday-kalshi');
          const yNote=document.getElementById('box-yday-kalshi-note');
          if(tBox) tBox.innerHTML=`<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">Open market</a>`;
          if(tNote) tNote.textContent="Could not load proxy data.";
          const yHref=`${KALSHI_BASE_URL}${kalshiAnchorForISO(nycISODate(-1))}`;
          if(yBox) yBox.innerHTML=`<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer">Open yesterday‚Äôs market</a>`;
          if(yNote) yNote.textContent="Proxy error; using anchor link.";
        });
    }

    function calcBiases(){
      const biasList=[], dayMap={};
      allRows.forEach(r=>{
        const d=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!d) return; if(!dayMap[d]) dayMap[d]=[]; dayMap[d].push(r);
      });
      const dates=Object.keys(dayMap).sort();
      dates.forEach(d=>{
        const rows=dayMap[d];
        const actual=rows.find(r=>r.forecast_or_actual==="actual" && r.actual_high);
        if(!actual) return;
        const actualHigh=Number(actual.actual_high);
        const highTime=actual.high_time||"";
        const fcVals=[];
        rows.forEach(r=>{
          if(r.forecast_or_actual!=="forecast"||!r.predicted_high) return;
          if(highTime){
            const fcHH=(r.forecast_time||"").substr(11,5);
            if(fcHH && compareTimes(fcHH,highTime)>0) return;
          }
          fcVals.push(Number(r.predicted_high));
        });
        if(fcVals.length){
          const meanFc=fcVals.reduce((a,b)=>a+b,0)/fcVals.length;
          biasList.push(actualHigh-meanFc);
        }
      });
      return biasList;
    }
    function updateCorrectionBoxes(){
      const biasList=calcBiases();
      const avgBias=biasList.length? (biasList.reduce((a,b)=>a+b,0)/biasList.length):0;
      const today=nycISODate(0), tomorrow=nycISODate(1);

      const meanForecastForDate=(date)=>{
        const actual=allRows.find(r=>r.forecast_or_actual==="actual" && r.cli_date===date && r.actual_high);
        const highTime=actual?actual.high_time:"";
        const vals=allRows
          .filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high)
          .filter(r=>{
            if(highTime){
              const fcHH=(r.forecast_time||"").substr(11,5);
              if(fcHH && compareTimes(fcHH,highTime)>0) return false;
            }
            return true;
          }).map(r=>Number(r.predicted_high));
        if(!vals.length) return null;
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      };

      const tAvg=meanForecastForDate(today);
      const tmAvg=meanForecastForDate(tomorrow);
      const tPred=(tAvg==null)?null:tAvg+avgBias;
      const tmPred=(tmAvg==null)?null:tmAvg+avgBias;
      const biasTxt=(avgBias>0?"+":"")+avgBias.toFixed(2);

      document.getElementById("correctionBoxToday").innerHTML =
        `<div class="prediction-value">${tPred==null?"‚Äì":tPred.toFixed(1)+"¬∞F"}</div>
         <div class="prediction-subtitle">For ${today} ‚Ä¢ Historical bias: ${biasTxt}¬∞F (${biasList.length} days)</div>`;

      document.getElementById("correctionBoxTomorrow").innerHTML =
        `<div class="prediction-value">${tmPred==null?"‚Äì":tmPred.toFixed(1)+"¬∞F"}</div>
         <div class="prediction-subtitle">For ${tomorrow} ‚Ä¢ Historical bias: ${biasTxt}¬∞F (${biasList.length} days)</div>`;
    }

    function showStats(){
      const datesTracked = new Set(allRows.map(r => r.forecast_or_actual==="actual" ? r.cli_date : r.target_date).filter(Boolean));
      const daysTracked = datesTracked.size;

      const actualByDate = new Map();
      allRows.forEach(r=>{
        if(r.forecast_or_actual==="actual" && r.cli_date && r.actual_high){
          actualByDate.set(r.cli_date, Number(r.actual_high));
        }
      });
      const daysWithActual = actualByDate.size;

      let aaeSum=0, aaeCnt=0;
      const byDate={};
      allRows.forEach(r=>{
        const d=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!d) return; (byDate[d]??=[]).push(r);
      });
      Object.keys(byDate).forEach(d=>{
        const actualRow=byDate[d].find(r=>r.forecast_or_actual==="actual" && r.actual_high);
        if(!actualRow) return;
        const actual=Number(actualRow.actual_high);
        const highTime=actualRow.high_time||"";
        byDate[d].forEach(r=>{
          if(r.forecast_or_actual!=="forecast"||!r.predicted_high) return;
          if(highTime){
            const fcHH=(r.forecast_time||"").substr(11,5);
            if(fcHH && compareTimes(fcHH,highTime)>0) return;
          }
          const err=Math.abs(Number(r.predicted_high)-actual);
          if(Number.isFinite(err)){ aaeSum+=err; aaeCnt++; }
        });
      });

      let abeSum=0, abeCnt=0;
      Object.keys(byDate).forEach(d=>{
        const actualRow=byDate[d].find(r=>r.forecast_or_actual==="actual" && r.actual_high);
        if(!actualRow) return;
        const actual=Number(actualRow.actual_high);
        const highTime=actualRow.high_time||"";
        const errs=byDate[d].filter(r=>r.forecast_or_actual==="forecast"&&r.predicted_high)
          .filter(r=>{
            if(highTime){
              const fcHH=(r.forecast_time||"").substr(11,5);
              if(fcHH && compareTimes(fcHH,highTime)>0) return false;
            }
            return true;
          })
          .map(r=>Math.abs(Number(r.predicted_high)-actual))
          .filter(Number.isFinite);
        if(errs.length){ abeSum+=Math.min(...errs); abeCnt++; }
      });

      const statsEl=document.getElementById('stats');
      if(statsEl){
        statsEl.querySelectorAll('.stat-card .stat-value')[0].textContent = daysTracked;
        statsEl.querySelectorAll('.stat-card .stat-value')[1].textContent = daysWithActual;
        statsEl.querySelectorAll('.stat-card .stat-value')[2].textContent = aaeCnt? (aaeSum/aaeCnt).toFixed(2)+"¬∞F" : "--¬∞F";
        statsEl.querySelectorAll('.stat-card .stat-value')[3].textContent = abeCnt? (abeSum/abeCnt).toFixed(2)+"¬∞F" : "--¬∞F";
      }
    }

    /* Chart ‚Äî start on prior Monday + rich tooltip */
    function showChart(){
      const byDate = {};
      filteredRows.forEach(r=>{
        const d = (r.forecast_or_actual==="actual" ? r.cli_date : r.target_date);
        if(!d) return; (byDate[d] ??= []).push(r);
      });

      const haveDays = Object.keys(byDate).filter(d=>/^\d{4}-\d{2}-\d{2}$/.test(d)).sort();
      if(!haveDays.length){
        const ctx=document.getElementById('dailyChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx,{type:'line',data:{labels:[],datasets:[]},options:{}});
        return;
      }

      const isoToDate = (iso)=>{ const [Y,M,D]=iso.split('-').map(Number); return new Date(Y, M-1, D); };
      const dateToISO = (dt)=>`${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
      const addDays = (dt, n)=>{ const d=new Date(dt); d.setDate(d.getDate()+n); return d; };

      const first = isoToDate(haveDays[0]);
      const dow   = first.getDay();            // 0=Sun...6=Sat
      const back  = (dow+6)%7;                 // days to go back to Monday
      const start = addDays(first, -back);
      const end   = isoToDate(haveDays[haveDays.length-1]);

      const labels = [];
      for(let d=new Date(start); d<=end; d=addDays(d,1)){
        labels.push(dateToISO(d));
      }

      const actualMap = new Map();
      const bestMap   = new Map();
      labels.forEach(d=>{
        const rows = byDate[d] || [];
        const a    = rows.find(r=>r.forecast_or_actual==="actual" && r.actual_high);
        if(a){
          const actualHigh = Number(a.actual_high);
          actualMap.set(d, Number.isFinite(actualHigh) ? actualHigh : null);
          const highTime = a.high_time || "";
          const pre = rows
            .filter(r=>r.forecast_or_actual==="forecast" && r.predicted_high)
            .filter(r=>{
              if(highTime){
                const fcHH=(r.forecast_time||"").substr(11,5);
                if(fcHH && compareTimes(fcHH, highTime) > 0) return false;
              }
              return true;
            })
            .map(r=>Number(r.predicted_high))
            .filter(Number.isFinite);
          if(pre.length){
            const errs = pre.map(v=>({v, e: Math.abs(v-actualHigh)}));
            errs.sort((a,b)=>a.e-b.e);
            bestMap.set(d, errs[0].v);
          }
        }
      });

      const actual = labels.map(d => actualMap.has(d) ? actualMap.get(d) : null);
      const best   = labels.map(d => bestMap.has(d)   ? bestMap.get(d)   : null);

      const ctx = document.getElementById('dailyChart').getContext('2d');
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:'Actual High', data:actual, borderWidth:3, tension:.3, pointRadius:0, pointHitRadius:10, borderColor:'#2563eb'},
            {label:'Best Forecast (pre-high)', data:best, borderWidth:3, tension:.3, pointRadius:0, pointHitRadius:10, borderColor:'#059669'}
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          spanGaps:true,
          animation:false,
          interaction:{mode:'index', intersect:false},
          plugins:{
            legend:{display:true},
            tooltip:{
              mode:'index',
              intersect:false,
              callbacks:{
                title:(items)=>{
                  const iso = labels[items[0].dataIndex];
                  const [Y,M,D]=iso.split('-').map(Number);
                  const jsDate=new Date(Y, M-1, D);
                  return new Intl.DateTimeFormat('en-US',{weekday:'short', month:'short', day:'numeric'}).format(jsDate);
                },
                label:(ctx)=>{
                  const y = ctx.parsed.y;
                  if(y==null) return `${ctx.dataset.label}: ‚Äî`;
                  return `${ctx.dataset.label}: ${Number(y).toFixed(1)}¬∞F`;
                }
              }
            }
          },
          scales:{
            x:{
              title:{display:true, text:'Day'},
              grid:{color:'rgba(0,0,0,0.05)'},
              offset:true,
              ticks:{
                autoSkip:true,
                autoSkipPadding:8,
                maxRotation:0, minRotation:0,
                callback:(val, idx)=>{
                  const iso = labels[idx];
                  if(!iso) return '';
                  const [Y,M,D]=iso.split('-').map(Number);
                  const jsDate=new Date(Y, M-1, D);
                  if(idx===0 || idx===labels.length-1 || jsDate.getDate()===1 || jsDate.getDay()===1){
                    return new Intl.DateTimeFormat('en-US',{month:'short', day:'numeric'}).format(jsDate);
                  }
                  return '';
                }
              }
            },
            y:{
              title:{display:true, text:'Temperature (¬∞F)'},
              grid:{color:'rgba(0,0,0,.05)'}
            }
          }
        }
      });
    }

    async function displayTable(){
      const tb=document.querySelector("#dataTable tbody"); if(!tb) return;
      tb.innerHTML="";

      const dayMap={};
      filteredRows.forEach(r=>{
        const date=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!date) return; (dayMap[date]??=[]).push(r);
      });

      const dates=Object.keys(dayMap).filter(d=>/^\d{4}-\d{2}-\d{2}$/.test(d)).sort();

      const kalshiByDate={};
      await Promise.all(dates.map(async d=>{
        try{ kalshiByDate[d]=await getKalshiLabel(d); }catch{ kalshiByDate[d]=null; }
      }));

      dates.forEach(date=>{
        const rows=dayMap[date];
        const forecasts = rows.filter(r=>r.forecast_or_actual==="forecast");
        const actual    = rows.find(r=>r.forecast_or_actual==="actual") || null;

        forecasts.sort((a,b)=>{
          const A=(a.timestamp||a.forecast_time||"");
          const B=(b.timestamp||b.forecast_time||"");
          return A.localeCompare(B);
        });

        let bestIdx=-1, bestErr=Infinity;
        const actualHigh = actual && actual.actual_high ? Number(actual.actual_high) : null;
        const highTime   = actual && actual.high_time ? actual.high_time : "";

        forecasts.forEach((r,i)=>{
          if(!r.predicted_high || actualHigh==null) return;
          if(highTime){
            const fcHH=(r.forecast_time||"").substr(11,5);
            if(fcHH && compareTimes(fcHH,highTime)>0) return;
          }
          const err=Math.abs(Number(r.predicted_high)-actualHigh);
          if(err<bestErr){ bestErr=err; bestIdx=i; }
        });

        forecasts.forEach((r,i)=>{
          const cls="forecast-row"+(i===bestIdx?" best":"");
          const pulled=r.timestamp||r.date_pulled||"";
          const fcTime=(r.forecast_time||"").substr(11,5);
          const pred=r.predicted_high? `${r.predicted_high}¬∞F`:"";
          const actTxt = actual && actual.actual_high ? `${actual.actual_high}¬∞F` : "";
          const errTxt = (r.predicted_high && actualHigh!=null) ? (Math.abs(Number(r.predicted_high)-actualHigh)).toFixed(1) : "";
          tb.insertAdjacentHTML("beforeend", `
            <tr class="${cls}">
              <td>${pulled}</td>
              <td>${fcTime}</td>
              <td>${date}</td>
              <td>${pred}</td>
              <td>${actTxt}</td>
              <td>${highTime||""}</td>
              <td>${errTxt}</td>
              <td>${i===bestIdx?"‚úÖ":""}</td>
              <td></td>
            </tr>
          `);
        });

        if(actual){
          const pulled=actual.timestamp||actual.date_pulled||"";
          const actTxt=actual.actual_high? `${actual.actual_high}¬∞F`:"";
          const k=kalshiByDate[date];
          const label=k && k.label ? k.label : "";
          const exact=(k && k.exactTemp!=null) ? ` (${k.exactTemp.toFixed(1)}¬∞F)` : "";
          const yISO=nycISODate(-1);
          let kalshiCell="‚Äî";
          if(date===yISO){
            kalshiCell = `<a class="kalshi-badge" href="${KALSHI_BASE_URL}${kalshiAnchorForISO(yISO)}" target="_blank" rel="noopener noreferrer">${label||"Open market"}${exact}</a>`;
          }else if(date===nycISODate(0)){
            kalshiCell = `<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">${label||"Open market"}</a>`;
          }else if(label){
            kalshiCell = `<span class="kalshi-badge">${label}${exact}</span>`;
          }

          tb.insertAdjacentHTML("beforeend", `
            <tr class="actual-row">
              <td>${pulled}</td>
              <td></td>
              <td>${date}</td>
              <td></td>
              <td>${actTxt}</td>
              <td>${actual.high_time||""}</td>
              <td></td>
              <td></td>
              <td>${kalshiCell}</td>
            </tr>
          `);
        }
      });
    }

    function resetFilter(){
      filteredRows=allRows.slice();
      document.getElementById('fromDate').value="";
      document.getElementById('toDate').value="";
      displayTable(); showStats(); showChart();
      showMostRecent(); updateCorrectionBoxes(); updateSummaryBoxes();
    }
    function applyDateFilter(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      filteredRows=allRows.filter(row=>{
        const date=row.forecast_or_actual==="actual"?row.cli_date:row.target_date;
        if(!date) return false;
        if(from && date<from) return false;
        if(to && date>to) return false;
        return true;
      });
      displayTable(); showStats(); showChart();
      showMostRecent(); updateCorrectionBoxes(); updateSummaryBoxes();
    }

    function bootApp(){
      // load CSV only after auth-confirmed UI
      reloadCSV();
      // live obs refresh
      setInterval(updateObservations, 5*60*1000);
    }

    // Kick off auth + app init
    (function(){ requireAuthAndBoot(); })();

    /* Optional CTA wiring (IDs can be added later) */
    (function(){
      const DASHBOARD = location.href;
      function waitForMSQuick(tries=60, delay=100){
        return new Promise(resolve=>{
          (function loop(n){
            const ms=window.$memberstackDom;
            if(ms && typeof ms.getCurrentMember==="function") return resolve(ms);
            if(n<=0) return resolve(null);
            setTimeout(()=>loop(n-1),delay);
          })(tries);
        });
      }
      ["cta-explore","cta-explore-2"].forEach((id)=>{
        const btn=document.getElementById(id);
        if(!btn) return;
        btn.addEventListener("click", async (e)=>{
          e.preventDefault();
          const ms=await waitForMSQuick();
          if(!ms){ location.href=DASHBOARD; return; }
          try{
            const {data:member}=await ms.getCurrentMember();
            if(member) location.href=DASHBOARD;
            else await ms.openModal("SIGNUP");
          }catch{ location.href=DASHBOARD; }
        });
      });
    })();
  </script>
</body>
</html>
