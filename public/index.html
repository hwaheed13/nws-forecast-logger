<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå°Ô∏è Daily Dew Point Dashboard</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-accent: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --border-subtle: #e2e8f0;
      --border-default: #cbd5e1;
      --accent-blue: #2563eb;
      --accent-blue-light: #dbeafe;
      --accent-green: #059669;
      --accent-green-light: #d1fae5;
      --accent-amber: #d97706;
      --accent-amber-light: #fef3c7;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, .05);
    }

    * { box-sizing: border-box; }

    /* Gate */
    #gate {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh;
      background: var(--bg-primary); color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      padding: 24px; text-align: center;
    }
    .gate-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle);
      border-radius: 16px; padding: 24px 22px; box-shadow: var(--shadow-sm);
      max-width: 520px; width: 100%;
    }
    .gate-title { font-size: 18px; font-weight: 800; margin: 0 0 6px; }
    .gate-sub { font-size: 14px; color: var(--text-muted); margin: 0 0 12px; }
    .gate-note { font-size: 12px; color: var(--text-light); }
    .gate-spinner { width: 28px; height: 28px; border-radius: 50%;
      border: 3px solid var(--border-subtle); border-top-color: var(--accent-blue);
      margin: 12px auto 8px; animation: spin 1s linear infinite;
    }
    .gate-error { color: #dc2626; font-size: 14px; margin: 12px 0; display:none; }
    .gate-btn { background: var(--accent-blue); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; margin: 4px; display:none; }
    body.app-ready #gate { display: none !important; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* App */
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg-primary); color: var(--text-primary);
      margin: 0; line-height: 1.6;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-subtle); padding: 20px 0; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px); }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; justify-content: space-between; gap: 14px; }
    .brand-left { display: flex; align-items: center; gap: 12px; }
    .brand-mark { display: grid; place-items: center; width: 40px; height: 40px; border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light)); box-shadow: var(--shadow-sm); border: 1px solid var(--border-subtle); position: relative; top: -3px; }
    .brand-mark svg { display: block; transform: translate(1px, 1px); }
    .brand-title { margin: 0; font-weight: 800; letter-spacing: .2px; font-size: 28px; line-height: 1.15; color: var(--text-primary); }
    .brand-title .thin { font-weight: 600; color: var(--text-secondary); }
    .brand-sub { margin: 2px 0 0; font-size: 13px; color: var(--text-muted); }
    .brand-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .brand-right .pill-group { display: flex; gap: 6px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; font-size: 12px; font-weight: 700; color: var(--text-secondary); background: var(--bg-accent); border: 1px solid var(--border-subtle); border-radius: 999px; }
    .pill.live { background: var(--accent-green-light); color: var(--accent-green); border-color: transparent; }
    .pill.live .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .pill.logout-btn { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-default); }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .last-update { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 18px 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
    .last-update-label { font-size: 12px; color: var(--text-muted); letter-spacing: .06em; text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
    .last-update-content { font-size: 15px; color: var(--text-secondary); font-weight: 600; }
    #todayDate { display: block; font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; }

    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .metric-card { background: var(--bg-secondary); border: 1.5px solid var(--border-subtle); border-radius: 18px; padding: 24px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
    .metric-card::before { content: ''; position: absolute; inset: 0 0 auto; height: 4px; background: linear-gradient(90deg, var(--accent-blue), var(--accent-green)); }
    .metric-card.today-forecast::before { background: var(--accent-amber); }
    .metric-card.today-obs::before { background: var(--accent-blue); }
    .metric-card.today-actual::before { background: var(--accent-green); }
    .metric-card.tomorrow-forecast::before { background: var(--accent-blue); }
    .metric-label { font-size: 14px; color: var(--text-muted); margin-bottom: 6px; font-weight: 700; letter-spacing: .02em; }
    .metric-value { font-size: 36px; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; line-height: 1; }
    .metric-subtitle { font-size: 13px; color: var(--text-light); }
    .mini-forecasts { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .mini-chip { background: var(--bg-accent); color: var(--text-secondary); padding: 4px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; border: 1px solid var(--border-subtle); }

    .kalshi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .kalshi-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 22px; }
    .kalshi-note { font-size: 12px; color: var(--text-light); margin-top: 6px; }

    .prediction-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .prediction-card { background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light)); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; }
    .prediction-title { font-size: 15px; font-weight: 800; margin-bottom: 12px; }
    .prediction-content {}
    .prediction-value { font-size: 28px; font-weight: 800; color: #1f2937; }
    .prediction-subtitle { font-size: 13px; color: var(--text-secondary); }

    .controls-section { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 18px; margin-bottom: 22px; }
    .controls-title { font-size: 15px; font-weight: 800; margin-bottom: 10px; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .control-group { display: flex; align-items: center; gap: 6px; }
    .control-label { font-size: 13px; font-weight: 700; color: var(--text-secondary); }
    input[type="date"] { padding: 8px 10px; border: 1px solid var(--border-default); border-radius: 10px; font-size: 14px; background: var(--bg-secondary); }
    input[type="date"]:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px var(--accent-blue-light); }
    .btn { background: var(--accent-blue); color: #fff; border: none; border-radius: 10px; padding: 9px 16px; font-size: 14px; font-weight: 800; cursor: pointer; box-shadow: var(--shadow-sm); }
    .btn.secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-default); }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 18px; text-align: center; }
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 700; }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--accent-blue); }

    .chart-section { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; margin-bottom: 22px; }
    .chart-title { font-size: 16px; font-weight: 800; margin-bottom: 14px; }
    .chart-container { position: relative; height: clamp(220px, 38vh, 380px); width: 100%; }

    .table-section { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 0; overflow: hidden; }
    .table-container { overflow-x: auto; border-top: 1px solid var(--border-subtle); padding: 0 18px 18px; }
    #dataTable { width: 100%; border-collapse: collapse; font-size: 14px; background: var(--bg-secondary); }
    #dataTable th { background: var(--bg-tertiary); color: var(--text-primary); padding: 12px 10px; text-align: left; font-weight: 800;
      font-size: 12px; letter-spacing: .06em; text-transform: uppercase; border-bottom: 2px solid var(--border-default); position: sticky; top: 0; z-index: 1; }
    #dataTable td { padding: 12px 10px; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); }
    #dataTable tbody tr:hover { background: var(--bg-accent); }
    .forecast-row { background: var(--accent-blue-light) !important; }
    .actual-row { background: var(--accent-green-light) !important; }
    .best { box-shadow: inset 0 0 0 2px var(--accent-green); }
    details.table-wrap { border-top: 1px solid var(--border-subtle); }
    details.table-wrap summary { background: var(--bg-accent); border-bottom: 1px solid var(--border-subtle);
      list-style: none; cursor: pointer; padding: 16px 18px; font-weight: 800; display: flex; align-items: center; justify-content: space-between; }
    details.table-wrap summary::-webkit-details-marker { display: none; }
    .caret { transition: transform .2s ease; }
    details[open] summary .caret { transform: rotate(90deg); }
    .skel td::before { content: ""; display: block; height: 12px; margin: 4px 0; width: 70%;
      background: linear-gradient(90deg, var(--bg-accent), var(--bg-tertiary), var(--bg-accent));
      background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

    .footer { margin-top: 28px; padding: 18px 24px; background: var(--bg-tertiary); border-top: 1px solid var(--border-subtle);
      text-align: center; font-size: 12px; color: var(--text-light); }
    .footer a { color: var(--accent-blue); text-decoration: none; }

    /* Fluid/mobile */
    .brand-title { font-size: clamp(18px, 2.2vw, 28px); }
    .metric-value { font-size: clamp(22px, 3vw, 36px); }
    .prediction-value { font-size: clamp(20px, 2.6vw, 28px); }
    .stat-value { font-size: clamp(18px, 2.4vw, 28px); }
    .kalshi-badge { font-size: clamp(11px, 1.8vw, 14px); padding: 6px 10px; }
    .pill { font-size: clamp(10px, 1.6vw, 12px); padding: 4px 8px; }

    @media (max-width: 600px) {
      .container { padding: 12px; }
      .header { padding: 12px 0; }
      .brand { gap: 8px; }
      .brand-left { gap: 8px; }
      .brand-mark { width: 32px; height: 32px; border-radius: 10px; top: -17px; }
      .brand-mark svg { width: 28px; height: 28px; transform: translate(0, 0); }
      .brand-sub { font-size: 12px; line-height: 1.35; }
      .brand-right .pill-group { margin-top: -14px; }
      .pill.logout-btn { margin-top: 18px; }
      .metrics-grid, .prediction-grid, .kalshi-grid { grid-template-columns: 1fr; gap: 10px; }
      .metric-card { padding: 14px; border-radius: 14px; }
      .metric-label { font-size: 13px; }
      .metric-subtitle { font-size: 12px; }
      .prediction-card { padding: 14px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .stat-card { padding: 10px; }
      .stat-label { font-size: 11px; }
      .stat-value { font-size: 22px; }
      .mini-forecasts { gap: 4px; }
      .mini-chip { font-size: 11px; padding: 3px 8px; }
      .controls-section { padding: 12px; }
      .controls { gap: 8px; }
      .control-label { font-size: 12px; }
      input[type="date"] { font-size: 13px; padding: 7px 8px; border-radius: 8px; }
      .btn { font-size: 13px; padding: 8px 12px; border-radius: 8px; }
      .chart-section { padding: 14px; }
      .chart-title { font-size: 14px; margin-bottom: 10px; }
      .chart-container { height: 260px; }
      .table-container { padding: 0 12px 12px; }
      #dataTable { font-size: 12px; }
      #dataTable th { font-size: 11px; padding: 10px 8px; }
      #dataTable td { padding: 10px 8px; }
      .brand-right { gap: 6px; flex-wrap: wrap; justify-content: flex-start; }
      .pill { flex: 0 1 auto; }
      .pill .dot { width: 5px; height: 5px; }
      .last-update-label { font-size: 10px; }
      .last-update-content { font-size: 13px; line-height: 1.35; }
    }

    @media (min-width: 601px) {
      .pill.logout-btn { margin-top: 10px; background: #e5e7eb; color: var(--text-primary);
        border: 1px solid var(--border-default); font-size: 14px; padding: 8px 14px; border-radius: 12px; }
    }

    .brand-right .pill-sep { flex: 0 0 12px; }

    @media (min-width: 960px) {
      #btn-billing, #btn-logout { position: relative; left: calc(max(0px, (100vw - 1400px) / 2 - 12px)); margin-top: -6px; }
      .pill.logout-btn { margin-top: -6px; }
      #btn-billing { margin-top: -4px; background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
      #btn-billing:hover { background: #bfdbfe; }
    }
    #btn-billing, #btn-logout { cursor: pointer; transition: transform .02s ease, box-shadow .15s ease, opacity .15s ease; }
    #btn-billing:hover, #btn-logout:hover { box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    #btn-billing:active, #btn-logout:active { transform: translateY(1px); opacity: .9; }

    @media (min-width: 960px) {
      .brand-right { display: grid; grid-template-columns: auto auto; column-gap: 12px; row-gap: 10px; align-items: center; justify-items: end; }
      .brand-right .pill-group { grid-column: 1; grid-row: 1; }
      #btn-billing { grid-column: 2; grid-row: 1; }
      #btn-logout { grid-column: 2; grid-row: 2; }
      #btn-billing, #btn-logout { left: calc(max(0px, (100vw - 1400px) / 2 - 6px)); }
      #btn-billing { margin-top: -2px; background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
      #btn-billing:hover { background: #bfdbfe; }
    }

    .lu-top { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
    .lu-date { display:block; font-size:14px; font-weight:700; color:var(--text-primary); text-transform:uppercase; letter-spacing:.02em; margin-bottom:2px; }
    .lu-badge { white-space:nowrap; font-size:12px; font-weight:800; color:#b91c1c; margin-top:4px; }
    @media (max-width: 600px) {
      .lu-top { gap:6px; margin-bottom:2px; }
      .lu-date { margin-bottom:0; }
      .lu-badge { font-size:10px; white-space:normal; display:block; margin-top:0; text-align:right; }
      .last-update-label { font-size:11px; }
    }
    @media (max-width: 600px) {
      .last-update .lu-badge { display:block; margin-top:-6px; }
    }

    .tip { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%;
      font-size:11px; font-weight:800; line-height:1; cursor:help; border:1px solid var(--border-default); color:var(--text-secondary);
      background:var(--bg-tertiary); margin-left:6px; position:relative; outline:none; }
    .tip:hover { box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .tip:focus-visible { box-shadow: 0 0 0 3px var(--accent-blue-light); }
    .tip[data-tip]::after{
      content:attr(data-tip); position:absolute; inset:auto auto calc(100% + 8px) 50%; transform:translateX(-50%);
      white-space:nowrap; background:#111827; color:#fff; font-size:12px; font-weight:600; padding:6px 8px; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.15); opacity:0; pointer-events:none; transition:opacity .12s ease, transform .12s ease;
    }
    .tip[data-tip]::before{
      content:""; position:absolute; inset:auto auto calc(100% + 3px) 50%; transform:translateX(-50%);
      border:6px solid transparent; border-top-color:#111827; opacity:0; transition:opacity .12s ease;
    }
    .tip:hover[data-tip]::after,.tip:focus[data-tip]::after,.tip:hover[data-tip]::before,.tip:focus[data-tip]::before{opacity:1;}
  </style>
</head>

<body>
  <!-- ====== LOGIN GATE ====== -->
  <div id="gate" role="status" aria-live="polite">
    <div class="gate-card">
      <div class="gate-title">Checking access‚Ä¶</div>
      <div class="gate-sub">Loading the dashboard.</div>
      <div class="gate-spinner" aria-hidden="true"></div>
      <div class="gate-note">This will update automatically.</div>
      <div id="gate-error" class="gate-error"></div>
      <div>
        <button id="gate-retry" class="gate-btn">Retry</button>
        <button id="gate-skip" class="gate-btn">Skip to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- ====== APP ====== -->
  <div id="app" style="display:none">
    <header class="header">
      <div class="header-content brand">
        <div class="brand-left">
          <div class="brand-mark" aria-hidden="true">
            <svg viewBox="0 0 64 64" width="38" height="38" role="img">
              <defs>
                <linearGradient id="dpGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="var(--accent-blue)" />
                  <stop offset="100%" stop-color="var(--accent-green)" />
                </linearGradient>
              </defs>
              <path fill="url(#dpGrad)" d="M32 6c6 10 16 18 16 30 0 9.94-8.06 18-18 18s-18-8.06-18-18C12 24 26 16 32 6z"/>
            </svg>
          </div>
          <div class="brand-copy">
            <h1 class="brand-title"><span class="thin">Daily</span> Dew&nbsp;Point</h1>
            <p class="brand-sub">Automatically logs every NWS forecast update for Central Park and compares to the official daily high</p>
          </div>
        </div>
        <div class="brand-right">
          <div class="pill-group">
            <span class="pill live"><span class="dot"></span> Live</span>
            <span class="pill">NYC</span>
            <span class="pill">KNYC</span>
          </div>
          <button id="btn-billing" class="pill">Manage billing</button>
          <button id="btn-logout" class="pill logout-btn">Log out</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="last-update">
        <div class="lu-top">
          <span id="todayDate" class="lu-date"></span>
          <span class="lu-badge">All times and day boundary are Eastern Time (aligned with NWS)</span>
        </div>
        <div class="last-update-label">Latest Forecast Update</div>
        <div id="recentForecast" class="last-update-content">Loading latest forecast data...</div>
      </div>

      <!-- Metrics -->
      <div class="metrics-grid">
        <div class="metric-card today-forecast">
          <div class="metric-label">Today's Latest Forecast</div>
          <div id="box-today-forecast" class="metric-value">‚Äì</div>
          <div class="metric-subtitle">Today's Forecasts</div>
          <div id="mini-today-forecasts" class="mini-forecasts"></div>
        </div>

        <div class="metric-card today-actual">
          <div class="metric-label">Today's High (DSM)</div>
          <div id="box-dsm-max" class="metric-value">‚Äì</div>
          <div id="box-dsm-note" class="metric-subtitle"></div>
          <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
            <div class="metric-label" style="margin-bottom:6px;">Today's Actual High (CLI)</div>
            <div id="box-today-actual" class="metric-value">‚Äì</div>
            <div id="box-today-actual-note" class="metric-subtitle">NWS daily climatological report</div>
          </div>
        </div>

        <div class="metric-card today-obs">
          <div class="metric-label">High Time</div>
          <div id="box-6hr-max" class="metric-value">‚Äì</div>
          <div id="box-6hr-max-note" class="metric-subtitle"></div>
          <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
            <div class="metric-label">Most Recent Forecasted High</div>
            <div id="box-today-current" class="metric-value">‚Äì</div>
            <div id="box-today-current-note" class="metric-subtitle"></div>
          </div>
        </div>

        <div class="metric-card tomorrow-forecast">
          <div class="metric-label">Tomorrow's Latest Forecast</div>
          <div id="box-tomorrow-forecast" class="metric-value">‚Äì</div>
          <div class="metric-subtitle">Tomorrow's Forecasts</div>
          <div id="mini-tomorrow-forecasts" class="mini-forecasts"></div>
        </div>
      </div>

      <!-- Bias-corrected -->
      <div class="prediction-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:18px; margin-bottom:22px;">
        <div class="prediction-card">
          <div class="prediction-title">Today‚Äôs Bias-Corrected Prediction</div>
          <div id="correctionBoxToday" class="prediction-content">
            <div class="prediction-value">‚Äî</div>
            <div class="prediction-subtitle">Based on rolling 30-day mean bias</div>
          </div>
        </div>
        <div class="prediction-card">
          <div class="prediction-title">Tomorrow‚Äôs Bias-Corrected Prediction</div>
          <div id="correctionBoxTomorrow" class="prediction-content">
            <div class="prediction-value">‚Äî</div>
            <div class="prediction-subtitle">Based on rolling 30-day mean bias</div>
          </div>
        </div>
        <div style="grid-column:1 / span 2; font-size:12px; color:var(--text-light); margin-top:-4px;">
          Corrected = Latest Forecast ‚àí Mean(Forecast ‚àí Actual) over last 30 days with data.
        </div>
      </div>

      <!-- Kalshi -->
      <div class="kalshi-grid">
        <div class="kalshi-card">
          <div class="metric-label">Today's Kalshi Market</div>
          <div id="box-today-kalshi" class="metric-value" style="font-size:18px;">‚Äî</div>
          <div id="box-today-kalshi-note" class="kalshi-note"></div>
        </div>
        <div class="kalshi-card">
          <div class="metric-label">Yesterday's Kalshi Result</div>
          <div id="box-yday-kalshi" class="metric-value" style="font-size:18px;">‚Äî</div>
          <div id="box-yday-kalshi-note" class="kalshi-note"></div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls-section">
        <div class="controls-title">Filter Data</div>
        <div class="controls">
          <div class="control-group">
            <label class="control-label" for="fromDate">From:</label>
            <input type="date" id="fromDate"/>
          </div>
          <div class="control-group">
            <label class="control-label" for="toDate">To:</label>
            <input type="date" id="toDate"/>
          </div>
          <button class="btn" onclick="applyDateFilter()">Apply Filter</button>
          <button class="btn secondary" onclick="resetFilter()">Show All</button>
          <button class="btn secondary" onclick="reloadCSV()">Refresh Data</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="stats">
        <div class="stat-card"><div class="stat-label">Days Tracked</div><div class="stat-value">0</div></div>
        <div class="stat-card"><div class="stat-label">Days With Actual</div><div class="stat-value">0</div></div>
        <div class="stat-card"><div class="stat-label">Average Absolute Error</div><div class="stat-value">--¬∞F</div></div>
        <div class="stat-card"><div class="stat-label">Average Best Error</div><div class="stat-value">--¬∞F</div></div>
      </div>

      <!-- Chart -->
      <div class="chart-section">
        <div class="chart-title">Temperature Trends: Actual vs Predicted</div>
        <div class="chart-container"><canvas id="dailyChart" width="1000" height="380"></canvas></div>
      </div>

      <!-- Collapsible Table -->
      <div class="table-section">
        <details class="table-wrap" open>
          <summary><span>Detailed Forecast Log</span><span class="caret">‚ñ∏</span></summary>
          <div class="table-container">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>Date Pulled</th>
                  <th>Forecast Time</th>
                  <th>For Date</th>
                  <th>Forecasted High</th>
                  <th>Actual High</th>
                  <th>High Time</th>
                  <th>Error (¬∞F)</th>
                  <th>Best?</th>
                  <th>Kalshi Range</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>

    <footer class="footer">
      ¬© 2025 Dewdrop Ventures, LLC ¬∑
      <a href="/terms.html">Terms</a> ¬∑
      <a href="/privacy.html">Privacy</a> ¬∑
      <span>Informational only ‚Äî not financial advice. Do your own due diligence before placing any bets or making financial decisions.</span>
    </footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ===================== DATA + UI ===================== -->
  <script>
    // -------- Gate helpers
    function showApp(){ const g=document.getElementById('gate'), a=document.getElementById('app'); document.body.classList.add('app-ready'); if(a) a.style.display=''; if(g) g.style.display='none'; }
    function showGate(msg){ const g=document.getElementById('gate'); if(!g) return; g.style.display=''; const sub=g.querySelector('.gate-sub'); if(sub&&msg) sub.textContent=msg; }
    function showGateError(message){ const err=document.getElementById('gate-error'); const spinner=document.querySelector('.gate-spinner'); if(err){ err.textContent=message||'Something went wrong.'; err.style.display='block'; } if(spinner) spinner.style.display='none'; document.getElementById('gate-retry').style.display='inline-block'; document.getElementById('gate-skip').style.display='inline-block'; }

    // -------- Date/time helpers
    function showTodayDate(){ const el=document.getElementById('todayDate'); if(!el) return; const label=new Intl.DateTimeFormat('en-US',{timeZone:'America/New_York',weekday:'short',month:'short',day:'numeric',year:'numeric'}).format(new Date()); el.textContent=label; }
    function scheduleMidnightUpdate(){ showTodayDate(); setInterval(showTodayDate, 60*1000); }
    function nycISODate(offsetDays=0){ const fmt=new Intl.DateTimeFormat('en-CA',{timeZone:'America/New_York',year:'numeric',month:'2-digit',day:'2-digit'}); const parts=fmt.formatToParts(new Date(Date.now()+offsetDays*86400000)); const g=k=>parts.find(p=>p.type===k).value; return `${g('year')}-${g('month')}-${g('day')}`; }

    // -------- CSV fetch/parse
    const CSV_URL="https://raw.githubusercontent.com/hwaheed13/nws-forecast-logger/main/nws_forecast_log.csv";
    let allRows=[], filteredRows=[], chartInstance=null;

    function csvToRows(text){
      const rows=[]; let row=[], field='', q=false;
      for(let i=0;i<text.length;i++){ const c=text[i], n=text[i+1];
        if(c==='"'){ if(q&&n==='"'){ field+='"'; i++; } else q=!q; }
        else if(c===',' && !q){ row.push(field); field=''; }
        else if((c==='\n'||c==='\r') && !q){ if(c==='\r' && n==='\n') i++; row.push(field); field=''; if(row.length && row.some(x=>x!=='')) rows.push(row); row=[]; }
        else field+=c;
      }
      if(field!==''||row.length){ row.push(field); if(row.length && row.some(x=>x!=='')) rows.push(row); }
      return rows;
    }
    function parseCSV(text){
      const rows=csvToRows(text); if(!rows.length) return;
      const header=rows[0].map(h=>h.trim()); allRows=[];
      for(let i=1;i<rows.length;i++){ const vals=rows[i]; const rec={};
        for(let j=0;j<header.length;j++){ let v=(vals[j]??'').trim(); if(v.startsWith('"')&&v.endsWith('"')) v=v.slice(1,-1).replace(/""/g,'"'); rec[header[j]]=v; }
        allRows.push(rec);
      }
    }
    function reloadCSV(){
      showSkeleton();
      return fetch(CSV_URL+"?"+Date.now())
        .then(r=>r.text())
        .then(parseCSV)
        .then(()=>{ filteredRows=allRows.slice(); driveUIFromData(); })
        .catch(err=>{ console.error("CSV load error:", err); const rf=document.getElementById('recentForecast'); if(rf) rf.textContent='Error loading data'; });
    }

    // -------- Skeleton table
    function showSkeleton(rows=6){ const tb=document.querySelector("#dataTable tbody"); if(!tb) return; tb.innerHTML=""; for(let i=0;i<rows;i++){ const tr=document.createElement("tr"); tr.className="skel"; tr.innerHTML="<td></td>".repeat(9); tb.appendChild(tr); } }

    // -------- Helpers for access to fields safely
    const asNum = v => (v===''||v==null||Number.isNaN(Number(v))) ? null : Number(v);
    const sliceTime = s => (s||'').slice(11,16);
    const sliceDate = s => (s||'').slice(0,10);

    // -------- Build day map: aggregates per calendar day
    function buildDayMap(){
      const map = new Map();
      for(const r of allRows){
        const day = r.target_date || r.cli_date;
        if(!day) continue;
        const obj = map.get(day) || { forecasts: [], lastForecast: null, actual: null, highTime: null, kalshi: r.kalshi_range || null };
        if(r.forecast_or_actual === 'forecast'){
          const when = r.timestamp || r.forecast_time || '';
          const val  = asNum(r.predicted_high);
          if(val!=null){
            obj.forecasts.push({ when, val });
            if(!obj.lastForecast || (when || '').localeCompare(obj.lastForecast.when || '') > 0){
              obj.lastForecast = { when, val };
            }
          }
        } else if (r.forecast_or_actual === 'actual'){
          const act = asNum(r.actual_high);
          if(act!=null) obj.actual = act;
          if(r.high_time) obj.highTime = r.high_time;
        }
        if(r.kalshi_range) obj.kalshi = r.kalshi_range;
        map.set(day, obj);
      }
      // sort forecast arrays
      for(const v of map.values()){
        v.forecasts.sort((a,b)=>(a.when||'').localeCompare(b.when||''));
      }
      return map;
    }

    // -------- UI Drivers
    function driveUIFromData(){
      showTodayDate();
      showMostRecent();
      updateSummaryBoxes();
      updateBiasCorrected();
      updateObservationalFromCSV();
      updateKalshi();
      displayTable();
      showStats();
      showChart();
    }

    function showMostRecent(){
      const el=document.getElementById("recentForecast"); if(!el) return;
      for(let i=allRows.length-1;i>=0;i--){
        const r=allRows[i];
        if(r && r.forecast_or_actual==="forecast" && r.predicted_high && (r.target_date || r.cli_date)){
          const d=(r.timestamp||r.forecast_time||""); const date=sliceDate(d), time=sliceTime(d);
          const tgt=r.target_date || r.cli_date;
          el.innerHTML=`<strong>${date}${time?` ${time}`:''} ET</strong> ‚Äî <strong>${Number(r.predicted_high).toFixed(0)}¬∞F</strong> for <strong>${tgt}</strong>`;
          return;
        }
      }
      el.textContent="No recent forecasts found";
    }

    function getForecastsForDate(dateISO){
      return allRows
        .filter(r=>r.forecast_or_actual==="forecast" && (r.target_date===dateISO) && r.predicted_high)
        .map(r=>({tstamp:r.timestamp||r.forecast_time||"", timeHHMM:sliceTime(r.forecast_time||r.timestamp||""), val:asNum(r.predicted_high)}))
        .filter(x=>Number.isFinite(x.val))
        .sort((a,b)=> (a.tstamp||"").localeCompare(b.tstamp||""));
    }

    function renderMiniForecastChips(rows, elId){
      const host=document.getElementById(elId); if(!host) return;
      host.innerHTML="";
      const compact=[];
      rows.forEach((r,i)=>{ if(i===0 || r.val!==rows[i-1].val) compact.push(r); });
      if(!compact.length){ host.innerHTML=`<span class="mini-chip">No forecasts yet</span>`; return; }
      compact.forEach(r=>{ const chip=document.createElement("span"); chip.className="mini-chip"; chip.textContent=`${r.timeHHMM||"‚Äî"}, ${r.val.toFixed(0)}¬∞`; host.appendChild(chip); });
    }

    function updateSummaryBoxes(){
      const today=nycISODate(0), tomorrow=nycISODate(1), map=buildDayMap();

      const tLast = map.get(today)?.lastForecast?.val ?? null;
      const tmLast = map.get(tomorrow)?.lastForecast?.val ?? null;
      const tActual = map.get(today)?.actual ?? null;

      const setTxt = (id, v) => { const e=document.getElementById(id); if(e) e.textContent = (v==null?'‚Äî':`${Math.round(v)}¬∞F`); };
      setTxt('box-today-forecast', tLast);
      setTxt('box-tomorrow-forecast', tmLast);
      const actEl=document.getElementById('box-today-actual'); if(actEl) actEl.textContent = (tActual==null?'‚Äî':`${Math.round(tActual)}¬∞F`);

      renderMiniForecastChips(getForecastsForDate(today), "mini-today-forecasts");
      renderMiniForecastChips(getForecastsForDate(tomorrow), "mini-tomorrow-forecasts");

      // also reflect the most recent forecast into the right-hand mini "Recent Forecasted High"
      const rc=document.getElementById('box-today-current'); if(rc) rc.textContent = (tLast==null?'‚Äî':`${Math.round(tLast)}¬∞F`);
      const rcNote=document.getElementById('box-today-current-note'); if(rcNote){
        const last = map.get(today)?.lastForecast?.when;
        rcNote.textContent = last ? `Latest for today at ${sliceTime(last)} ET` : '';
      }
    }

    // -------- Bias correction (rolling 30-day mean bias of last forecast)
    function computeRollingBias(daysBack=30){
      const map=buildDayMap();
      const keys=Array.from(map.keys()).sort();
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-daysBack);
      const errs=[];
      for(const k of keys){
        const d=new Date(k+"T00:00:00");
        if(d<cutoff) continue;
        const v=map.get(k);
        const f=v?.lastForecast?.val;
        const a=v?.actual;
        if(f!=null && a!=null){
          errs.push(f - a);
        }
      }
      if(!errs.length) return null;
      const mean = errs.reduce((s,x)=>s+x,0)/errs.length;
      return { mean, n: errs.length };
    }

    function updateBiasCorrected(){
      const today=nycISODate(0), tomorrow=nycISODate(1), map=buildDayMap();
      const bias = computeRollingBias(30);
      const tLast = map.get(today)?.lastForecast?.val ?? null;
      const tmLast = map.get(tomorrow)?.lastForecast?.val ?? null;

      const setBox = (id, val, n) => {
        const host=document.getElementById(id);
        if(!host) return;
        const pv = host.querySelector('.prediction-value');
        const ps = host.querySelector('.prediction-subtitle');
        if(val==null){
          if(pv) pv.textContent='‚Äî';
          if(ps) ps.textContent = bias ? `Mean bias from ${n} days` : 'Insufficient history';
        }else{
          if(pv) pv.textContent = `${Math.round(val)}¬∞`;
          if(ps) ps.textContent = bias ? `Using mean bias from ${n} days` : 'No bias history (uncorrected)';
        }
      };

      if(bias){
        const correctedToday = (tLast==null ? null : (tLast - bias.mean));
        const correctedTomorrow = (tmLast==null ? null : (tmLast - bias.mean));
        setBox('correctionBoxToday', correctedToday, bias.n);
        setBox('correctionBoxTomorrow', correctedTomorrow, bias.n);
      }else{
        // No bias history ‚Äî show latest as-is
        setBox('correctionBoxToday', tLast, 0);
        setBox('correctionBoxTomorrow', tmLast, 0);
      }
    }

    // -------- Observational from CSV (CLI actual + high time)
    function updateObservationalFromCSV(){
      const today=nycISODate(0), map=buildDayMap();
      const v = map.get(today);
      const cli = v?.actual ?? null;
      const highTime = v?.highTime || null;

      const dsmEl=document.getElementById('box-dsm-max'); // we map DSM to CLI actual since DSM series isn‚Äôt in CSV
      const dsmNote=document.getElementById('box-dsm-note');
      if(dsmEl) dsmEl.textContent = (cli==null?'‚Äî':`${Math.round(cli)}¬∞F`);
      if(dsmNote) dsmNote.textContent = highTime ? `High at ${sliceTime(highTime)} ET` : '';

      const tActNote=document.getElementById('box-today-actual-note');
      if(tActNote) tActNote.textContent = cli==null ? 'No CLI value yet for today' : 'NWS daily climatological report';
      const hiTimeEl=document.getElementById('box-6hr-max');
      const hiTimeNote=document.getElementById('box-6hr-max-note');
      if(hiTimeEl) hiTimeEl.textContent = highTime ? `${sliceTime(highTime)} ET` : '‚Äî';
      if(hiTimeNote) hiTimeNote.textContent = highTime ? 'From CLI high_time' : '';
    }

    // -------- Kalshi (derive basic status if range stored per-day)
    function updateKalshi(){
      const map=buildDayMap();
      const today=nycISODate(0), yday=nycISODate(-1);
      const tObj=map.get(today)||{}, yObj=map.get(yday)||{};

      const todayTxt=document.getElementById('box-today-kalshi');
      const todayNote=document.getElementById('box-today-kalshi-note');
      if(todayTxt) todayTxt.textContent = tObj.kalshi || '‚Äî';
      if(todayNote) todayNote.textContent = tObj.kalshi ? 'Range recorded alongside forecast log' : '';

      const yTxt=document.getElementById('box-yday-kalshi');
      const yNote=document.getElementById('box-yday-kalshi-note');
      if(yTxt){
        if(yObj.actual!=null && yObj.kalshi){
          // naive statement: actual fell into/relative to range string (free-form)
          yTxt.textContent = `${Math.round(yObj.actual)}¬∞F (actual)`;
          yNote.textContent = `Yesterday‚Äôs market range: ${yObj.kalshi}`;
        }else if(yObj.actual!=null){
          yTxt.textContent = `${Math.round(yObj.actual)}¬∞F (actual)`;
          yNote.textContent = 'No market range recorded for yesterday';
        }else{
          yTxt.textContent = '‚Äî';
          yNote.textContent = 'No actual reported yet for yesterday';
        }
      }
    }

    // -------- Table
    function displayTable(){
      const tb=document.querySelector("#dataTable tbody"); if(!tb) return;
      tb.innerHTML="";
      const rows = (filteredRows.length?filteredRows:allRows).slice(-1000); // cap for perf
      rows.forEach(r=>{
        const tr=document.createElement("tr");
        const isForecast = r.forecast_or_actual==="forecast";
        tr.className = isForecast ? "forecast-row" : "actual-row";
        const fVal = asNum(r.predicted_high);
        const aVal = asNum(r.actual_high);
        const err = (isForecast && fVal!=null && aVal!=null) ? (fVal - aVal) : "";
        tr.innerHTML = `
          <td>${sliceDate(r.timestamp||r.forecast_time||'')}</td>
          <td>${sliceTime(r.timestamp||r.forecast_time||'')}</td>
          <td>${r.target_date||r.cli_date||''}</td>
          <td>${fVal!=null?`${fVal.toFixed(0)}¬∞`:''}</td>
          <td>${aVal!=null?`${aVal.toFixed(0)}¬∞`:''}</td>
          <td>${r.high_time? sliceTime(r.high_time): ''}</td>
          <td>${err===""?'':Number(err).toFixed(1)}</td>
          <td>${r.is_best||''}</td>
          <td>${r.kalshi_range||''}</td>`;
        tb.appendChild(tr);
      });
    }

    // -------- Stats
    function showStats(){
      const byDay = new Map();
      allRows.forEach(r=>{
        const key = r.target_date || r.cli_date;
        if(!key) return;
        const o = byDay.get(key) || { forecasts:[], actual:null };
        if(r.forecast_or_actual==="forecast" && r.predicted_high!=null && r.predicted_high!=='') o.forecasts.push(asNum(r.predicted_high));
        if(r.forecast_or_actual==="actual" && r.actual_high!=null && r.actual_high!=='') o.actual = asNum(r.actual_high);
        byDay.set(key,o);
      });

      let daysTracked = byDay.size;
      let daysWithActual = 0, absErrSum = 0, bestErrSum = 0, bestErrCount = 0, absErrCount = 0;

      for (const v of byDay.values()) {
        if (typeof v.actual === 'number') {
          daysWithActual++;
          if (v.forecasts.length) {
            const last = v.forecasts[v.forecasts.length-1];
            absErrSum += Math.abs(last - v.actual); absErrCount++;
            const best = v.forecasts.reduce((m, x)=> Math.abs(x-v.actual)<Math.abs(m-v.actual)?x:m, v.forecasts[0]);
            bestErrSum += Math.abs(best - v.actual); bestErrCount++;
          }
        }
      }

      const statEls = document.querySelectorAll('#stats .stat-card .stat-value');
      if (statEls[0]) statEls[0].textContent = String(daysTracked);
      if (statEls[1]) statEls[1].textContent = String(daysWithActual);
      if (statEls[2]) statEls[2].textContent = absErrCount? `${(absErrSum/absErrCount).toFixed(1)}¬∞F` : '--¬∞F';
      if (statEls[3]) statEls[3].textContent = bestErrCount? `${(bestErrSum/bestErrCount).toFixed(1)}¬∞F` : '--¬∞F';
    }

    // -------- Chart (last 60 days)
    function showChart(){
      const ctx = document.getElementById('dailyChart'); if(!ctx) return;

      const byDay = new Map();
      allRows.forEach(r=>{
        const day = r.target_date || r.cli_date; if(!day) return;
        const o = byDay.get(day) || { last:null, actual:null };
        if(r.forecast_or_actual==="forecast" && r.predicted_high){
          const ts = r.timestamp || r.forecast_time || '';
          const val = asNum(r.predicted_high);
          if(o.last==null || (ts||'').localeCompare(o.last.ts||'')>0) o.last = { val, ts };
        }
        if(r.forecast_or_actual==="actual" && r.actual_high){
          o.actual = asNum(r.actual_high);
        }
        byDay.set(day,o);
      });
      const days = Array.from(byDay.keys()).sort();
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-60);
      const labels=[], lastArr=[], actualArr=[];
      days.forEach(d=>{
        const dd = new Date(d+'T00:00:00');
        if(dd >= cutoff){
          labels.push(d);
          lastArr.push(byDay.get(d).last?.val ?? null);
          actualArr.push(byDay.get(d).actual ?? null);
        }
      });

      if (chartInstance) { chartInstance.destroy(); chartInstance=null; }
      chartInstance = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Last Forecast', data: lastArr, spanGaps: true, borderWidth: 2, pointRadius: 2, tension: .2 },
            { label: 'Actual High', data: actualArr, spanGaps: true, borderWidth: 2, pointRadius: 2, tension: .2 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: { title: { display: true, text: '¬∞F' } }
          },
          plugins: { legend: { display: true } }
        }
      });
    }

    // -------- Filters
    function applyDateFilter(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      filteredRows = allRows.filter(row=>{
        const date=row.forecast_or_actual==="actual"? row.cli_date : row.target_date;
        if(!date) return false;
        if(from && date<from) return false;
        if(to && date>to) return false;
        return true;
      });
      displayTable(); showStats(); showChart();
    }
    function resetFilter(){
      filteredRows = allRows.slice();
      const f=document.getElementById('fromDate'); if(f) f.value="";
      const t=document.getElementById('toDate'); if(t) t.value="";
      displayTable(); showStats(); showChart();
    }

    // expose for inline handlers
    Object.assign(window,{ applyDateFilter, resetFilter, reloadCSV });
  </script>

  <!-- ===================== AUTH + WATCHDOG ===================== -->
  <script>
  (() => {
    const supabase = window.supabase.createClient(
      "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw"
    );

    function withTimeout(promise, ms, label="op"){
      return new Promise((resolve, reject)=>{
        const t=setTimeout(()=>reject(new Error(`${label} timeout after ${ms}ms`)), ms);
        promise.then(v=>{clearTimeout(t); resolve(v);}, e=>{clearTimeout(t); reject(e);});
      });
    }

    let bootStarted = false;

    // Buttons
    document.getElementById('gate-retry').addEventListener('click', ()=>location.reload());
    document.getElementById('gate-skip').addEventListener('click', ()=>{ try{showApp();}catch{} boot(); });

    // Never get stuck: any global error ‚Üí show UI
    window.addEventListener('error', ()=>{ try{showApp();}catch{} });
    window.addEventListener('unhandledrejection', ()=>{ try{showApp();}catch{} });

    // Watchdog: if nothing happens in 3s, fail-open
    const watchdog = setTimeout(()=>{ if(!bootStarted){ console.warn('watchdog fail-open'); showApp(); boot(); } }, 3000);

    async function boot(){
      bootStarted = true;
      try{
        showTodayDate(); scheduleMidnightUpdate();
        await reloadCSV();
        setInterval(()=>reloadCSV(), 60*1000);
        try{
          localStorage.setItem('dashboard_heartbeat', String(Date.now()));
          setInterval(()=>localStorage.setItem('dashboard_heartbeat', String(Date.now())), 60*1000);
        }catch{}
      }catch(e){ console.warn('boot error (continuing):', e); }
    }

    async function checkAccess(){
      try{
        showGate('Checking access‚Ä¶');

        const { data:{ session }, error:sErr } = await withTimeout(supabase.auth.getSession(), 2500, 'getSession');
        if(sErr) throw new Error(`Auth error: ${sErr.message||'getSession failed'}`);

        if(!session){
          showGate('No session. Redirecting to login‚Ä¶');
          setTimeout(()=>{ window.location.href='login.html'; }, 1200);
          return;
        }

        showGate('Checking subscription‚Ä¶');
        const { data:profile, error } = await withTimeout(
          supabase.from('profiles').select('subscription_status, current_period_end, trial_used').eq('id', session.user.id).single(),
          3000,
          'profiles'
        );

        if(error){
          console.warn('profiles error, fail-open UI:', error);
          showApp(); boot(); setupListeners();
          return;
        }

        const ok = new Set(['active','trialing']).has(profile?.subscription_status ?? 'inactive');
        if(!ok){
          const dest = profile?.trial_used ? 'subscribe.html?reason=trial_expired' : 'subscribe.html';
          showGate('Subscription inactive. Redirecting‚Ä¶');
          setTimeout(()=>{ window.location.href = dest; }, 1200);
          return;
        }

        // ‚úÖ access granted
        showGate('Access granted ‚Äî loading dashboard‚Ä¶');
        showApp(); boot(); setupListeners();

        // background recheck (non-blocking)
        setTimeout(async ()=>{
          try{
            const { data:{ session } } = await supabase.auth.getSession();
            if(!session) return (window.location.href='login.html');
            const { data: p } = await supabase.from('profiles').select('subscription_status, trial_used').eq('id', session.user.id).single();
            const ok2 = new Set(['active','trialing']).has(p?.subscription_status ?? 'inactive');
            if(!ok2){
              window.location.href = p?.trial_used ? 'subscribe.html?reason=trial_expired' : 'subscribe.html';
            }
          }catch{/* keep UI up */}
        }, 15000);

      }catch(e){
        console.error('checkAccess failed:', e);
        showGateError(e.message||'Unexpected error during access check.');
        // still fail-open
        showApp(); boot(); setupListeners();
      }
    }

    function setupListeners(){
      supabase.auth.onAuthStateChange((_event, session)=>{ if(!session) window.location.href='login.html'; });

      document.getElementById('btn-logout')?.addEventListener('click', async ()=>{
        try{
          await supabase.auth.signOut();
          try{ localStorage.removeItem('dashboard_heartbeat'); }catch{}
          window.location.href='login.html';
        }catch{ window.location.href='login.html'; }
      });

      document.getElementById('btn-billing')?.addEventListener('click', async ()=>{
        const { data:{ session } } = await supabase.auth.getSession();
        if(!session) return (window.location.href='login.html');
        try{
          const r = await fetch('/api/create-portal-session', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ supabaseAccessToken: session.access_token }) });
          const j = await r.json();
          if(!r.ok || !j?.url) return alert(j?.error || 'Could not open billing portal');
          window.location.href = j.url;
        }catch{ alert('Could not open billing portal'); }
      });
    }

    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', checkAccess); }
    else { checkAccess(); }
  })();
  </script>
</body>
</html>
