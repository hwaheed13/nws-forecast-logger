<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå°Ô∏è Daily Dew Point Dashboard</title>

  <!-- Performance hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-accent: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --border-subtle: #e2e8f0;
      --border-default: #cbd5e1;
      --accent-blue: #2563eb;
      --accent-blue-light: #dbeafe;
      --accent-green: #059669;
      --accent-green-light: #d1fae5;
      --accent-amber: #d97706;
      --accent-amber-light: #fef3c7;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, .05);
    }

    * { box-sizing: border-box; }

    /* Gate (shows immediately, then hidden on boot) */
    #gate {
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh;
      background: var(--bg-primary); color: var(--text-primary);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      padding: 24px; text-align: center;
    }
    .gate-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle);
      border-radius: 16px; padding: 24px 22px; box-shadow: var(--shadow-sm);
      max-width: 520px; width: 100%;
    }
    .gate-title { font-size: 18px; font-weight: 800; margin: 0 0 6px; }
    .gate-sub { font-size: 14px; color: var(--text-muted); margin: 0 0 12px; }
    .gate-note { font-size: 12px; color: var(--text-light); }
    .gate-spinner { width: 28px; height: 28px; border-radius: 50%;
      border: 3px solid var(--border-subtle); border-top-color: var(--accent-blue);
      margin: 12px auto 8px; animation: spin 1s linear infinite;
    }
    .gate-error { color: #dc2626; font-size: 14px; margin: 12px 0; }
    .gate-btn { 
      background: var(--accent-blue); color: white; border: none; 
      padding: 8px 16px; border-radius: 8px; cursor: pointer; 
      font-size: 14px; margin: 4px;
    }
    body.app-ready #gate { display: none !important; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* App */
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg-primary); color: var(--text-primary);
      margin: 0; line-height: 1.6;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 0; position: sticky; top: 0; z-index: 10; backdrop-filter: blur(8px);
    }
    .header-content { max-width: 1400px; margin: 0 auto; padding: 0 20px;
      display: flex; align-items: center; justify-content: space-between; }
    .brand { display: flex; align-items: center; justify-content: space-between; gap: 14px; }
    .brand-left { display: flex; align-items: center; gap: 12px; }
    .brand-mark { display: grid; place-items: center; width: 40px; height: 40px;
      border-radius: 12px; background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light));
      box-shadow: var(--shadow-sm); border: 1px solid var(--border-subtle); position: relative; top: -3px; }
    .brand-mark svg { display: block; transform: translate(1px, 1px); }
    .brand-title { margin: 0; font-weight: 800; letter-spacing: .2px;
      font-size: 28px; line-height: 1.15; color: var(--text-primary); }
    .brand-title .thin { font-weight: 600; color: var(--text-secondary); }
    .brand-sub { margin: 2px 0 0; font-size: 13px; color: var(--text-muted); }
    .brand-right { display: flex; flex-direction: column; align-items: flex-end; gap: 6px; }
    .brand-right .pill-group { display: flex; gap: 6px; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; font-size: 12px; font-weight: 700;
      color: var(--text-secondary); background: var(--bg-accent); border: 1px solid var(--border-subtle); border-radius: 999px; }
    .pill.live { background: var(--accent-green-light); color: var(--accent-green); border-color: transparent; }
    .pill.live .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .pill.logout-btn { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-default); }

    .container { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .last-update { background: var(--bg-secondary); border: 1px solid var(--border-subtle);
      border-radius: 12px; padding: 18px 20px; margin-bottom: 20px; box-shadow: var(--shadow-sm); }
    .last-update-label { font-size: 12px; color: var(--text-muted); letter-spacing: .06em; text-transform: uppercase; margin-bottom: 4px; font-weight: 600; }
    .last-update-content { font-size: 15px; color: var(--text-secondary); font-weight: 600; }
    #todayDate { display: block; font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 2px; }

    .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px; margin-bottom: 22px; }
    .metric-card { background: var(--bg-secondary); border: 1.5px solid var(--border-subtle); border-radius: 18px; padding: 24px;
      box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
    .metric-card::before { content: ''; position: absolute; inset: 0 0 auto; height: 4px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green)); }
    .metric-card.today-forecast::before { background: var(--accent-amber); }
    .metric-card.today-obs::before { background: var(--accent-blue); }
    .metric-card.today-actual::before { background: var(--accent-green); }
    .metric-card.tomorrow-forecast::before { background: var(--accent-blue); }
    .metric-label { font-size: 14px; color: var(--text-muted); margin-bottom: 6px; font-weight: 700; letter-spacing: .02em; }
    .metric-value { font-size: 36px; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; line-height: 1; }
    .metric-subtitle { font-size: 13px; color: var(--text-light); }
    .mini-forecasts { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .mini-chip { background: var(--bg-accent); color: var(--text-secondary); padding: 4px 10px; border-radius: 999px;
      font-size: 12px; font-weight: 700; border: 1px solid var(--border-subtle); }

    .kalshi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .kalshi-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 22px; }
    .kalshi-badge { background: var(--accent-amber-light); color: var(--accent-amber);
      padding: 8px 14px; border-radius: 999px; font-size: 14px; font-weight: 800; text-decoration: none; display: inline-block; }
    .kalshi-pending { background: var(--bg-accent); color: var(--text-muted); padding: 8px 14px; border-radius: 999px; font-size: 14px; font-weight: 700; border: 2px dashed var(--border-default); }
    .kalshi-note { font-size: 12px; color: var(--text-light); margin-top: 6px; }

    .prediction-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .prediction-card { background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light));
      border: 1px solid var(--border-subtle); border-radius: 16px; padding: 24px; }
    .prediction-title { font-size: 15px; font-weight: 800; margin-bottom: 12px; }
    .prediction-content {}
    .prediction-value { font-size: 28px; font-weight: 800; color: #1f2937; }
    .prediction-subtitle { font-size: 13px; color: var(--text-secondary); }

    .controls-section { background: var(--bg-secondary); border: 1px solid var(--border-subtle);
      border-radius: 16px; padding: 18px; margin-bottom: 22px; }
    .controls-title { font-size: 15px; font-weight: 800; margin-bottom: 10px; }
    .controls { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .control-group { display: flex; align-items: center; gap: 6px; }
    .control-label { font-size: 13px; font-weight: 700; color: var(--text-secondary); }
    input[type="date"] { padding: 8px 10px; border: 1px solid var(--border-default); border-radius: 10px; font-size: 14px; background: var(--bg-secondary); }
    input[type="date"]:focus { outline: none; border-color: var(--accent-blue); box-shadow: 0 0 0 3px var(--accent-blue-light); }
    .btn { background: var(--accent-blue); color: #fff; border: none; border-radius: 10px; padding: 9px 16px; font-size: 14px; font-weight: 800; cursor: pointer; box-shadow: var(--shadow-sm); }
    .btn.secondary { background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-default); }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px; margin-bottom: 22px; }
    .stat-card { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 14px; padding: 18px; text-align: center; }
    .stat-label { font-size: 13px; color: var(--text-muted); font-weight: 700; }
    .stat-value { font-size: 28px; font-weight: 800; color: var(--accent-blue); }

    .chart-section { background: var(--bg-secondary); border: 1px solid var(--border-subtle);
      border-radius: 16px; padding: 24px; margin-bottom: 22px; }
    .chart-title { font-size: 16px; font-weight: 800; margin-bottom: 14px; }
    .chart-container { position: relative; height: clamp(220px, 38vh, 380px); width: 100%; }

    .table-section { background: var(--bg-secondary); border: 1px solid var(--border-subtle); border-radius: 16px; padding: 0; overflow: hidden; }
    .table-container { overflow-x: auto; border-top: 1px solid var(--border-subtle); padding: 0 18px 18px; }
    #dataTable { width: 100%; border-collapse: collapse; font-size: 14px; background: var(--bg-secondary); }
    #dataTable th { background: var(--bg-tertiary); color: var(--text-primary); padding: 12px 10px; text-align: left; font-weight: 800;
      font-size: 12px; letter-spacing: .06em; text-transform: uppercase; border-bottom: 2px solid var(--border-default); position: sticky; top: 0; z-index: 1; }
    #dataTable td { padding: 12px 10px; border-bottom: 1px solid var(--border-subtle); color: var(--text-secondary); }
    #dataTable tbody tr:hover { background: var(--bg-accent); }
    .forecast-row { background: var(--accent-blue-light) !important; }
    .actual-row { background: var(--accent-green-light) !important; }
    .best { box-shadow: inset 0 0 0 2px var(--accent-green); }
    details.table-wrap { border-top: 1px solid var(--border-subtle); }
    details.table-wrap summary { background: var(--bg-accent); border-bottom: 1px solid var(--border-subtle);
      list-style: none; cursor: pointer; padding: 16px 18px; font-weight: 800; display: flex; align-items: center; justify-content: space-between; }
    details.table-wrap summary::-webkit-details-marker { display: none; }
    .caret { transition: transform .2s ease; }
    details[open] summary .caret { transform: rotate(90deg); }
    .skel td::before { content: ""; display: block; height: 12px; margin: 4px 0; width: 70%;
      background: linear-gradient(90deg, var(--bg-accent), var(--bg-tertiary), var(--bg-accent));
      background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

    .footer { margin-top: 28px; padding: 18px 24px; background: var(--bg-tertiary); border-top: 1px solid var(--border-subtle);
      text-align: center; font-size: 12px; color: var(--text-light); }
    .footer a { color: var(--accent-blue); text-decoration: none; }

    /* Month group header row */
    #dataTable tr.month-row { background: var(--bg-tertiary); border-top: 2px solid var(--border-default); cursor: pointer; }
    #dataTable tr.month-row td { font-weight: 800; font-size: 12px; letter-spacing: .06em; text-transform: uppercase;
      color: var(--text-primary); padding: 10px 10px; }
    #dataTable tr.month-row .caret { display: inline-block; transition: transform .18s ease; margin-right: 6px; }
    #dataTable tr.month-row.collapsed .caret { transform: rotate(-90deg); }
    #dataTable tr[data-month].is-hidden { display: none; }

    /* Fluid sizes + mobile */
    .brand-title { font-size: clamp(18px, 2.2vw, 28px); }
    .metric-value { font-size: clamp(22px, 3vw, 36px); }
    .prediction-value { font-size: clamp(20px, 2.6vw, 28px); }
    .stat-value { font-size: clamp(18px, 2.4vw, 28px); }
    .kalshi-badge { font-size: clamp(11px, 1.8vw, 14px); padding: 6px 10px; }
    .pill { font-size: clamp(10px, 1.6vw, 12px); padding: 4px 8px; }

    @media (max-width: 600px) {
      .container { padding: 12px; }
      .header { padding: 12px 0; }
      .brand { gap: 8px; }
      .brand-left { gap: 8px; }
      .brand-mark { width: 32px; height: 32px; border-radius: 10px; top: -17px; }
      .brand-mark svg { width: 28px; height: 28px; transform: translate(0, 0); }
      .brand-sub { font-size: 12px; line-height: 1.35; }
      .brand-right .pill-group { margin-top: -14px; }
      .pill.logout-btn { margin-top: 18px; }
      .metrics-grid, .prediction-grid, .kalshi-grid { grid-template-columns: 1fr; gap: 10px; }
      .metric-card { padding: 14px; border-radius: 14px; }
      .metric-label { font-size: 13px; }
      .metric-subtitle { font-size: 12px; }
      .prediction-card { padding: 14px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
      .stat-card { padding: 10px; }
      .stat-label { font-size: 11px; }
      .stat-value { font-size: 22px; }
      .mini-forecasts { gap: 4px; }
      .mini-chip { font-size: 11px; padding: 3px 8px; }
      .controls-section { padding: 12px; }
      .controls { gap: 8px; }
      .control-label { font-size: 12px; }
      input[type="date"] { font-size: 13px; padding: 7px 8px; border-radius: 8px; }
      .btn { font-size: 13px; padding: 8px 12px; border-radius: 8px; }
      .chart-section { padding: 14px; }
      .chart-title { font-size: 14px; margin-bottom: 10px; }
      .chart-container { height: 260px; }
      .table-container { padding: 0 12px 12px; }
      #dataTable { font-size: 12px; }
      #dataTable th { font-size: 11px; padding: 10px 8px; }
      #dataTable td { padding: 10px 8px; }
      .brand-right { gap: 6px; flex-wrap: wrap; justify-content: flex-start; }
      .pill { flex: 0 1 auto; }
      .pill .dot { width: 5px; height: 5px; }
      .last-update-label { font-size: 10px; }
      .last-update-content { font-size: 13px; line-height: 1.35; }
    }

    @media (min-width: 601px) {
      .pill.logout-btn { margin-top: 10px; background: #e5e7eb; color: var(--text-primary);
        border: 1px solid var(--border-default); font-size: 14px; padding: 8px 14px; border-radius: 12px; }
    }

    .brand-right .pill-sep { flex: 0 0 12px; }

    /* Desktop gutter push + styling for billing/logout */
    @media (min-width: 960px) {
      #btn-billing, #btn-logout {
        position: relative;
        left: calc(max(0px, (100vw - 1400px) / 2 - 12px));
        margin-top: -6px;
      }
      .pill.logout-btn { margin-top: -6px; }
      #btn-billing {
        margin-top: -4px; background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd;
      }
      #btn-billing:hover { background: #bfdbfe; }
    }
    #btn-billing, #btn-logout { cursor: pointer; transition: transform .02s ease, box-shadow .15s ease, opacity .15s ease; }
    #btn-billing:hover, #btn-logout:hover { box-shadow: 0 2px 8px rgba(0,0,0,.08); }
    #btn-billing:active, #btn-logout:active { transform: translateY(1px); opacity: .9; }

    /* 2-col grid on desktop for pills/billing/logout */
    @media (min-width: 960px) {
      .brand-right { display: grid; grid-template-columns: auto auto; column-gap: 12px; row-gap: 10px; align-items: center; justify-items: end; }
      .brand-right .pill-group { grid-column: 1; grid-row: 1; }
      #btn-billing { grid-column: 2; grid-row: 1; }
      #btn-logout { grid-column: 2; grid-row: 2; }
      #btn-billing, #btn-logout { left: calc(max(0px, (100vw - 1400px) / 2 - 6px)); }
      #btn-billing { margin-top: -2px; background: #dbeafe; color: #2563eb; border: 1px solid #93c5fd; }
      #btn-billing:hover { background: #bfdbfe; }
    }

    /* Last update row + badge */
    .lu-top { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:20px; flex-wrap:wrap; }
    .lu-date { display:block; font-size:14px; font-weight:700; color:var(--text-primary); text-transform:uppercase; letter-spacing:.02em; margin-bottom:2px; }
    .lu-badge { white-space:nowrap; font-size:12px; font-weight:800; color:#b91c1c; margin-top:4px; }
    @media (max-width: 600px) {
      .lu-top { gap:6px; margin-bottom:2px; }
      .lu-date { margin-bottom:0; }
      .lu-badge { font-size:10px; white-space:normal; display:block; margin-top:0; text-align:right; }
      .last-update-label { font-size:11px; }
    }
    @media (max-width: 600px) {
      .last-update .lu-badge { display:block; margin-top:-6px; }
    }

    /* Tooltip */
    .tip { display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; border-radius:50%;
      font-size:11px; font-weight:800; line-height:1; cursor:help;
      border:1px solid var(--border-default); color:var(--text-secondary);
      background:var(--bg-tertiary); margin-left:6px; position:relative; outline:none; }
    .tip:hover { box-shadow: 0 1px 6px rgba(0,0,0,.08); }
    .tip:focus-visible { box-shadow: 0 0 0 3px var(--accent-blue-light); }
    .tip[data-tip]::after{
      content:attr(data-tip); position:absolute; inset:auto auto calc(100% + 8px) 50%; transform:translateX(-50%);
      white-space:nowrap; background:#111827; color:#fff; font-size:12px; font-weight:600; padding:6px 8px; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,.15); opacity:0; pointer-events:none; transition:opacity .12s ease, transform .12s ease;
    }
    .tip[data-tip]::before{
      content:""; position:absolute; inset:auto auto calc(100% + 3px) 50%; transform:translateX(-50%);
      border:6px solid transparent; border-top-color:#111827; opacity:0; transition:opacity .12s ease;
    }
    .tip:hover[data-tip]::after,.tip:focus[data-tip]::after,.tip:hover[data-tip]::before,.tip:focus[data-tip]::before{opacity:1;}
  </style>
</head>

<body>
  <!-- ====== LOGIN GATE ====== -->
  <div id="gate" role="status" aria-live="polite">
    <div class="gate-card">
      <div class="gate-title">Checking access‚Ä¶</div>
      <div class="gate-sub">Loading the dashboard.</div>
      <div class="gate-spinner" aria-hidden="true"></div>
      <div class="gate-note">This will update automatically.</div>
      <div id="gate-error" class="gate-error" style="display: none;"></div>
      <div>
        <button id="gate-retry" class="gate-btn" style="display: none;">Retry</button>
        <button id="gate-skip" class="gate-btn" style="display: none;">Skip to Dashboard</button>
      </div>
    </div>
  </div>

  <!-- ====== APP ====== -->
  <div id="app" style="display:none">
    <header class="header">
      <div class="header-content brand">
        <div class="brand-left">
          <div class="brand-mark" aria-hidden="true">
            <svg viewBox="0 0 64 64" width="38" height="38" role="img">
              <defs>
                <linearGradient id="dpGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stop-color="var(--accent-blue)" />
                  <stop offset="100%" stop-color="var(--accent-green)" />
                </linearGradient>
              </defs>
              <path fill="url(#dpGrad)" d="M32 6c6 10 16 18 16 30 0 9.94-8.06 18-18 18s-18-8.06-18-18C12 24 26 16 32 6z"/>
            </svg>
          </div>
          <div class="brand-copy">
            <h1 class="brand-title"><span class="thin">Daily</span> Dew&nbsp;Point</h1>
            <p class="brand-sub">Automatically logs every NWS forecast update for Central Park and compares to the official daily high</p>
          </div>
        </div>
        <div class="brand-right">
          <div class="pill-group">
            <span class="pill live"><span class="dot"></span> Live</span>
            <span class="pill">NYC</span>
            <span class="pill">KNYC</span>
          </div>
          <button id="btn-billing" class="pill">Manage billing</button>
          <button id="btn-logout" class="pill logout-btn">Log out</button>
        </div>
      </div>
    </header>

    <div class="container">
      <div class="last-update">
        <div class="lu-top">
          <span id="todayDate" class="lu-date"></span>
          <span class="lu-badge">All times and day boundary are Eastern Time (aligned with NWS)</span>
        </div>
        <div class="last-update-label">Latest Forecast Update</div>
        <div id="recentForecast" class="last-update-content">Loading latest forecast data...</div>
      </div>

      <!-- Metrics -->
      <div class="metrics-grid">
        <div class="metric-card today-forecast">
          <div class="metric-label">Today's Latest Forecast</div>
          <div id="box-today-forecast" class="metric-value">‚Äì</div>
          <div class="metric-subtitle">Today's Forecasts</div>
          <div id="mini-today-forecasts" class="mini-forecasts"></div>
        </div>

        <div class="metric-card today-actual">
          <div class="metric-label">Today's High (DSM)</div>
          <div id="box-dsm-max" class="metric-value">‚Äì</div>
          <div id="box-dsm-note" class="metric-subtitle"></div>
          <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
            <div class="metric-label" style="margin-bottom:6px;">Today's Actual High (CLI)</div>
            <div id="box-today-actual" class="metric-value">‚Äì</div>
            <div id="box-today-actual-note" class="metric-subtitle">NWS daily climatological report</div>
          </div>
        </div>

        <div class="metric-card today-obs">
          <div class="metric-label">6 Hr Max</div>
          <div id="box-6hr-max" class="metric-value">‚Äì</div>
          <div id="box-6hr-max-note" class="metric-subtitle"></div>
          <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
            <div class="metric-label">Recent Observed Temperature</div>
            <div id="box-today-current" class="metric-value">‚Äì</div>
            <div id="box-today-current-note" class="metric-subtitle"></div>
          </div>
        </div>

        <div class="metric-card tomorrow-forecast">
          <div class="metric-label">Tomorrow's Latest Forecast</div>
          <div id="box-tomorrow-forecast" class="metric-value">‚Äì</div>
          <div class="metric-subtitle">Tomorrow's Forecasts</div>
          <div id="mini-tomorrow-forecasts" class="mini-forecasts"></div>
        </div>
      </div>

      <!-- Bias-corrected -->
      <div class="prediction-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:18px; margin-bottom:22px;">
        <div class="prediction-card">
          <div class="prediction-title">
            Today's Bias-Corrected Prediction
            <span class="tip" tabindex="0" data-tip="Shows today's forecast, using yesterday's last update until today's forecasts begin">i</span>
          </div>
          <div id="correctionBoxToday" class="prediction-content">Loading...</div>
        </div>
        <div class="prediction-card">
          <div class="prediction-title">
            Tomorrow's Bias-Corrected Prediction
            <span class="tip" tabindex="0" data-tip="Shows tomorrow's forecast using today's updates. Once tomorrow begins, new forecasts are tracked as that day's forecasts">i</span>
          </div>
          <div id="correctionBoxTomorrow" class="prediction-content">Loading...</div>
        </div>
        <div style="grid-column:1 / span 2; font-size:12px; color:var(--text-light); margin-top:-4px;">
          Based on historical forecast accuracy patterns; updates as new forecasts arrive
        </div>
      </div>

      <!-- Kalshi -->
      <div class="kalshi-grid">
        <div class="kalshi-card">
          <div class="metric-label">Today's Kalshi Market</div>
          <div id="box-today-kalshi" class="metric-value" style="font-size:18px;">Pending settlement</div>
          <div id="box-today-kalshi-note" class="kalshi-note"></div>
        </div>
        <div class="kalshi-card">
          <div class="metric-label">Yesterday's Kalshi Result</div>
          <div id="box-yday-kalshi" class="metric-value" style="font-size:18px;">‚Äì</div>
          <div id="box-yday-kalshi-note" class="kalshi-note"></div>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls-section">
        <div class="controls-title">Filter Data</div>
        <div class="controls">
          <div class="control-group">
            <label class="control-label" for="fromDate">From:</label>
            <input type="date" id="fromDate"/>
          </div>
          <div class="control-group">
            <label class="control-label" for="toDate">To:</label>
            <input type="date" id="toDate"/>
          </div>
          <button class="btn" onclick="applyDateFilter()">Apply Filter</button>
          <button class="btn secondary" onclick="resetFilter()">Show All</button>
          <button class="btn secondary" onclick="reloadCSV()">Refresh Data</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="stats">
        <div class="stat-card">
          <div class="stat-label">Days Tracked</div>
          <div class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Days With Actual</div>
          <div class="stat-value">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Absolute Error</div>
          <div class="stat-value">--¬∞F</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Best Error</div>
          <div class="stat-value">--¬∞F</div>
        </div>
      </div>

      <!-- Chart -->
      <div class="chart-section">
        <div class="chart-title">Temperature Trends: Actual vs Predicted</div>
        <div class="chart-container">
          <canvas id="dailyChart" width="1000" height="380"></canvas>
        </div>
      </div>

      <!-- Collapsible Table -->
      <div class="table-section">
        <details class="table-wrap">
          <summary>
            <span>Detailed Forecast Log</span>
            <span class="caret">‚ñ∏</span>
          </summary>
          <div class="table-container">
            <table id="dataTable">
              <thead>
                <tr>
                  <th>Date Pulled</th>
                  <th>Forecast Time</th>
                  <th>For Date</th>
                  <th>Forecasted High</th>
                  <th>Actual High</th>
                  <th>High Time</th>
                  <th>Error (¬∞F)</th>
                  <th>Best?</th>
                  <th>Kalshi Range</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>

    <footer class="footer">
      ¬© 2025 Dewdrop Ventures, LLC ¬∑
      <a href="/terms.html">Terms</a> ¬∑
      <a href="/privacy.html">Privacy</a> ¬∑
      <span>Informational only ‚Äî not financial advice. Do your own due diligence before placing any bets or making financial decisions.</span>
    </footer>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- App scripts -->
  <script>
    console.log('Script starting...');
    
    /* ========= SIMPLE GATE FUNCTIONS - DEFINE FIRST ========= */
    function showApp(){
      console.log('showApp() called');
      const g = document.getElementById('gate'), a = document.getElementById('app');
      try { document.body.classList.add('app-ready'); } catch {}
      if (a && getComputedStyle(a).display === 'none') a.style.display = '';
      if (g && getComputedStyle(g).display !== 'none') g.style.display = 'none';
    }

    function showGate(msg){ 
      console.log('showGate:', msg);
      const g=document.getElementById('gate'); 
      if(!g) return; 
      g.style.display=''; 
      const sub=g.querySelector('.gate-sub'); 
      if(sub&&msg) sub.textContent=msg; 
    }

    function showError(message, showButtons = true) {
      console.error('Gate error:', message);
      const errorEl = document.getElementById('gate-error');
      const retryBtn = document.getElementById('gate-retry');
      const skipBtn = document.getElementById('gate-skip');
      const spinner = document.querySelector('.gate-spinner');
      
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
      if (spinner) spinner.style.display = 'none';
      if (showButtons) {
        if (retryBtn) retryBtn.style.display = 'inline-block';
        if (skipBtn) skipBtn.style.display = 'inline-block';
      }
    }

    /* ========= ORIGINAL DASHBOARD DATA + UI FUNCTIONS ========= */
    let allRows = [], filteredRows = [], chartInstance = null;

    // === Header date (ET) ===
    function showTodayDate() {
      const el = document.getElementById('todayDate');
      if (!el) return;
      const label = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/New_York',
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      }).format(new Date());
      el.textContent = label;
    }
    
    function scheduleMidnightUpdate() {
      showTodayDate();
      setInterval(showTodayDate, 60 * 1000);
    }

    // Date helpers
    function nycISODate(offsetDays = 0) {
      const fmt = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/New_York', year: 'numeric', month: '2-digit', day: '2-digit'
      });
      const parts = fmt.formatToParts(new Date(Date.now() + offsetDays * 86400000));
      const g = k => parts.find(p => p.type === k).value;
      return `${g('year')}-${g('month')}-${g('day')}`;
    }

    // CSV parsing
    function csvToRows(text) {
      const rows = [];
      let row = [], field = '', q = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i + 1];
        if (c === '"') {
          if (q && n === '"') { field += '"'; i++; } else q = !q;
        } else if (c === ',' && !q) {
          row.push(field); field = '';
        } else if ((c === '\n' || c === '\r') && !q) {
          if (c === '\r' && n === '\n') i++;
          row.push(field); field = '';
          if (row.length && row.some(x => x !== '')) rows.push(row);
          row = [];
        } else field += c;
      }
      if (field !== '' || row.length) {
        row.push(field);
        if (row.length && row.some(x => x !== '')) rows.push(row);
      }
      return rows;
    }

    function parseCSV(text) {
      const rows = csvToRows(text);
      if (!rows.length) return;
      const header = rows[0].map(h => h.trim());
      allRows = [];
      for (let i = 1; i < rows.length; i++) {
        const vals = rows[i];
        const rec = {};
        for (let j = 0; j < header.length; j++) {
          let v = (vals[j] ?? '').trim();
          if (v.startsWith('"') && v.endsWith('"')) v = v.slice(1, -1).replace(/""/g, '"');
          rec[header[j]] = v;
        }
        allRows.push(rec);
      }
    }

    // Network constants
    const CSV_URL = "https://raw.githubusercontent.com/hwaheed13/nws-forecast-logger/main/nws_forecast_log.csv";
    const API_BASE = "/api";

    // Simple data loading
    function reloadCSV() {
      console.log('Loading CSV data...');
      return fetch(CSV_URL + "?" + Date.now())
        .then(r => r.text())
        .then(parseCSV)
        .then(() => {
          filteredRows = allRows.slice();
          showMostRecent();
          updateSummaryBoxes();
          console.log('CSV data loaded, rows:', allRows.length);
        })
        .catch(err => {
          console.error("Could not load CSV:", err);
          document.getElementById('recentForecast').textContent = 'Error loading data';
        });
    }

    // Basic UI updates
    function showMostRecent() {
      const el = document.getElementById("recentForecast");
      if (!el) return;
      if (!allRows.length) { 
        el.textContent = "No data available"; 
        return; 
      }

      for (let i = allRows.length - 1; i >= 0; i--) {
        const r = allRows[i];
        if (r && r.forecast_or_actual === "forecast" && r.predicted_high && r.target_date) {
          const date = (r.timestamp || r.forecast_time || "").slice(0, 10);
          const time = (r.timestamp || r.forecast_time || "").slice(11, 16);
          el.innerHTML = `<strong>${date} ${time}</strong> ‚Äî <strong>${r.predicted_high}¬∞F</strong> for <strong>${r.target_date}</strong>`;
          return;
        }
      }
      el.textContent = "No recent forecasts found";
    }

    function updateSummaryBoxes() {
      const today = nycISODate(0);
      const tomorrow = nycISODate(1);

      const latestForDate = (date) => {
        const rows = allRows
          .filter(r => r.forecast_or_actual === "forecast" && r.target_date === date && r.predicted_high);
        if (!rows.length) return null;
        rows.sort((a, b) => {
          const A = a.timestamp || a.forecast_time || "";
          const B = b.timestamp || b.forecast_time || "";
          return B.localeCompare(A);
        });
        return Number(rows[0].predicted_high);
      };

      const tLatest = latestForDate(today);
      const tmLatest = latestForDate(tomorrow);
      const tActRow = allRows.find(r => r.forecast_or_actual === "actual" && r.cli_date === today && r.actual_high);
      const tActual = tActRow ? Number(tActRow.actual_high) : null;

      const e = (id) => document.getElementById(id);
      if (e("box-today-forecast")) e("box-today-forecast").textContent = (tLatest == null) ? "‚Äì" : `${tLatest.toFixed(0)}¬∞F`;
      if (e("box-today-actual")) e("box-today-actual").textContent = (tActual == null) ? "‚Äì" : `${tActual.toFixed(0)}¬∞F`;
      if (e("box-tomorrow-forecast")) e("box-tomorrow-forecast").textContent = (tmLatest == null) ? "‚Äì" : `${tmLatest.toFixed(0)}¬∞F`;
      
      // Mini forecast chips
      renderMiniForecastChips(getForecastsForDate(today), "mini-today-forecasts");
      renderMiniForecastChips(getForecastsForDate(tomorrow), "mini-tomorrow-forecasts");
    }

    function getForecastsForDate(dateISO) {
      const rows = allRows
        .filter(r => r.forecast_or_actual === "forecast" && r.target_date === dateISO && r.predicted_high)
        .map(r => ({
          tstamp: r.timestamp || r.forecast_time || "",
          timeHHMM: (r.forecast_time || "").substr(11, 5),
          val: Number(r.predicted_high)
        }))
        .filter(x => Number.isFinite(x.val));
      rows.sort((a, b) => (a.tstamp || "").localeCompare(b.tstamp || ""));
      return rows;
    }

    function renderMiniForecastChips(rows, elId) {
      const host = document.getElementById(elId);
      if (!host) return;
      host.innerHTML = "";
      const compact = [];
      rows.forEach((r, i) => {
        if (i === 0 || r.val !== rows[i - 1].val) compact.push(r);
      });
      if (!compact.length) {
        host.innerHTML = `<span class="mini-chip">No forecasts yet</span>`;
        return;
      }
      compact.forEach(r => {
        const label = `${r.timeHHMM || "‚Äî"}, ${r.val.toFixed(0)}¬∞`;
        const chip = document.createElement("span");
        chip.className = "mini-chip";
        chip.textContent = label;
        host.appendChild(chip);
      });
    }

    // Filter functions
    function applyDateFilter() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      filteredRows = allRows.filter(row => {
        const date = row.forecast_or_actual === "actual" ? row.cli_date : row.target_date;
        if (!date) return false;
        if (from && date < from) return false;
        if (to && date > to) return false;
        return true;
      });
      console.log('Filter applied, showing', filteredRows.length, 'of', allRows.length, 'rows');
    }

    function resetFilter() {
      filteredRows = allRows.slice();
      const f = document.getElementById('fromDate'); if (f) f.value = "";
      const t = document.getElementById('toDate'); if (t) t.value = "";
      console.log('Filter reset');
    }

    // Placeholder functions for complex features
    function updateCorrectionBoxes() {
      const todayBox = document.getElementById("correctionBoxToday");
      const tmrwBox = document.getElementById("correctionBoxTomorrow");
      if (todayBox) todayBox.innerHTML = '<div class="prediction-value">Loading...</div>';
      if (tmrwBox) tmrwBox.innerHTML = '<div class="prediction-value">Loading...</div>';
    }

    /* ========= AUTH CHECK WITH TIMEOUT ========= */
    function withTimeout(promise, ms, label = "operation") {
      return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
          reject(new Error(`${label} timed out after ${ms}ms`));
        }, ms);
        
        promise.then(
          value => {
            clearTimeout(timer);
            resolve(value);
          },
          error => {
            clearTimeout(timer);
            reject(error);
          }
        );
      });
    }

    async function checkAccess() {
      console.log('checkAccess() starting');
      
      try {
        showGate('Initializing Supabase...');
        
        // Check if Supabase is available
        if (typeof window.supabase === 'undefined') {
          throw new Error('Supabase library not loaded');
        }

        const supabase = window.supabase.createClient(
          "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw"
        );

        showGate('Checking session...');
        
        // Get session with timeout
        const { data: { session }, error: sessionError } = await withTimeout(
          supabase.auth.getSession(),
          8000,
          'getSession'
        );

        if (sessionError) {
          console.error('Session error:', sessionError);
          throw new Error(`Session error: ${sessionError.message}`);
        }

        if (!session) {
          console.log('No session found, redirecting to login');
          showGate('No session found. Redirecting to login...');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 2000);
          return;
        }

        console.log('Session found:', session.user.id);
        showGate('Checking subscription...');

        // Check subscription with timeout
        const { data: profile, error: profileError } = await withTimeout(
          supabase
            .from('profiles')
            .select('subscription_status, current_period_end, trial_used')
            .eq('id', session.user.id)
            .single(),
          8000,
          'profile check'
        );

        if (profileError) {
          console.error('Profile error:', profileError);
          // Don't fail hard on profile errors - might be network issue
          showGate('Profile check failed, proceeding anyway...');
          setTimeout(() => {
            showApp();
            bootApp();
          }, 1000);
          return;
        }

        const status = profile?.subscription_status || 'inactive';
        console.log('Subscription status:', status);

        if (!['active', 'trialing'].includes(status)) {
          const redirectUrl = profile?.trial_used 
            ? 'subscribe.html?reason=trial_expired' 
            : 'subscribe.html';
          
          showGate('Subscription inactive. Redirecting...');
          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 2000);
          return;
        }

        // Success!
        console.log('Access granted');
        showGate('Access granted! Loading dashboard...');
        setTimeout(() => {
          showApp();
          bootApp();
          setupEventListeners(supabase);
        }, 500);

      } catch (error) {
        console.error('Access check failed:', error);
        showError(`Access check failed: ${error.message}`, true);
      }
    }

    function setupEventListeners(supabase) {
      console.log('Setting up event listeners...');
      
      // Setup logout button
      const logoutBtn = document.getElementById('btn-logout');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
          console.log('Logout clicked');
          try {
            await supabase.auth.signOut();
            localStorage.removeItem('dashboard_heartbeat');
            window.location.href = 'login.html';
          } catch (error) {
            console.error('Logout error:', error);
            window.location.href = 'login.html';
          }
        });
      }

      // Setup billing button  
      const billingBtn = document.getElementById('btn-billing');
      if (billingBtn) {
        billingBtn.addEventListener('click', async () => {
          console.log('Billing clicked');
          try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
              window.location.href = 'login.html';
              return;
            }

            const response = await fetch('/api/create-portal-session', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                supabaseAccessToken: session.access_token
              })
            });

            const data = await response.json();
            if (response.ok && data.url) {
              window.location.href = data.url;
            } else {
              alert(data.error || 'Could not open billing portal');
            }
          } catch (error) {
            console.error('Billing error:', error);
            alert('Could not open billing portal');
          }
        });
      }
    }

    async function bootApp() {
      console.log('Booting app...');
      showTodayDate();
      scheduleMidnightUpdate();
      
      await reloadCSV();
      updateCorrectionBoxes();
      
      // Set up periodic updates
      setInterval(() => reloadCSV(), 60 * 1000);
      
      try {
        localStorage.setItem("dashboard_heartbeat", String(Date.now()));
        setInterval(() => localStorage.setItem("dashboard_heartbeat", String(Date.now())), 60 * 1000);
      } catch {}
    }

    // Button event listeners (set up immediately)
    document.addEventListener('DOMContentLoaded', () => {
      const retryBtn = document.getElementById('gate-retry');
      const skipBtn = document.getElementById('gate-skip');
      
      if (retryBtn) {
        retryBtn.addEventListener('click', () => {
          console.log('Retry clicked');
          location.reload();
        });
      }
      
      if (skipBtn) {
        skipBtn.addEventListener('click', () => {
          console.log('Skip clicked');
          showApp();
          bootApp();
        });
      }
    });

    // Fail-safe mechanisms
    window.addEventListener('error', (event) => {
      console.error('Global error:', event.error);
      const app = document.getElementById('app');
      if (app && app.style.display === 'none') {
        showError('An error occurred. Try refreshing the page.');
      }
    });

    setTimeout(() => {
      const app = document.getElementById('app');
      if (app && app.style.display === 'none') {
        console.warn('Fail-safe: showing app after 15 seconds');
        showError('Taking longer than expected. You can skip to the dashboard.', true);
      }
    }, 15000);

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAccess);
    } else {
      checkAccess();
    }

    console.log('Script loaded successfully');
  </script>
</body>
</html>
