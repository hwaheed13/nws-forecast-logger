<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå°Ô∏è Daily Dew Point Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg-primary:#fafbfc; --bg-secondary:#ffffff; --bg-tertiary:#f8f9fa; --bg-accent:#f1f5f9;
      --text-primary:#0f172a; --text-secondary:#334155; --text-muted:#64748b; --text-light:#94a3b8;
      --border-subtle:#e2e8f0; --border-default:#cbd5e1;
      --accent-blue:#2563eb; --accent-blue-light:#dbeafe;
      --accent-green:#059669; --accent-green-light:#d1fae5;
      --accent-amber:#d97706; --accent-amber-light:#fef3c7;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);
      --shadow-md:0 6px 18px rgba(0,0,0,.08);
      --radius-sm:10px; --radius-md:12px; --radius-lg:16px;
	    }
	    *{box-sizing:border-box}
	    body{
	      font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif;
	      background:var(--bg-primary); color:var(--text-primary); margin:0; line-height:1.6;
	      font-feature-settings:"tnum" 1,"lnum" 1;
	    }
	    .header{background:var(--bg-secondary); border-bottom:1px solid var(--border-subtle); padding:20px 0; position:sticky; top:0; z-index:10; backdrop-filter:blur(8px)}
	    .header-content{max-width:1400px; margin:0 auto; padding:0 20px; display:flex; align-items:center; justify-content:space-between}
	    .logo-section{display:flex; align-items:center; gap:12px}
	  .logo-icon {
	  font-size: 38px;
	  background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
	  -webkit-background-clip: text;
	  -webkit-text-fill-color: transparent;
	  background-clip: text;
	  text-shadow: 0 2px 6px rgba(0,0,0,0.08);
	}
   /* Brand header layout */
	.brand {
	  display: flex;
	  align-items: center;
	  justify-content: space-between;
	  gap: 14px;
	}
	.brand-left { display: flex; align-items: center; gap: 12px; }
	
	/* Mark */
	.brand-mark {
	  display: grid; 
	  place-items: center;
	  width: 40px; 
	  height: 40px;
	  border-radius: 12px;
	  background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light));
	  box-shadow: var(--shadow-sm);
	  border: 1px solid var(--border-subtle);
	  position: relative;
	  top: -3px;   /* nudge the whole square upward */
	}
	
	/* Adjust the drop itself inside the box */
	.brand-mark svg {
	  display: block;
	  transform: translate(1px, 1px); /* move right 2px, up 1px */
	}

	/* Wordmark */
	.brand-title {
	  margin: 0;
	  font-weight: 800;
	  letter-spacing: .2px;
	  font-size: 28px;
	  line-height: 1.15;
	  color: var(--text-primary);
	}
	.brand-title .thin { font-weight: 600; color: var(--text-secondary); }
	.brand-sub {
	  margin: 2px 0 0;
	  font-size: 13px;
	  color: var(--text-muted);
	}
	
	/* Meta pills */
	.brand-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
	.pill {
	  display: inline-flex; align-items: center; gap: 6px;
	  padding: 6px 10px;
	  font-size: 12px; font-weight: 700;
	  color: var(--text-secondary);
	  background: var(--bg-accent);
	  border: 1px solid var(--border-subtle);
	  border-radius: 999px;
	}
	.pill.live { 
	  background: var(--accent-green-light);
	  color: var(--accent-green);
	  border-color: transparent;
	}
	.pill.live .dot {
	  width: 6px; height: 6px; border-radius: 50%;
	  background: var(--accent-green);
	  animation: pulse 2s infinite;
	}
	
	/* Mobile tweaks */
	@media (max-width: 768px){
	  .brand { flex-direction: column; align-items: flex-start; gap: 10px; }
	  .brand-right { gap: 6px; }
	  .brand-title { font-size: 22px; }
	}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    .container{max-width:1400px;margin:0 auto;padding:24px}
    .last-update{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:18px 20px; margin-bottom:20px; box-shadow:var(--shadow-sm)}
    .last-update-label{font-size:12px; color:var(--text-muted); letter-spacing:.06em; text-transform:uppercase; margin-bottom:4px; font-weight:600}
    .last-update-content{font-size:15px; color:var(--text-secondary); font-weight:600}

    .metrics-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:18px; margin-bottom:22px}
    .metric-card{background:var(--bg-secondary); border:1.5px solid var(--border-subtle); border-radius:18px; padding:24px; box-shadow:var(--shadow-sm); position:relative; overflow:hidden}
    .metric-card::before{content:''; position:absolute; inset:0 0 auto; height:4px; background:linear-gradient(90deg,var(--accent-blue),var(--accent-green))}
    .metric-card.today-forecast::before{background:var(--accent-amber)}
    .metric-card.today-obs::before{background:var(--accent-blue)}
    .metric-card.today-actual::before{background:var(--accent-green)}
    .metric-card.tomorrow-forecast::before{background:var(--accent-blue)}

    .metric-label{font-size:14px; color:var(--text-muted); margin-bottom:6px; font-weight:700; letter-spacing:.02em}
    .metric-value{font-size:36px; font-weight:800; color:var(--text-primary); margin-bottom:10px; line-height:1}
    .metric-subtitle{font-size:13px; color:var(--text-light)}
    .mini-forecasts{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
    .mini-chip{background:var(--bg-accent); color:var(--text-secondary); padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--border-subtle)}
    .sparkline-container{height:40px; margin-top:8px}
    .sparkline{width:100%; height:40px; display:block}

    .kalshi-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:18px; margin-bottom:22px}
    .kalshi-card{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:22px}
    .kalshi-badge{background:var(--accent-amber-light); color:var(--accent-amber); padding:8px 14px; border-radius:999px; font-size:14px; font-weight:800; text-decoration:none; display:inline-block}
    .kalshi-pending{background:var(--bg-accent); color:var(--text-muted); padding:8px 14px; border-radius:999px; font-size:14px; font-weight:700; border:2px dashed var(--border-default)}
    .kalshi-note{font-size:12px; color:var(--text-light); margin-top:6px}

    .prediction-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(360px,1fr)); gap:18px; margin-bottom:22px}
    .prediction-card{background:linear-gradient(135deg,var(--accent-blue-light),var(--accent-green-light)); border:1px solid var(--border-subtle); border-radius:16px; padding:24px}
    .prediction-title{font-size:15px; font-weight:800; margin-bottom:12px}
    .prediction-value{font-size:28px; font-weight:800; color:#1f2937}
    .prediction-subtitle{font-size:13px; color:var(--text-secondary)}

    .controls-section{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:18px; margin-bottom:22px}
    .controls-title{font-size:15px; font-weight:800; margin-bottom:10px}
    .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
    .control-group{display:flex; align-items:center; gap:6px}
    .control-label{font-size:13px; font-weight:700; color:var(--text-secondary)}
    input[type="date"]{padding:8px 10px; border:1px solid var(--border-default); border-radius:10px; font-size:14px; background:var(--bg-secondary)}
    input[type="date"]:focus{outline:none; border-color:var(--accent-blue); box-shadow:0 0 0 3px var(--accent-blue-light)}
    .btn{background:var(--accent-blue); color:#fff; border:none; border-radius:10px; padding:9px 16px; font-size:14px; font-weight:800; cursor:pointer; box-shadow:var(--shadow-sm)}
    .btn.secondary{background:var(--bg-tertiary); color:var(--text-secondary); border:1px solid var(--border-default)}

    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; margin-bottom:22px}
    .stat-card{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:14px; padding:18px; text-align:center}
    .stat-label{font-size:13px; color:var(--text-muted); font-weight:700}
    .stat-value{font-size:28px; font-weight:800; color:var(--accent-blue)}

    .chart-section{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:24px; margin-bottom:22px}
    .chart-title{font-size:16px; font-weight:800; margin-bottom:14px}
    .chart-container{position:relative; height:380px; width:100%}

    .table-section{background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:16px; padding:0; overflow:hidden}
    .table-title{font-size:16px; font-weight:800; margin:0; padding:16px 18px}
    .table-container{overflow-x:auto; border-top:1px solid var(--border-subtle); padding:0 18px 18px}
    #dataTable{width:100%; border-collapse:collapse; font-size:14px; background:var(--bg-secondary)}
    #dataTable th{background:var(--bg-tertiary); color:var(--text-primary); padding:12px 10px; text-align:left; font-weight:800; font-size:12px; letter-spacing:.06em; text-transform:uppercase; border-bottom:2px solid var(--border-default); position:sticky; top:0; z-index:1}
    #dataTable td{padding:12px 10px; border-bottom:1px solid var(--border-subtle); color:var(--text-secondary)}
    #dataTable tbody tr:hover{background:var(--bg-accent)}
    .forecast-row{background:var(--accent-blue-light) !important}
    .actual-row{background:var(--accent-green-light) !important}
    .best{box-shadow:inset 0 0 0 2px var(--accent-green)}
	details.table-wrap summary {
	  background: var(--bg-accent); /* or var(--accent-blue-light) */
	  border-bottom: 1px solid var(--border-subtle);
	  border-top-left-radius: 16px;
	  border-top-right-radius: 16px;
	}

    .skel td::before{content:""; display:block; height:12px; margin:4px 0; width:70%; background:linear-gradient(90deg,var(--bg-accent),var(--bg-tertiary),var(--bg-accent)); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:4px}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}

    .footer{margin-top:28px; padding:18px 24px; background:var(--bg-tertiary); border-top:1px solid var(--border-subtle); text-align:center; font-size:12px; color:var(--text-light)}
    .footer a{color:var(--accent-blue); text-decoration:none}

    /* Collapsible table for mobile */
    details.table-wrap{border-top:1px solid var(--border-subtle)}
    details.table-wrap summary{
      list-style:none; cursor:pointer; padding:16px 18px; font-weight:800; display:flex; align-items:center; justify-content:space-between
    }
    details.table-wrap summary::-webkit-details-marker{display:none}
    .caret{transition:transform .2s ease}
    details[open] .caret{transform:rotate(90deg)}

    /* Mobile tweaks */
    @media (max-width: 768px){
      .container{padding:16px}
      .metrics-grid{grid-template-columns:1fr; gap:12px}
      .metric-card{padding:18px; border-radius:16px}
      .metric-label{font-size:15px}
      .metric-value{font-size:34px}
      .prediction-grid{grid-template-columns:1fr}
      .kalshi-grid{grid-template-columns:1fr}
      .chart-container{height:320px}
      .header-content{flex-direction:column; gap:8px}
    }
 /* === Fluid sizing (works on all viewports) === */
.brand-title        { font-size: clamp(18px, 2.2vw, 28px); }
.metric-value       { font-size: clamp(22px, 3vw, 36px); }
.prediction-value   { font-size: clamp(20px, 2.6vw, 28px); }
.stat-value         { font-size: clamp(18px, 2.4vw, 28px); }
.kalshi-badge       { font-size: clamp(11px, 1.8vw, 14px); padding: 6px 10px; }
.pill               { font-size: clamp(10px, 1.6vw, 12px); padding: 4px 8px; }

/* Make the main chart height fluid instead of fixed */
.chart-container { height: clamp(220px, 38vh, 380px); }

/* === Phone tweaks (‚â§ 600px) === */
@media (max-width: 600px) {
  .container        { padding: 12px; }
  .header           { padding: 12px 0; }
  .header-content   { gap: 6px; }

  /* Brand block */
  .brand            { gap: 8px; }
  .brand-left       { gap: 8px; }
  .brand-mark       { width: 32px; height: 32px; border-radius: 10px; top: -2px; }
  .brand-mark svg   { width: 28px; height: 28px; transform: translate(0, 0); }
  .brand-sub        { font-size: 12px; line-height: 1.35; }

  /* Cards & grids */
  .metrics-grid,
  .prediction-grid,
  .kalshi-grid      { grid-template-columns: 1fr; gap: 10px; }
  .metric-card      { padding: 14px; border-radius: 14px; }
  .metric-label     { font-size: 13px; }
  .metric-value     { line-height: 1.05; }
  .metric-subtitle  { font-size: 12px; }
  .prediction-card  { padding: 14px; }

  /* ‚úÖ Stats: 2 per row */
  .stats-grid       { grid-template-columns: repeat(2, 1fr); gap: 8px; }
  .stat-card        { padding: 10px; }
  .stat-label       { font-size: 11px; }
  .stat-value       { font-size: 22px; }

  /* Mini forecast chips */
  .mini-forecasts   { gap: 4px; }
  .mini-chip        { font-size: 11px; padding: 3px 8px; }

  /* Controls */
  .controls-section { padding: 12px; }
  .controls         { gap: 8px; }
  .control-label    { font-size: 12px; }
  input[type="date"]{ font-size: 13px; padding: 7px 8px; border-radius: 8px; }
  .btn              { font-size: 13px; padding: 8px 12px; border-radius: 8px; }

  /* Chart */
  .chart-section    { padding: 14px; }
  .chart-title      { font-size: 14px; margin-bottom: 10px; }
  .chart-container  { height: 260px; }

  /* Table */
  .table-title      { font-size: 14px; padding: 12px 14px; }
  .table-container  { padding: 0 12px 12px; }
  #dataTable        { font-size: 12px; }
  #dataTable th     { font-size: 11px; padding: 10px 8px; }
  #dataTable td     { padding: 10px 8px; }

  /* Pills (top-right) */
  .brand-right      { gap: 6px; }
  .pill .dot        { width: 5px; height: 5px; }
}


/* === Small phones (‚â§ 400px) ‚Äî nudge once more === */
@media (max-width: 400px) {
  .metric-card      { padding: 12px; }
  .metric-value     { font-size: 20px; }
  .prediction-value { font-size: 18px; }
  .chart-container  { height: 230px; }
}
  </style>
</head>
<body>
 <header class="header">
  <div class="header-content brand">
    <div class="brand-left">
      <!-- Brand mark (SVG dew drop) -->
      <div class="brand-mark" aria-hidden="true">
        <svg viewBox="0 0 64 64" width="38" height="38" role="img">
          <defs>
            <linearGradient id="dpGrad" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%"  stop-color="var(--accent-blue)" />
              <stop offset="100%" stop-color="var(--accent-green)" />
            </linearGradient>
          </defs>
          <!-- Dew drop shape -->
          <path fill="url(#dpGrad)"
                d="M32 6c6 10 16 18 16 30 0 9.94-8.06 18-18 18s-18-8.06-18-18C12 24 26 16 32 6z"/>
        </svg>
      </div>

      <!-- Wordmark -->
      <div class="brand-copy">
        <h1 class="brand-title"><span class="thin">Daily</span> Dew&nbsp;Point</h1>
        <p class="brand-sub">Automatically logs every NWS forecast update for Central Park and compares to the official daily high</p>
      </div>
    </div>

    <!-- Meta pills -->
    <div class="brand-right">
      <span class="pill live"><span class="dot"></span> Live</span>
      <span class="pill">NYC</span>
      <span class="pill">KNYC</span>
    </div>
  </div>
</header>
  <div class="container">
    <div class="last-update">
      <div class="last-update-label">Latest Forecast Update</div>
      <div id="recentForecast" class="last-update-content">Loading latest forecast data...</div>
    </div>

    <!-- Metrics -->
    <div class="metrics-grid">
      <div class="metric-card today-forecast">
        <div class="metric-label">Today's Latest Forecast</div>
        <div id="box-today-forecast" class="metric-value">‚Äì</div>
		<div class="metric-subtitle">Today's Forecasts</div>
        <div id="mini-today-forecasts" class="mini-forecasts"></div>
      </div>

	   <div class="metric-card today-actual">
        <div class="metric-label">Today's Actual High</div>
        <div id="box-today-actual" class="metric-value">‚Äì</div>
		<div id="box-today-actual-note" class="metric-subtitle">NWS daily cli report</div>
      </div>

      <div class="metric-card today-obs">
        <div class="metric-label">Today's High So Far</div>
        <div id="box-today-obs" class="metric-value">‚Äì</div>
        <div id="box-today-obs-note" class="metric-subtitle"></div>

        <div style="margin-top:16px; padding-top:14px; border-top:1px solid var(--border-subtle);">
          <div class="metric-subtitle">Current Temperature</div>
          <div id="box-today-current" class="metric-value" style="font-size:26px;">‚Äì</div>
          <div id="box-today-current-note" class="metric-subtitle"></div>
        </div>
      </div>

      <div class="metric-card tomorrow-forecast">
        <div class="metric-label">Tomorrow's Forecast</div>
        <div id="box-tomorrow-forecast" class="metric-value">‚Äì</div>
      </div>
    </div>
    
	<!-- Bias-corrected -->
<div class="prediction-grid" style="display:grid; grid-template-columns:repeat(2,1fr); gap:18px; margin-bottom:22px;">
  <div class="prediction-card">
    <div class="prediction-title">Today's Bias-Corrected Prediction</div>
    <div id="correctionBoxToday" class="prediction-content">Loading...</div>
  </div>
  <div class="prediction-card">
    <div class="prediction-title">Tomorrow's Bias-Corrected Prediction</div>
    <div id="correctionBoxTomorrow" class="prediction-content">Loading...</div>
  </div>

  <!-- Note spans both columns -->
  <div style="grid-column:1/3; font-size:12px; color:var(--text-light); margin-top:-4px;">
    Note: ‚Äúdays‚Äù refers only to dates with an actual high and at least one valid forecast logged before that high.
  </div>
</div>


	  
    <!-- Kalshi -->
    <div class="kalshi-grid">
      <div class="kalshi-card">
        <div class="metric-label">Today's Kalshi Market</div>
        <div id="box-today-kalshi" class="metric-value" style="font-size:18px;">Pending settlement</div>
        <div id="box-today-kalshi-note" class="kalshi-note"></div>
      </div>
      <div class="kalshi-card">
        <div class="metric-label">Yesterday's Kalshi Result</div>
        <div id="box-yday-kalshi" class="metric-value" style="font-size:18px;">‚Äì</div>
        <div id="box-yday-kalshi-note" class="kalshi-note"></div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-section">
      <div class="controls-title">Filter Data</div>
      <div class="controls">
        <div class="control-group">
          <label class="control-label" for="fromDate">From:</label>
          <input type="date" id="fromDate"/>
        </div>
        <div class="control-group">
          <label class="control-label" for="toDate">To:</label>
          <input type="date" id="toDate"/>
        </div>
        <button class="btn" onclick="applyDateFilter()">Apply Filter</button>
        <button class="btn secondary" onclick="resetFilter()">Show All</button>
        <button class="btn secondary" onclick="reloadCSV()">Refresh Data</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="stats">
      <div class="stat-card"><div class="stat-label">Days Tracked</div><div class="stat-value">0</div></div>
      <div class="stat-card"><div class="stat-label">Days With Actual</div><div class="stat-value">0</div></div>
      <div class="stat-card"><div class="stat-label">Average Absolute Error</div><div class="stat-value">--¬∞F</div></div>
      <div class="stat-card"><div class="stat-label">Average Best Error</div><div class="stat-value">--¬∞F</div></div>
    </div>

    <!-- Chart -->
    <div class="chart-section">
      <div class="chart-title">Temperature Trends: Actual vs Predicted</div>
      <div class="chart-container"><canvas id="dailyChart" width="1000" height="380"></canvas></div>
    </div>

    <!-- Collapsible Table -->
    <div class="table-section">
      <details class="table-wrap">
        <summary>
          <span>Detailed Forecast Log</span>
          <span class="caret">‚ñ∏</span>
        </summary>
        <div class="table-container">
          <table id="dataTable">
            <thead>
              <tr>
                <th>Date Pulled</th>
                <th>Forecast Time</th>
                <th>For Date</th>
                <th>Forecasted High</th>
                <th>Actual High</th>
                <th>High Time</th>
                <th>Error (¬∞F)</th>
                <th>Best?</th>
                <th>Kalshi Range</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>
    </div>
  </div>

  <footer class="footer">
    ¬© 2025 Dewdrop Ventures, LLC ¬∑ 
    <a href="/terms.html">Terms</a> ¬∑ 
    <a href="/privacy.html">Privacy</a> ¬∑ 
    <span>Informational only ‚Äî not financial advice. Do your own due diligence before placing any bets or making financial decisions.</span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let allRows = [];
    let filteredRows = [];

    /* NYC-local ISO date helper (YYYY-MM-DD) */
    function nycISODate(offsetDays=0){
      const fmt = new Intl.DateTimeFormat('en-CA',{timeZone:'America/New_York',year:'numeric',month:'2-digit',day:'2-digit'});
      const parts = fmt.formatToParts(new Date(Date.now()+offsetDays*86400000));
      const g = k => parts.find(p => p.type === k).value;
      return `${g('year')}-${g('month')}-${g('day')}`;
    }

  /* Make Kalshi anchor like #kxhighny-25aug23 for 2025-08-23 (ET) => YYmonDD */
function kalshiAnchorForISO(dateISO){
  const [y, m, d] = dateISO.split('-').map(Number);
  // Use UTC to avoid local DST/offset surprises for day/month/year pieces
  const dt = new Date(Date.UTC(y, m - 1, d));
  const monthMap = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'];
  const dd = String(dt.getUTCDate()).replace(/^0/, ''); // no leading zero
  const mon = monthMap[dt.getUTCMonth()];
  const yy = String(dt.getUTCFullYear()).slice(-2);
  return `#kxhighny-${yy}${mon}${dd}`;
}
// quick sanity check:
// kalshiAnchorForISO('2025-08-23') -> "#kxhighny-25aug23"

    /* ---------------- CSV load + parsing ---------------- */
    function showSkeleton(rows=6){
      const tb=document.querySelector("#dataTable tbody");
      tb.innerHTML="";
      for(let i=0;i<rows;i++){
        const tr=document.createElement("tr");
        tr.className="skel";
        tr.innerHTML="<td></td>".repeat(9);
        tb.appendChild(tr);
      }
    }

    function reloadCSV(){
      showSkeleton();
      fetch("https://raw.githubusercontent.com/hwaheed13/nws-forecast-logger/main/nws_forecast_log.csv?"+Date.now())
        .then(r => r.text())
        .then(parseCSV)
        .then(() => {
          resetFilter();
          showMostRecent();
          updateSummaryBoxes();
          updateCorrectionBoxes();
        })
        .catch(err => alert("Could not load CSV. "+err));
    }

    function csvToRows(text){
      const rows=[]; let row=[], field='', q=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(c==='"'){ if(q && n==='"'){ field+='"'; i++; } else q=!q; }
        else if(c===',' && !q){ row.push(field); field=''; }
        else if((c==='\n'||c==='\r') && !q){
          if(c==='\r' && n==='\n') i++;
          row.push(field); field='';
          if(row.length && row.some(x=>x!=='')) rows.push(row);
          row=[];
        } else field+=c;
      }
      if(field!==''||row.length){ row.push(field); if(row.length && row.some(x=>x!=='')) rows.push(row); }
      return rows;
    }

    function parseCSV(text){
      const rows=csvToRows(text);
      if(!rows.length) return;
      const header=rows[0].map(h=>h.trim());
      allRows=[];
      for(let i=1;i<rows.length;i++){
        const vals=rows[i]; const rec={};
        for(let j=0;j<header.length;j++){
          let v=(vals[j]??'').trim();
          if(v.startsWith('"')&&v.endsWith('"')) v=v.slice(1,-1).replace(/""/g,'"');
          rec[header[j]]=v;
        }
        allRows.push(rec);
      }
    }

    /* ---------------- Filters & helpers ---------------- */
    function resetFilter(){
      filteredRows=allRows.slice();
      document.getElementById('fromDate').value="";
      document.getElementById('toDate').value="";
      displayTable(); showStats(); showChart();
      showMostRecent(); updateCorrectionBoxes();
    }

    function applyDateFilter(){
      const from=document.getElementById('fromDate').value;
      const to=document.getElementById('toDate').value;
      filteredRows=allRows.filter(row=>{
        const date=row.forecast_or_actual==="actual"?row.cli_date:row.target_date;
        if(!date) return false;
        if(from && date<from) return false;
        if(to && date>to) return false;
        return true;
      });
      displayTable(); showStats(); showChart();
      showMostRecent(); updateCorrectionBoxes(); updateSummaryBoxes();
    }

    function rNum(x){ const n=Number(x); return Number.isFinite(n)?n:null; }

    function toDateObj(t){
      if(!t) return null;
      const clean=String(t).trim().replace(/:(\d{2})(?=\s*[AP]M)/i,'');
      if(/[AP]M/i.test(clean)){
        const m=clean.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
        if(!m) return null;
        const [,h,mn,amp]=m;
        const hour=(Number(h)%12)+(amp.toUpperCase()==="PM"?12:0);
        return new Date(2020,1,1,hour,Number(mn));
      }
      if(/^\d{2}:\d{2}$/.test(clean)){
        const [h,mn]=clean.split(":"); return new Date(2020,1,1,Number(h),Number(mn));
      }
      return null;
    }
    function compareTimes(t1,t2){ const d1=toDateObj(t1), d2=toDateObj(t2); return (d1&&d2)?d1-d2:0; }

    /* -------- Last logged forecast -------- */
    function showMostRecent(){
      const el=document.getElementById("recentForecast");
      if(!allRows.length){ el.textContent=""; return; }
      for(let i=allRows.length-1;i>=0;i--){
        const r=allRows[i];
        if(r && r.forecast_or_actual==="forecast" && r.predicted_high && r.target_date){
          const iso=r.timestamp;
          const when = iso ? new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",hour:"numeric",minute:"2-digit",month:"short",day:"numeric"}).format(new Date(iso)) : (r.forecast_time||"(time unknown)");
          el.innerHTML = `<strong>${when} ET</strong> ‚Äî <strong>${r.predicted_high}¬∞F</strong> for <strong>${r.target_date}</strong>`;
          return;
        }
      }
      el.textContent="";
    }

    /* -------- Mini forecast chips & sparkline -------- */
    function getForecastsForDate(dateISO){
      const rows=allRows
        .filter(r=>r.forecast_or_actual==="forecast" && r.target_date===dateISO && r.predicted_high)
        .map(r=>({tstamp:r.timestamp||r.forecast_time||"", timeHHMM:(r.forecast_time||"").substr(11,5), val:Number(r.predicted_high)}))
        .filter(x=>Number.isFinite(x.val));
      rows.sort((a,b)=>(a.tstamp||"").localeCompare(b.tstamp||""));
      return rows;
    }
    function renderMiniForecastChips(rows, elId){
      const host=document.getElementById(elId); if(!host) return; host.innerHTML="";
      const compact=[]; rows.forEach((r,i)=>{ if(i===0||r.val!==rows[i-1].val) compact.push(r); });
      if(!compact.length){ host.innerHTML=`<span class="mini-chip">No forecasts yet</span>`; return; }
      compact.forEach(r=>{
        const label=`${r.timeHHMM||"‚Äî"} ${r.val.toFixed(0)}¬∞`;
        const chip=document.createElement("span"); chip.className="mini-chip"; chip.textContent=label; host.appendChild(chip);
      });
    }
    function drawSparkline(canvasId, rows){
      const cv=document.getElementById(canvasId); if(!cv) return;
      const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
      if(!rows.length) return; const W=cv.width,H=cv.height,pad=4;
      const vals=rows.map(r=>r.val); const min=Math.min(...vals), max=Math.max(...vals);
      if(max===min){
        const y=H/2; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.lineWidth=3; ctx.strokeStyle="#7c3aed"; ctx.stroke();
        ctx.beginPath(); ctx.arc(W-pad,y,3,0,Math.PI*2); ctx.fillStyle="#16a34a"; ctx.fill(); return;
      }
      const n=vals.length; const xStep=(W-pad*2)/Math.max(1,n-1); const toY=v=>H-pad-((v-min)/(max-min))*(H-pad*2);
      ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle="#7c3aed";
      vals.forEach((v,i)=>{ const x=pad+i*xStep, y=toY(v); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();
      const lastX=pad+(n-1)*xStep, lastY=toY(vals[n-1]); ctx.beginPath(); ctx.arc(lastX,lastY,3,0,Math.PI*2); ctx.fillStyle="#16a34a"; ctx.fill();
    }

    /* ---------------- Kalshi helpers ---------------- */
    const KALSHI_PROXY_BASE = "https://kalshi-proxy-theta.vercel.app/api/kalshi";
    const KALSHI_LIVE_BASE  = "https://kalshi-proxy-theta.vercel.app/api/kalshi-live";
    const KALSHI_BASE_URL   = "https://kalshi.com/markets/kxhighny/highest-temperature-in-nyc";

    async function fetchKalshiWinningRange(dateISO){
      try{
        let r=await fetch(`${KALSHI_PROXY_BASE}?date=${encodeURIComponent(dateISO)}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"});
        if(r.status===204) return null;
        if(r.status===304){
          r=await fetch(`${KALSHI_PROXY_BASE}?date=${encodeURIComponent(dateISO)}&cb=${Date.now()}`,{mode:"cors",headers:{Accept:"application/json"}});
        }
        if(!r.ok) return null; return await r.json();
      }catch{return null;}
    }
    async function fetchKalshiLiveLeader(dateISO){
      try{
        const r=await fetch(`${KALSHI_LIVE_BASE}?date=${encodeURIComponent(dateISO)}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"});
        if(!r.ok) return null; return await r.json();
      }catch{return null;}
    }
    const kalshiCache=new Map();
    async function getKalshiLabel(dateISO){
      if(!/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) return null;
      if(kalshiCache.has(dateISO)){
        const cached=kalshiCache.get(dateISO);
        if(cached===null){ const fresh=await fetchKalshiWinningRange(dateISO); kalshiCache.set(dateISO,fresh); return fresh; }
        return cached;
      }
      const data=await fetchKalshiWinningRange(dateISO); kalshiCache.set(dateISO,data); return data;
    }

    /* NWS obs (high so far + current) */
    const NWS_OBS_BASE="https://kalshi-proxy-theta.vercel.app/api/nws-high-so-far";
    const NWS_CURRENT_BASE="https://kalshi-proxy-theta.vercel.app/api/nws-current-temp";
    async function fetchNwsHighSoFar(station="KNYC"){ try{ const r=await fetch(`${NWS_OBS_BASE}?station=${encodeURIComponent(station)}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"}); if(!r.ok) return null; return await r.json(); }catch{return null;} }
    async function fetchNwsCurrentTemp(station="KNYC"){ try{ const r=await fetch(`${NWS_CURRENT_BASE}?station=${encodeURIComponent(station)}&cb=${Date.now()}`,{mode:"cors",headers:{Accept:"application/json"},cache:"no-cache"}); if(!r.ok) return null; return await r.json(); }catch{return null;} }

    function updateObservations(){
      fetchNwsHighSoFar("KNYC").then(obs=>{
        const el=document.getElementById("box-today-obs");
        const note=document.getElementById("box-today-obs-note");
        if(!el||!note) return;
        if(obs && obs.highF!=null){
          el.textContent=`${Number(obs.highF).toFixed(1)}¬∞F`;
          const ts=obs.atISO?new Date(obs.atISO):null;
          const tNY=ts? new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",hour:"numeric",minute:"2-digit"}).format(ts) : "";
          note.textContent = tNY ? `as of ${tNY} ET ‚Ä¢ station ${obs.station}` : `station ${obs.station}`;
        } else { el.textContent="‚Äì"; note.textContent=""; }
      });
      fetchNwsCurrentTemp("KNYC").then(cur=>{
        const el=document.getElementById("box-today-current");
        const note=document.getElementById("box-today-current-note");
        if(!el||!note) return;
        if(cur && cur.currentF!=null){
          el.textContent=`${Number(cur.currentF).toFixed(1)}¬∞F`;
          const ts=cur.atISO?new Date(cur.atISO):null;
          const tNY=ts? new Intl.DateTimeFormat("en-US",{timeZone:"America/New_York",hour:"numeric",minute:"2-digit"}).format(ts):"";
          note.textContent = tNY ? `as of ${tNY} ET ‚Ä¢ station ${cur.station}` : `station ${cur.station}`;
        } else { el.textContent="‚Äì"; note.textContent=""; }
      });
    }

    /* ---------------- Summary boxes (incl. Kalshi) ---------------- */
    function updateSummaryBoxes(){
      const today=nycISODate(0);
      const tomorrow=nycISODate(1);
      const yesterday=nycISODate(-1);

      const latestForDate=(date)=>{
        const rows=allRows.filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high);
        if(!rows.length) return null;
        rows.sort((a,b)=>{const A=a.timestamp||a.forecast_time||"", B=b.timestamp||b.forecast_time||""; return B.localeCompare(A);});
        return Number(rows[0].predicted_high);
      };
      const avgForDate=(date)=>{
        const vals=allRows.filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high).map(r=>Number(r.predicted_high));
        if(!vals.length) return null; return vals.reduce((a,b)=>a+b,0)/vals.length;
      };

      const tLatest=latestForDate(today);
      const tActRow=allRows.find(r=>r.forecast_or_actual==="actual" && r.cli_date===today && r.actual_high);
      const tActual=tActRow? Number(tActRow.actual_high):null;
      const tmAvg=avgForDate(tomorrow);

      document.getElementById("box-today-forecast").textContent=(tLatest==null)?"‚Äì":tLatest.toFixed(1)+"¬∞F";
      document.getElementById("box-today-actual").textContent=(tActual==null)?"‚Äì":tActual.toFixed(1)+"¬∞F";
      document.getElementById("box-tomorrow-forecast").textContent=(tmAvg==null)?"‚Äì":tmAvg.toFixed(1)+"¬∞F";

      const todayRows=getForecastsForDate(today);
      renderMiniForecastChips(todayRows,"mini-today-forecasts");

      // KALSHI CARDS
      Promise.all([ getKalshiLabel(today), getKalshiLabel(yesterday) ])
        .then(async ([ktoday, kyday])=>{
          const tBox=document.getElementById('box-today-kalshi');
          const tNote=document.getElementById('box-today-kalshi-note');
          const yBox=document.getElementById('box-yday-kalshi');
          const yNote=document.getElementById('box-yday-kalshi-note');

          // TODAY: always link to BASE URL (no anchor)
          if(ktoday && ktoday.label){
            tBox.innerHTML = `<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">${ktoday.label}</a>`;
            tNote.textContent = ktoday.exactTemp!=null ? `Settled at ${ktoday.exactTemp.toFixed(1)}¬∞F.` : "";
          }else{
            const live=await fetchKalshiLiveLeader(today);
            if(live && live.leadingLabel){
              const pct=(live.leadingProb!=null)?` (${Math.round(live.leadingProb*100)}%)`:"";
              tBox.innerHTML = `<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">${live.leadingLabel}${pct}</a>`;
              tNote.textContent = "Live leader (can flip before settlement).";
            }else{
              tBox.innerHTML = `<span class="kalshi-pending">Pending settlement</span>`;
              tNote.textContent = "Closes 11:59 PM ET; settles after NWS daily report.";
            }
          }

          // YESTERDAY: always construct anchor ourselves (ignore any URL from proxy)
          const anchor = kalshiAnchorForISO(yesterday);
          const yHref  = `${KALSHI_BASE_URL}${anchor}`;
          if(kyday && kyday.label){
            const exact = kyday.exactTemp!=null ? ` (settled ${kyday.exactTemp.toFixed(1)}¬∞F)` : "";
            yBox.innerHTML = `<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer">${kyday.label}${exact}</a>`;
            yNote.textContent = "Links directly to yesterday‚Äôs contract.";
          }else{
            yBox.innerHTML = `<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer">Open yesterday‚Äôs market</a>`;
            yNote.textContent = "No proxy data; linking via anchor.";
          }
        })
        .catch(()=>{
          const tBox=document.getElementById('box-today-kalshi');
          const tNote=document.getElementById('box-today-kalshi-note');
          const yBox=document.getElementById('box-yday-kalshi');
          const yNote=document.getElementById('box-yday-kalshi-note');
          if(tBox) tBox.innerHTML=`<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer">Open market</a>`;
          if(tNote) tNote.textContent="Could not load proxy data.";
          const yHref=`${KALSHI_BASE_URL}${kalshiAnchorForISO(nycISODate(-1))}`;
          if(yBox) yBox.innerHTML=`<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer">Open yesterday‚Äôs market</a>`;
          if(yNote) yNote.textContent="Proxy error; using anchor link.";
        });
    }

    /* ---------------- Bias calc & corrected predictions ---------------- */
    function calcBiases(){
      const biasList=[], dayMap={};
      allRows.forEach(r=>{
        const d=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!d) return; if(!dayMap[d]) dayMap[d]=[]; dayMap[d].push(r);
      });
      const dates=Object.keys(dayMap).sort();
      dates.forEach(d=>{
        const rows=dayMap[d];
        const actual=rows.find(r=>r.forecast_or_actual==="actual" && r.actual_high);
        if(!actual) return;
        const actualHigh=Number(actual.actual_high);
        const highTime=actual.high_time||"";
        const fcVals=[];
        rows.forEach(r=>{
          if(r.forecast_or_actual!=="forecast" || !r.predicted_high) return;
          if(highTime){
            const fcHH=(r.forecast_time||"").substr(11,5);
            if(fcHH && compareTimes(fcHH,highTime)>0) return;
          }
          fcVals.push(Number(r.predicted_high));
        });
        if(fcVals.length){
          const meanFc=fcVals.reduce((a,b)=>a+b,0)/fcVals.length;
          biasList.push(actualHigh-meanFc);
        }
      });
      return biasList;
    }

    function updateCorrectionBoxes(){
      const biasList=calcBiases();
      const avgBias=biasList.length? (biasList.reduce((a,b)=>a+b,0)/biasList.length):0;
      const today=nycISODate(0);
      const tomorrow=nycISODate(1);

      const meanForecastForDate=(date)=>{
        const actual=allRows.find(r=>r.forecast_or_actual==="actual" && r.cli_date===date && r.actual_high);
        const highTime=actual?actual.high_time:"";
        const vals=allRows
          .filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high)
          .filter(r=>{
            if(highTime){
              const fcHH=(r.forecast_time||"").substr(11,5);
              if(fcHH && compareTimes(fcHH,highTime)>0) return false;
            }
            return true;
          }).map(r=>Number(r.predicted_high));
        if(!vals.length) return null;
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      };

      const tAvg=meanForecastForDate(today);
      const tmAvg=meanForecastForDate(tomorrow);
      const tPred=(tAvg==null)?null:tAvg+avgBias;
      const tmPred=(tmAvg==null)?null:tmAvg+avgBias;
      const biasTxt=(avgBias>0?"+":"")+avgBias.toFixed(2);

      document.getElementById("correctionBoxToday").innerHTML =
        `<div class="prediction-value">${tPred==null?"‚Äì":tPred.toFixed(1)+"¬∞F"}</div>
         <div class="prediction-subtitle">For ${today} ‚Ä¢ Historical bias: ${biasTxt}¬∞F (${biasList.length} days)</div>`;

      document.getElementById("correctionBoxTomorrow").innerHTML =
        `<div class="prediction-value">${tmPred==null?"‚Äì":tmPred.toFixed(1)+"¬∞F"}</div>
         <div class="prediction-subtitle">For ${tomorrow} ‚Ä¢ Historical bias: ${biasTxt}¬∞F (${biasList.length} days)</div>`;
    }

    /* ---------------- Stats ---------------- */
    function showStats(){
      let count=0, absSum=0, bestSum=0, bestCount=0;
      const dayMap={};
      filteredRows.forEach(row=>{
        const date=row.forecast_or_actual==="actual"?row.cli_date:row.target_date;
        if(!date) return; if(!dayMap[date]) dayMap[date]=[]; dayMap[date].push(row);
      });
      const totalDays=Object.keys(dayMap).length;

      Object.values(dayMap).forEach(dayRows=>{
        const actual=dayRows.find(r=>r.forecast_or_actual==="actual");
        const actualHigh=actual?Number(actual.actual_high):null;
        if(!Number.isFinite(actualHigh)) return;
        const highTime=actual?actual.high_time:"";
        let bestErr=999;
        dayRows.forEach(r=>{
          if(r.forecast_or_actual!=="forecast" || !r.predicted_high) return;
          if(highTime){
            const fcHour=(r.forecast_time||"").substr(11,5);
            if(fcHour && compareTimes(fcHour,highTime)>0) return;
          }
          const err=Math.abs(Number(r.predicted_high)-actualHigh);
          absSum+=err; count++; if(err<bestErr) bestErr=err;
        });
        if(bestErr<999){ bestSum+=bestErr; bestCount++; }
      });

      const avgAbs = count? (absSum/count).toFixed(2) : "--";
      const avgBest = bestCount? (bestSum/bestCount).toFixed(2) : "--";
      const daysWithActual = Object.values(dayMap).filter(rows =>
        rows.some(x => x.forecast_or_actual === "actual" && Number.isFinite(Number(x.actual_high)))
      ).length;

      const stats=document.getElementById("stats");
      stats.innerHTML = `
        <div class="stat-card"><div class="stat-label">Days Tracked</div><div class="stat-value">${totalDays}</div></div>
        <div class="stat-card"><div class="stat-label">Days With Actual</div><div class="stat-value">${daysWithActual}</div></div>
        <div class="stat-card"><div class="stat-label">Average Absolute Error</div><div class="stat-value">${avgAbs}¬∞F</div></div>
        <div class="stat-card"><div class="stat-label">Average Best Error</div><div class="stat-value">${avgBest}¬∞F</div></div>
      `;
    }

    /* ---------------- Chart (weekly x-axis labels only) ---------------- */
    function showChart(){
      const ctx=document.getElementById('dailyChart').getContext('2d');
      if(window.mainChart) window.mainChart.destroy();
      const dayMap={};
      filteredRows.forEach(row=>{
        const date=row.forecast_or_actual==="actual"?row.cli_date:row.target_date;
        if(!date) return; if(!dayMap[date]) dayMap[date]=[]; dayMap[date].push(row);
      });
      const labels=[], actuals=[], bestForecasts=[];
      Object.keys(dayMap).sort().forEach(date=>{
        const dayRows=dayMap[date];
        const actual=dayRows.find(r=>r.forecast_or_actual==="actual");
        const actualHigh=actual?Number(actual.actual_high):null;
        const highTime=actual?actual.high_time:"";
        let best=null, bestErr=999;
        dayRows.forEach(r=>{
          if(r.forecast_or_actual!=="forecast" || !r.predicted_high) return;
          if(highTime){
            const fcHour=(r.forecast_time||"").substr(11,5);
            if(fcHour && compareTimes(fcHour,highTime)>0) return;
          }
          const err=Math.abs(Number(r.predicted_high)-actualHigh);
          if(err<bestErr){ bestErr=err; best=r; }
        });
        if(actualHigh!==null){
          labels.push(date);
          actuals.push(actualHigh);
          bestForecasts.push(best?Number(best.predicted_high):null);
        }
      });

      window.mainChart=new Chart(ctx,{
        type:'line',
        data:{
          labels,
          datasets:[
            {label:"Actual High", data:actuals, borderColor:"#16a34a", backgroundColor:"rgba(22,163,74,.12)", borderWidth:3, tension:.3, pointRadius:3, pointHoverRadius:6},
            {label:"Best Forecast (pre-high)", data:bestForecasts, borderColor:"#7c3aed", backgroundColor:"rgba(124,58,237,.12)", borderWidth:3, tension:.3, pointRadius:3, pointHoverRadius:6}
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{display:true, position:"top", labels:{usePointStyle:true, padding:14, font:{size:12, weight:'700'}}},
            title:{display:false}
          },
          scales:{
            x:{
              title:{display:true, text:"Date", font:{size:12, weight:'800'}, padding:{top:8}},
              ticks:{
                autoSkip:false,
                maxRotation:0, minRotation:0,
                callback:(val, idx, ticks)=>{
                  const d=labels[idx]; // YYYY-MM-DD
                  const parts=d.split('-'); const jsDate=new Date(parts[0], Number(parts[1])-1, parts[2]);
                  // Show only Mondays
                  if(jsDate.getDay()===1){ // Monday
                    return new Intl.DateTimeFormat('en-US',{month:'short', day:'numeric'}).format(jsDate);
                  }
                  return "";
                }
              },
              grid:{color:'rgba(0,0,0,0.05)'}
            },
            y:{
              title:{display:true, text:"Temperature (¬∞F)", font:{size:12, weight:'800'}, padding:{bottom:6}},
              grid:{color:'rgba(0,0,0,0.05)'}
            }
          },
          interaction:{intersect:false, mode:'index'}
        }
      });
    }

    /* ---------------- Table (prefetches Kalshi via proxy) ---------------- */
    async function displayTable(){
      const tb=document.querySelector("#dataTable tbody"); tb.innerHTML="";
      const dayMap={};
      filteredRows.forEach(r=>{
        const date=r.forecast_or_actual==="actual"?r.cli_date:r.target_date;
        if(!date) return; if(!dayMap[date]) dayMap[date]=[]; dayMap[date].push(r);
      });

      const isISODate=d=>/^\d{4}-\d{2}-\d{2}$/.test(d);
      const dates=Object.keys(dayMap).filter(isISODate).sort();

      const kalshiByDate={};
      await Promise.all(dates.map(async d=>{
        try{ kalshiByDate[d]=await getKalshiLabel(d); }catch{ kalshiByDate[d]=null; }
      }));

      dates.forEach(date=>{
        const dayRows=dayMap[date];
        const actual=dayRows.find(r=>r.forecast_or_actual==="actual");
        const actualHigh=actual? rNum(actual.actual_high):null;
        const actualHighTxt=actual && actual.actual_high? actual.actual_high+"¬∞F":"";
        const highTime=actual? actual.high_time:"";
        let bestIdx=-1, bestErr=999;

        dayRows.forEach((r,i)=>{
          if(r.forecast_or_actual!=="forecast" || !r.predicted_high || actualHigh===null) return;
          if(highTime){
            const fcHour=(r.forecast_time||"").substr(11,5);
            if(fcHour && compareTimes(fcHour,highTime)>0) return;
          }
          const err=Math.abs(Number(r.predicted_high)-actualHigh);
          if(err<bestErr){ bestErr=err; bestIdx=i; }
        });

        const k=kalshiByDate[date];
        const label=k && k.label? k.label:"";
        const exact=k && k.exactTemp!=null? ` (${k.exactTemp.toFixed(1)}¬∞F)`:"";

        // Build Kalshi cell: if date === yesterday, force anchor link
        const yISO = nycISODate(-1);
        let kalshiCell="";
        if(date===yISO){
          const yHref=`${KALSHI_BASE_URL}${kalshiAnchorForISO(yISO)}`;
          kalshiCell = `<a class="kalshi-badge" href="${yHref}" target="_blank" rel="noopener noreferrer" title="Kalshi settled range">${label||"Open market"}${exact}</a>`;
        }else if(date===nycISODate(0)){
          kalshiCell = `<a class="kalshi-badge" href="${KALSHI_BASE_URL}" target="_blank" rel="noopener noreferrer" title="Kalshi market">${label||"Open market"}</a>`;
        }else{
          kalshiCell = label
            ? `<span class="kalshi-badge" title="Kalshi settled range">${label}${exact}</span>`
            : `<span style="color: var(--text-light); font-size: 12px;">‚Äî</span>`;
        }

        dayRows.forEach((r,i)=>{
          if(r.forecast_or_actual!=="forecast" && r.forecast_or_actual!=="actual") return;
          let cls=r.forecast_or_actual==="actual"?"actual-row":"forecast-row";
          if(i===bestIdx && r.forecast_or_actual==="forecast") cls+=" best";
          const pred=r.predicted_high? r.predicted_high+"¬∞F":"";
          const act=r.actual_high? r.actual_high+"¬∞F":actualHighTxt;
          const fTime=r.forecast_time? r.forecast_time.substr(11,5):"";
          const errTxt=(r.forecast_or_actual==="forecast" && r.predicted_high && actualHigh!==null)
            ? (Number(r.predicted_high)-actualHigh).toFixed(1) : "";
          tb.innerHTML += `
            <tr class="${cls}">
              <td>${r.timestamp ? r.timestamp.substr(0,10) : ""}</td>
              <td>${fTime}</td>
              <td>${date}</td>
              <td>${pred}</td>
              <td>${act}</td>
              <td>${highTime}</td>
              <td>${errTxt}</td>
             <td>${(i===bestIdx && r.forecast_or_actual==="forecast") ? "‚úì" : ""}</td>
			<td>${r.forecast_or_actual==="actual" ? kalshiCell : ""}</td>
		</tr>`;
        });

      });
    }

    /* ---------------- Init ---------------- */
    document.addEventListener("DOMContentLoaded", () => {
      reloadCSV();                 // load table/chart/boxes
      updateObservations();        // high-so-far + current temp
      // refresh obs every 5 minutes
      setInterval(updateObservations, 5 * 60 * 1000);
    });
  </script>
</body>
</html>


