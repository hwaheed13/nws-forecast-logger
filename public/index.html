<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üå°Ô∏è Daily Dew Point Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Modern color palette */
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --bg-accent: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      --border-subtle: #e2e8f0;
      --border-default: #cbd5e1;
      --accent-blue: #2563eb;
      --accent-blue-light: #dbeafe;
      --accent-green: #059669;
      --accent-green-light: #d1fae5;
      --accent-amber: #d97706;
      --accent-amber-light: #fef3c7;
      --accent-red: #dc2626;
      --accent-red-light: #fee2e2;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      margin: 0;
      color: var(--text-primary);
      line-height: 1.6;
      font-feature-settings: "tnum" 1, "lnum" 1;
    }

    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-subtle);
      padding: 24px 0;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(8px);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      font-size: 32px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-text h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .logo-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin: 0;
      font-weight: 400;
    }

    .status-badge {
      background: var(--accent-green-light);
      color: var(--accent-green);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      background: var(--accent-green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }

    .last-update {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-sm);
    }

    .last-update-label {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .last-update-content {
      font-size: 15px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    /* Grid Layouts */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 28px;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .metric-card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
    }

    .metric-card.today-forecast::before {
      background: var(--accent-amber);
    }

    .metric-card.today-obs::before {
      background: var(--accent-blue);
    }

    .metric-card.today-actual::before {
      background: var(--accent-green);
    }

    .metric-card.tomorrow-forecast::before {
      background: var(--accent-blue);
    }

    .metric-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .metric-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      line-height: 1;
    }

    .metric-subtitle {
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 12px;
    }

    .mini-forecasts {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .mini-chip {
      background: var(--bg-accent);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border-subtle);
    }

    .sparkline-container {
      height: 40px;
      margin-top: 12px;
    }

    .sparkline {
      width: 100%;
      height: 40px;
      display: block;
    }

    /* Kalshi Cards */
    .kalshi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .kalshi-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 28px;
      box-shadow: var(--shadow-sm);
    }

    .kalshi-badge {
      background: var(--accent-amber-light);
      color: var(--accent-amber);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      transition: all 0.2s ease;
    }

    .kalshi-badge:hover {
      background: var(--accent-amber);
      color: white;
    }

    .kalshi-pending {
      background: var(--bg-accent);
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      border: 2px dashed var(--border-default);
    }

    .kalshi-note {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 8px;
    }

    /* Prediction Cards */
    .prediction-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .prediction-card {
      background: linear-gradient(135deg, var(--accent-blue-light), var(--accent-green-light));
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-md);
    }

    .prediction-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .prediction-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-blue);
      margin-bottom: 12px;
    }

    .prediction-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Controls */
    .controls-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-sm);
    }

    .controls-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 16px;
    }

    .controls {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    input[type="date"] {
      padding: 10px 12px;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-sm);
      font-size: 14px;
      color: var(--text-primary);
      background: var(--bg-secondary);
      transition: all 0.2s ease;
    }

    input[type="date"]:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px var(--accent-blue-light);
    }

    .btn {
      background: var(--accent-blue);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .btn:hover {
      background: #1d4ed8;
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.secondary {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-default);
    }

    .btn.secondary:hover {
      background: var(--bg-accent);
      border-color: var(--border-default);
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 24px;
      box-shadow: var(--shadow-sm);
      text-align: center;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-blue);
    }

    /* Chart Section */
    .chart-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 32px;
      box-shadow: var(--shadow-sm);
    }

    .chart-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
    }

    /* Table Section */
    .table-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 32px;
      box-shadow: var(--shadow-sm);
    }

    .table-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 24px;
    }

    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
    }

    #dataTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: var(--bg-secondary);
    }

    #dataTable th {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 16px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border-default);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #dataTable td {
      padding: 14px 12px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    #dataTable tbody tr:hover {
      background: var(--bg-accent);
    }

    .forecast-row {
      background: var(--accent-blue-light) !important;
    }

    .actual-row {
      background: var(--accent-green-light) !important;
    }

    .best {
      box-shadow: inset 0 0 0 2px var(--accent-green);
    }

    /* Loading skeleton */
    .skel td::before {
      content: "";
      display: block;
      height: 12px;
      margin: 4px 0;
      width: 70%;
      background: linear-gradient(90deg, var(--bg-accent), var(--bg-tertiary), var(--bg-accent));
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    /* Footer */
    .footer {
      margin-top: 48px;
      padding: 24px 32px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border-subtle);
      text-align: center;
      font-size: 13px;
      color: var(--text-light);
    }

    .footer a {
      color: var(--accent-blue);
      text-decoration: none;
    }

    .footer a:hover {
      text-decoration: underline;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .header-content {
        padding: 0 16px;
        flex-direction: column;
        gap: 16px;
        text-align: center;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }

      .prediction-grid {
        grid-template-columns: 1fr;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .control-group {
        flex-direction: column;
        align-items: stretch;
      }

      .chart-container {
        height: 300px;
      }

      .table-section {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo-icon">üå°Ô∏è</div>
        <div class="logo-text">
          <h1>Daily Dew Point</h1>
          <p class="logo-subtitle">Forecast vs Actual ‚Äî Central Park, NY</p>
        </div>
      </div>
      <div class="status-badge">
        <div class="status-dot"></div>
        Live Dashboard
      </div>
    </div>
  </header>

  <div class="container">
    <div class="last-update">
      <div class="last-update-label">Latest Forecast Update</div>
      <div id="recentForecast" class="last-update-content">Loading latest forecast data...</div>
    </div>

    <!-- Current Metrics Grid -->
    <div class="metrics-grid">
      <div class="metric-card today-forecast">
        <div class="metric-label">Today's Latest Forecast</div>
        <div id="box-today-forecast" class="metric-value">‚Äì</div>
        <div id="mini-today-forecasts" class="mini-forecasts"></div>
        <div class="sparkline-container">
          <canvas id="spark-today-forecast" class="sparkline" width="280" height="40"></canvas>
        </div>
      </div>

      <div class="metric-card today-obs">
        <div class="metric-label">Today's High So Far</div>
        <div id="box-today-obs" class="metric-value">‚Äì</div>
        <div id="box-today-obs-note" class="metric-subtitle"></div>
        
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
          <div class="metric-subtitle">Current Temperature</div>
          <div id="box-today-current" class="metric-value" style="font-size: 24px;">‚Äì</div>
          <div id="box-today-current-note" class="metric-subtitle"></div>
        </div>
      </div>

      <div class="metric-card today-actual">
        <div class="metric-label">Today's Actual High</div>
        <div id="box-today-actual" class="metric-value">‚Äì</div>
      </div>

      <div class="metric-card tomorrow-forecast">
        <div class="metric-label">Tomorrow's Forecast</div>
        <div id="box-tomorrow-forecast" class="metric-value">‚Äì</div>
      </div>
    </div>

    <!-- Kalshi Cards -->
    <div class="kalshi-grid">
      <div class="kalshi-card">
        <div class="metric-label">Today's Kalshi Market</div>
        <div id="box-today-kalshi" class="metric-value" style="font-size: 18px;">Pending settlement</div>
        <div id="box-today-kalshi-note" class="kalshi-note"></div>
      </div>
      <div class="kalshi-card">
        <div class="metric-label">Yesterday's Kalshi Result</div>
        <div id="box-yday-kalshi" class="metric-value" style="font-size: 18px;">‚Äì</div>
        <div id="box-yday-kalshi-note" class="kalshi-note"></div>
      </div>
    </div>

    <!-- Bias-Corrected Predictions -->
    <div class="prediction-grid">
      <div class="prediction-card">
        <div class="prediction-title">Today's Bias-Corrected Prediction</div>
        <div id="correctionBoxToday" class="prediction-content">Loading...</div>
      </div>
      <div class="prediction-card">
        <div class="prediction-title">Tomorrow's Bias-Corrected Prediction</div>
        <div id="correctionBoxTomorrow" class="prediction-content">Loading...</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-section">
      <div class="controls-title">Filter Data</div>
      <div class="controls">
        <div class="control-group">
          <label class="control-label" for="fromDate">From:</label>
          <input type="date" id="fromDate"/>
        </div>
        <div class="control-group">
          <label class="control-label" for="toDate">To:</label>
          <input type="date" id="toDate"/>
        </div>
        <button class="btn" onclick="applyDateFilter()">Apply Filter</button>
        <button class="btn secondary" onclick="resetFilter()">Show All</button>
        <button class="btn secondary" onclick="reloadCSV()">Refresh Data</button>
      </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <div class="stat-label">Total Days</div>
        <div class="stat-value">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Absolute Error</div>
        <div class="stat-value">--¬∞F</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Best Error</div>
        <div class="stat-value">--¬∞F</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-section">
      <div class="chart-title">Temperature Trends: Actual vs Predicted</div>
      <div class="chart-container">
        <canvas id="dailyChart" width="1000" height="400"></canvas>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-section">
      <div class="table-title">Detailed Forecast Log</div>
      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Date Pulled</th>
              <th>Forecast Time</th>
              <th>For Date</th>
              <th>Forecasted High</th>
              <th>Actual High</th>
              <th>High Time</th>
              <th>Error (¬∞F)</th>
              <th>Best?</th>
              <th>Kalshi Range</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <footer class="footer">
    ¬© 2025 Dewdrop Ventures, LLC ¬∑ 
    <a href="/terms.html">Terms</a> ¬∑ 
    <a href="/privacy.html">Privacy</a> ¬∑ 
    <span>Informational only ‚Äî not financial advice. Do your own due diligence before placing any bets or making financial decisions.</span>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let allRows = [];
    let filteredRows = [];

    /* NYC-local ISO date helper (YYYY-MM-DD) */
    function nycISODate(offsetDays=0){
      const fmt = new Intl.DateTimeFormat('en-CA', {
        timeZone:'America/New_York', year:'numeric', month:'2-digit', day:'2-digit'
      });
      const parts = fmt.formatToParts(new Date(Date.now()+offsetDays*86400000));
      const g = k => parts.find(p => p.type === k).value;
      return `${g('year')}-${g('month')}-${g('day')}`;
    }

    /* ---------------- CSV load + parsing ---------------- */
    function showSkeleton(rows=6){
      const tb=document.querySelector("#dataTable tbody");
      tb.innerHTML="";
      for(let i=0;i<rows;i++){
        const tr=document.createElement("tr");
        tr.className="skel";
        tr.innerHTML="<td></td>".repeat(9);
        tb.appendChild(tr);
      }
    }

    function reloadCSV() {
      showSkeleton();
      fetch("https://raw.githubusercontent.com/hwaheed13/nws-forecast-logger/main/nws_forecast_log.csv?"+Date.now())
        .then(resp => resp.text())
        .then(parseCSV)
        .then(() => {
          resetFilter();        // table, stats, chart
          showMostRecent();
          updateSummaryBoxes(); // includes Kalshi cards
          updateCorrectionBoxes();
        })
        .catch(err => {
          alert("Could not load CSV. " + err);
        });
    }

    function csvToRows(text) {
      const rows = [];
      let row = [], field = '', inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const c = text[i], n = text[i+1];
        if (c === '"') {
          if (inQuotes && n === '"') { field += '"'; i++; }
          else { inQuotes = !inQuotes; }
        } else if (c === ',' && !inQuotes) {
          row.push(field); field = '';
        } else if ((c === '\n' || c === '\r') && !inQuotes) {
          if (c === '\r' && n === '\n') i++;
          row.push(field); field = '';
          if (row.length && row.some(x => x !== '')) rows.push(row);
          row = [];
        } else { field += c; }
      }
      if (field !== '' || row.length) {
        row.push(field);
        if (row.length && row.some(x => x !== '')) rows.push(row);
      }
      return rows;
    }

    function parseCSV(text) {
      const rows = csvToRows(text);
      if (!rows.length) return;
      const header = rows[0].map(h => h.trim());
      allRows = [];
      for (let i = 1; i < rows.length; i++) {
        const vals = rows[i];
        const rec = {};
        for (let j = 0; j < header.length; j++) {
          let v = (vals[j] ?? '').trim();
          if (v.startsWith('"') && v.endsWith('"'))
            v = v.slice(1, -1).replace(/""/g, '"');
          rec[header[j]] = v;
        }
        allRows.push(rec);
      }
    }

    /* ---------------- Filters & helpers ---------------- */
    function resetFilter() {
      filteredRows = allRows.slice();
      document.getElementById('fromDate').value = "";
      document.getElementById('toDate').value = "";
      displayTable(); showStats(); showChart();
      showMostRecent(); updateCorrectionBoxes();
    }

    function applyDateFilter() {
      const from = document.getElementById('fromDate').value;
      const to = document.getElementById('toDate').value;
      filteredRows = allRows.filter(row => {
        const date = row.forecast_or_actual === "actual" ? row.cli_date : row.target_date;
        if (!date) return false;
        if (from && date < from) return false;
        if (to && date > to) return false;
        return true;
      });
      displayTable(); showStats(); showChart();
      showMostRecent(); updateCorrectionBoxes();
      updateSummaryBoxes();
    }

    function rNum(x){ const n=Number(x); return Number.isFinite(n)?n:null; }

    function compareTimes(t1,t2) {
      const d1 = toDateObj(t1), d2 = toDateObj(t2);
      return (d1&&d2) ? d1-d2 : 0;
    }

    function toDateObj(t) {
      if (!t) return null;
      const clean = String(t).trim().replace(/:(\d{2})(?=\s*[AP]M)/i, ''); // drop seconds before AM/PM if present
      if (/[AP]M/i.test(clean)) {
        const m = clean.match(/(\d{1,2}):(\d{2})\s*([AP]M)/i);
        if (!m) return null;
        const [,h,mn,amp] = m;
        const hour = (Number(h)%12) + (amp.toUpperCase()==="PM"?12:0);
        return new Date(2020,1,1,hour,Number(mn));
      }
      if (/^\d{2}:\d{2}$/.test(clean)) {
        const [h,mn]=clean.split(":");
        return new Date(2020,1,1,Number(h),Number(mn));
      }
      return null;
    }

    /* -------- Last logged forecast -------- */
    function showMostRecent() {
      const el = document.getElementById("recentForecast");
      if (!allRows.length) { el.textContent = ""; return; }
      for (let i = allRows.length - 1; i >= 0; i--) {
        const r = allRows[i];
        if (r && r.forecast_or_actual === "forecast" && r.predicted_high && r.target_date) {
          const iso = r.timestamp;
          const when = iso ? new Intl.DateTimeFormat("en-US", {
            timeZone: "America/New_York", hour: "numeric", minute: "2-digit", month: "short", day: "numeric"
          }).format(new Date(iso)) : (r.forecast_time || "(time unknown)");      
          el.innerHTML = `<strong>${when} ET</strong> ‚Äî <strong>${r.predicted_high}¬∞F</strong> for <strong>${r.target_date}</strong>`;
          return;
        }
      }
      el.textContent = "";
    }

    /* -------- Helpers for today's mini history -------- */
    function getForecastsForDate(dateISO) {
      const rows = allRows
        .filter(r => r.forecast_or_actual === "forecast" && r.target_date === dateISO && r.predicted_high)
        .map(r => ({
          tstamp: r.timestamp || r.forecast_time || "",
          timeHHMM: (r.forecast_time || "").substr(11,5),
          val: Number(r.predicted_high)
        }))
        .filter(x => Number.isFinite(x.val));
      rows.sort((a,b) => (a.tstamp || "").localeCompare(b.tstamp || ""));
      return rows;
    }

    function renderMiniForecastChips(rows, elId) {
      const host = document.getElementById(elId);
      if (!host) return;
      host.innerHTML = "";
      const compact = [];
      rows.forEach((r, i) => { if (i === 0 || r.val !== rows[i-1].val) compact.push(r); });
      if (!compact.length) { host.innerHTML = `<span class="mini-chip">No forecasts yet</span>`; return; }
      compact.forEach(r => {
        const label = `${r.timeHHMM || "‚Äî"} ${r.val.toFixed(0)}¬∞`;
        const chip = document.createElement("span");
        chip.className = "mini-chip";
        chip.textContent = label;
        host.appendChild(chip);
      });
    }

    function drawSparkline(canvasId, rows) {
      const cv = document.getElementById(canvasId);
      if (!cv) return;
      const ctx = cv.getContext('2d');
      ctx.clearRect(0,0,cv.width,cv.height);
      if (!rows.length) return;
      const W = cv.width, H = cv.height, pad = 4;
      const vals = rows.map(r => r.val);
      const min = Math.min(...vals), max = Math.max(...vals);
      if (max === min) {
        const y = H/2;
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(W-pad, y);
        ctx.lineWidth = 3; ctx.strokeStyle = '#2563eb'; ctx.stroke();
        ctx.beginPath(); ctx.arc(W-pad, y, 3, 0, Math.PI*2);
        ctx.fillStyle = '#059669'; ctx.fill();
        return;
      }
      const n = vals.length;
      const xStep = (W - pad*2) / Math.max(1, n-1);
      const toY = v => H - pad - ((v - min) / (max - min)) * (H - pad*2);
      ctx.beginPath(); ctx.lineWidth = 3; ctx.strokeStyle = '#2563eb';
      vals.forEach((v, i) => {
        const x = pad + i * xStep, y = toY(v);
        if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
      });
      ctx.stroke();
      const lastX = pad + (n-1)*xStep, lastY = toY(vals[n-1]);
      ctx.beginPath(); ctx.arc(lastX, lastY, 3, 0, Math.PI*2);
      ctx.fillStyle = '#059669'; ctx.fill();
    }

/* ---------------- Kalshi via proxy (single call) ---------------- */
const KALSHI_PROXY_BASE = "https://kalshi-proxy-theta.vercel.app/api/kalshi";

async function fetchKalshiWinningRange(dateISO){
  try {
    let r = await fetch(`${KALSHI_PROXY_BASE}?date=${encodeURIComponent(dateISO)}`, {
      mode: "cors",
      headers: { Accept: "application/json" },
      cache: "no-cache"
    });
    if (r.status === 204) return null; // not settled yet
    if (r.status === 304) {
      r = await fetch(`${KALSHI_PROXY_BASE}?date=${encodeURIComponent(dateISO)}&cb=${Date.now()}`, {
        mode: "cors",
        headers: { Accept: "application/json" }
      });
    }
    if (!r.ok) return null;
    return await r.json();
  } catch {
    return null;
  }
}

// --- LIVE (intraday) leader endpoint
const KALSHI_LIVE_BASE = "https://kalshi-proxy-theta.vercel.app/api/kalshi-live";

async function fetchKalshiLiveLeader(dateISO){
  try {
    const r = await fetch(`${KALSHI_LIVE_BASE}?date=${encodeURIComponent(dateISO)}`, {
      mode: "cors",
      headers: { Accept: "application/json" },
      cache: "no-cache"
    });
    if (!r.ok) return null;   // 204/404/etc.
    return await r.json();    // { leadingLabel, leadingProb, url }
  } catch {
    return null;
  }
}


   // Cache that retries once if we previously saw null (e.g., pre-settlement)
const kalshiCache = new Map();
async function getKalshiLabel(dateISO){
  if (!/^\d{4}-\d{2}-\d{2}$/.test(dateISO)) return null; // guard

  if (kalshiCache.has(dateISO)) {
    const cached = kalshiCache.get(dateISO);
    if (cached === null) {
      // one fresh refetch after initial null
      const fresh = await fetchKalshiWinningRange(dateISO);
      kalshiCache.set(dateISO, fresh);
      return fresh;
    }
    return cached;
  }
   // fall through: no cache yet ‚Üí fetch once
  const data = await fetchKalshiWinningRange(dateISO);
  kalshiCache.set(dateISO, data);
  return data;
}
    function updateObservations(){
      fetchNwsHighSoFar("KNYC").then(obs => {
        const el = document.getElementById("box-today-obs");
        const note = document.getElementById("box-today-obs-note");
        if (!el || !note) return;
        if (obs && obs.highF != null) {
          el.textContent = `${Number(obs.highF).toFixed(1)}¬∞F`;
          const ts = obs.atISO ? new Date(obs.atISO) : null;
          const tNY = ts ? new Intl.DateTimeFormat("en-US", {
            timeZone: "America/New_York", hour: "numeric", minute: "2-digit"
          }).format(ts) : "";
          note.textContent = tNY ? `as of ${tNY} ET ‚Ä¢ station ${obs.station}` : `station ${obs.station}`;
        } else { el.textContent = "‚Äì"; note.textContent = ""; }
      });

      fetchNwsCurrentTemp("KNYC").then(cur => {
        const el = document.getElementById("box-today-current");
        const note = document.getElementById("box-today-current-note");
        if (!el || !note) return;
        if (cur && cur.currentF != null) {
          el.textContent = `${Number(cur.currentF).toFixed(1)}¬∞F`;
          const ts = cur.atISO ? new Date(cur.atISO) : null;
          const tNY = ts ? new Intl.DateTimeFormat("en-US", {
            timeZone: "America/New_York", hour: "numeric", minute: "2-digit"
          }).format(ts) : "";
          note.textContent = tNY ? `as of ${tNY} ET ‚Ä¢ station ${cur.station}` : `station ${cur.station}`;
        } else { el.textContent = "‚Äì"; note.textContent = ""; }
      });
    }

const NWS_OBS_BASE = "https://kalshi-proxy-theta.vercel.app/api/nws-high-so-far";
async function fetchNwsHighSoFar(station = "KNYC") {
  try {
    const r = await fetch(`${NWS_OBS_BASE}?station=${encodeURIComponent(station)}`, {
      mode: "cors",
      headers: { Accept: "application/json" },
      cache: "no-cache"
    });
    if (!r.ok) return null;  // 204/502/etc.
    return await r.json();   // { highF, atISO, station }
  } catch {
    return null;
  }
}
// --- NWS current temp (latest obs)
const NWS_CURRENT_BASE = "https://kalshi-proxy-theta.vercel.app/api/nws-current-temp";

async function fetchNwsCurrentTemp(station = "KNYC") {
  try {
    const r = await fetch(`${NWS_CURRENT_BASE}?station=${encodeURIComponent(station)}&cb=${Date.now()}`, {
      mode: "cors",
      headers: { Accept: "application/json" },
      cache: "no-cache"
    });
    if (!r.ok) return null;
    return await r.json();   // { currentF, atISO, station }
  } catch {
    return null;
  }
}

    /* ---------------- Summary boxes (uses proxy) ---------------- */
    function updateSummaryBoxes() {
      const today = nycISODate(0);
      const tomorrow = nycISODate(1);
      const yesterday = nycISODate(-1);

      const latestForDate = (date) => {
        const rows = allRows.filter(r =>
          r.forecast_or_actual === "forecast" && r.target_date === date && r.predicted_high
        );
        if (!rows.length) return null;
        rows.sort((a,b) => {
          const A = a.timestamp || a.forecast_time || "";
          const B = b.timestamp || b.forecast_time || "";
          return B.localeCompare(A);
        });
        return Number(rows[0].predicted_high);
      };

      const avgForDate = (date) => {
        const vals = allRows
          .filter(r => r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high)
          .map(r => Number(r.predicted_high));
        if (!vals.length) return null;
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      };

      const todayLatestForecast = latestForDate(today);
      const todayActualRow = allRows.find(r => r.forecast_or_actual==="actual" && r.cli_date===today && r.actual_high);
      const todayActual = todayActualRow ? Number(todayActualRow.actual_high) : null;
      const tomorrowAvgForecast = avgForDate(tomorrow);

      document.getElementById("box-today-forecast").textContent =
        (todayLatestForecast==null) ? "‚Äì" : todayLatestForecast.toFixed(1) + "¬∞F";
      document.getElementById("box-today-actual").textContent =
        (todayActual==null) ? "‚Äì" : todayActual.toFixed(1) + "¬∞F";
      document.getElementById("box-tomorrow-forecast").textContent =
        (tomorrowAvgForecast==null) ? "‚Äì" : tomorrowAvgForecast.toFixed(1) + "¬∞F";

      const todayRows = getForecastsForDate(today);
      renderMiniForecastChips(todayRows, "mini-today-forecasts");
      drawSparkline("spark-today-forecast", todayRows);

      // Kalshi cards (proxy)
Promise.all([ getKalshiLabel(today), getKalshiLabel(yesterday) ])
  .then(async ([ktoday, kyday]) => {
    const tBox = document.getElementById('box-today-kalshi');
    const tNote = document.getElementById('box-today-kalshi-note');
    const yBox = document.getElementById('box-yday-kalshi');
    const yNote = document.getElementById('box-yday-kalshi-note');

    // YESTERDAY (settled or not)
    if (kyday && kyday.label) {
      yBox.innerHTML = `<a class="kalshi-badge" href="${kyday.url}" target="_blank" rel="noopener">${kyday.label}</a>`;
      yNote.textContent = kyday.exactTemp != null ? `Settled at ${kyday.exactTemp.toFixed(1)}¬∞F.` : "";
    } else {
      yBox.innerHTML = `<span class="kalshi-pending">No data</span>`;
      yNote.textContent = "";
    }

    // TODAY: prefer settled; otherwise show LIVE LEADER
    if (ktoday && ktoday.label) {
      // Settled (rarely same-day, but keep behavior)
      tBox.innerHTML = `<a class="kalshi-badge" href="${ktoday.url}" target="_blank" rel="noopener">${ktoday.label}</a>`;
      tNote.textContent = ktoday.exactTemp != null ? `Settled at ${ktoday.exactTemp.toFixed(1)}¬∞F.` : "";
    } else {
      // Not settled yet ‚áí pull live leader
      const live = await fetchKalshiLiveLeader(today);
      if (live && live.leadingLabel) {
        const pct = (live.leadingProb != null) ? ` (${Math.round(live.leadingProb*100)}%)` : "";
        tBox.innerHTML = `<a class="kalshi-badge" href="${live.url}" target="_blank" rel="noopener">${live.leadingLabel}${pct}</a>`;
        tNote.textContent = "Live leader (can flip before settlement).";
      } else {
        tBox.innerHTML = `<span class="kalshi-pending">Pending settlement</span>`;
        tNote.textContent = "Closes 11:59 PM ET; settles after NWS daily report.";
      }
    }
  })
  .catch(() => {
    const tBox = document.getElementById('box-today-kalshi');
    const tNote = document.getElementById('box-today-kalshi-note');
    if (tBox) tBox.innerHTML = `<span class="kalshi-pending">Pending settlement</span>`;
          if (tNote) tNote.textContent = "Closes 11:59 PM ET; settles after NWS daily report.";
  }); 
    }

    /* ---------------- Bias calc & corrected predictions ---------------- */
    function calcBiases(){
      const biasList = [], dayMap = {};
      allRows.forEach(r => {
        const d = r.forecast_or_actual==="actual" ? r.cli_date : r.target_date;
        if(!d) return;
        if(!dayMap[d]) dayMap[d] = [];
        dayMap[d].push(r);
      });
      const dates = Object.keys(dayMap).sort();
      dates.forEach(d => {
        const rows = dayMap[d];
        const actual = rows.find(r => r.forecast_or_actual==="actual" && r.actual_high);
        if(!actual) return;
        const actualHigh = Number(actual.actual_high);
        const highTime = actual.high_time || "";
        const fcVals = [];
        rows.forEach(r => {
          if(r.forecast_or_actual!=="forecast" || !r.predicted_high) return;
          if (highTime) {
            const fcHHMM = (r.forecast_time||"").substr(11,5);
            if (fcHHMM && compareTimes(fcHHMM, highTime) > 0) return;
          }
          fcVals.push(Number(r.predicted_high));
        });
        if(fcVals.length){
          const meanFc = fcVals.reduce((a,b)=>a+b,0)/fcVals.length;
          biasList.push(actualHigh - meanFc);
        }
      });
      return biasList;
    }

    function updateCorrectionBoxes(){
      const biasList=calcBiases();
      const avgBias=biasList.length? (biasList.reduce((a,b)=>a+b,0)/biasList.length) : 0;
      const today = nycISODate(0);
      const tomorrow = nycISODate(1);

      const meanForecastForDate = (date) => {
        const actual = allRows.find(r=>r.forecast_or_actual==="actual" && r.cli_date===date && r.actual_high);
        const highTime = actual ? actual.high_time : "";
        const vals = allRows
          .filter(r=>r.forecast_or_actual==="forecast" && r.target_date===date && r.predicted_high)
          .filter(r=>{
            if(highTime){
              const fcHHMM=(r.forecast_time||"").substr(11,5);
              if(fcHHMM && compareTimes(fcHHMM, highTime) > 0) return false;
            }
            return true;
          })
          .map(r=>Number(r.predicted_high));
        if (!vals.length) return null;
        return vals.reduce((a,b)=>a+b,0)/vals.length;
      };

      const todayFcAvg = meanForecastForDate(today);
      const tomorrowFcAvg = meanForecastForDate(tomorrow);
      const todayPred = (todayFcAvg==null) ? null : todayFcAvg + avgBias;
      const tomorrowPred = (tomorrowFcAvg==null) ? null : tomorrowFcAvg + avgBias;
      const biasTxt = (avgBias>0?"+":"") + avgBias.toFixed(2);

      document.getElementById("correctionBoxToday").innerHTML =
        `<div class="prediction-value">${todayPred==null?"‚Äì":todayPred.toFixed(1)+"¬∞F"}</div>
        <div class="prediction-subtitle">For ${today} ‚Ä¢ Historical bias: ${biasTxt}¬∞F (${biasList.length} days)</div>`;

      document.getElementById("correctionBoxTomorrow").innerHTML =
        `<div class="prediction-value">${tomorrowPred==null?"‚Äì":tomorrowPred.toFixed(1)+"¬∞F"}</div>
        <div class="prediction-subtitle">For ${tomorrow} ‚Ä¢ Historical bias: ${biasTxt}¬∞F (${biasList.length} days)</div>`;
    }

    /* ---------------- Stats ---------------- */
    function showStats() {
      let count=0, absSum=0, bestSum=0, bestCount=0;
      const dayMap = {};
      filteredRows.forEach(row => {
        const date = row.forecast_or_actual === "actual" ? row.cli_date : row.target_date;
        if (!date) return;
        if (!dayMap[date]) dayMap[date] = [];
        dayMap[date].push(row);
      });
      Object.values(dayMap).forEach(dayRows => {
        const actual = dayRows.find(r => r.forecast_or_actual==="actual");
        const actualHigh = actual ? Number(actual.actual_high) : null;
        if (!Number.isFinite(actualHigh)) return;
        const highTime = actual ? actual.high_time : "";
        let bestErr=999;
        dayRows.forEach(r => {
          if (r.forecast_or_actual!=="forecast" || !r.predicted_high) return;
          if (highTime) {
            const fcHour = (r.forecast_time||"").substr(11,5);
            if (fcHour && compareTimes(fcHour, highTime)>0) return;
          }
          const err = Math.abs(Number(r.predicted_high)-actualHigh);
          absSum += err; count++;
          if (err<bestErr) bestErr=err;
        });
        if (bestErr<999) { bestSum += bestErr; bestCount++; }
      });
      const avgAbs = count ? (absSum/count).toFixed(2) : "--";
      const avgBest = bestCount ? (bestSum/bestCount).toFixed(2) : "--";
      
      const daysWithActual = Object.values(dayMap).filter(rows =>
        rows.some(x => x.forecast_or_actual === "actual" && Number.isFinite(Number(x.actual_high)))
      ).length;
      
      const statsContainer = document.getElementById("stats");
      statsContainer.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">Total Days</div>
          <div class="stat-value">${daysWithActual}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Absolute Error</div>
          <div class="stat-value">${avgAbs}¬∞F</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Average Best Error</div>
          <div class="stat-value">${avgBest}¬∞F</div>
        </div>
      `;
    }

    /* ---------------- Chart ---------------- */
    function showChart() {
      const ctx = document.getElementById('dailyChart').getContext('2d');
      if (window.mainChart) window.mainChart.destroy();
      const dayMap = {};
      filteredRows.forEach(row => {
        const date = row.forecast_or_actual === "actual" ? row.cli_date : row.target_date;
        if (!date) return;
        if (!dayMap[date]) dayMap[date] = [];
        dayMap[date].push(row);
      });
      const labels=[], actuals=[], bestForecasts=[];
      Object.keys(dayMap).sort().forEach(date => {
        const dayRows = dayMap[date];
        const actual = dayRows.find(r => r.forecast_or_actual==="actual");
        const actualHigh = actual ? Number(actual.actual_high) : null;
        const highTime = actual ? actual.high_time : "";
        let best=null, bestErr=999;
        dayRows.forEach(r => {
          if (r.forecast_or_actual!=="forecast" || !r.predicted_high) return;
          if (highTime) {
            const fcHour=(r.forecast_time||"").substr(11,5);
            if (fcHour && compareTimes(fcHour, highTime)>0) return;
          }
          const err = Math.abs(Number(r.predicted_high)-actualHigh);
          if (err<bestErr) { bestErr=err; best=r; }
        });
        if (actualHigh !== null) {
          labels.push(date);
          actuals.push(actualHigh);
          bestForecasts.push(best ? Number(best.predicted_high) : null);
        }
      });

      window.mainChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { 
              label: "Actual High", 
              data: actuals, 
              borderColor: "#059669", 
              backgroundColor: "rgba(5, 150, 105, 0.1)",
              fill: false, 
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 6,
              borderWidth: 3
            },
            { 
              label: "Best Forecast (pre-high)", 
              data: bestForecasts, 
              borderColor: "#2563eb", 
              backgroundColor: "rgba(37, 99, 235, 0.1)",
              fill: false, 
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 6,
              borderWidth: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { 
              display: true, 
              position: "top",
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 13,
                  weight: '500'
                }
              }
            }
          },
          scales: {
            x: { 
              title: {display:true, text:"Date", font: {size: 12, weight: '500'}},
              grid: {color: 'rgba(0,0,0,0.05)'}
            },
            y: { 
              title: {display:true, text:"Temperature (¬∞F)", font: {size: 12, weight: '500'}},
              grid: {color: 'rgba(0,0,0,0.05)'}
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    /* ---------------- Table (prefetches Kalshi via proxy) ---------------- */
async function displayTable() {
  const tb = document.querySelector("#dataTable tbody");
  tb.innerHTML = "";

  // Build day map
  const dayMap = {};
  filteredRows.forEach(r => {
    const date = r.forecast_or_actual === "actual" ? r.cli_date : r.target_date;
    if (!date) return;
    if (!dayMap[date]) dayMap[date] = [];
    dayMap[date].push(r);
  });

  // ‚úÖ Only prefetch real ISO dates (prevents accidental "?date=target_date" calls)
  const isISODate = d => /^\d{4}-\d{2}-\d{2}$/.test(d);
  const dates = Object.keys(dayMap).filter(isISODate).sort();

  // Prefetch Kalshi once per date
  const kalshiByDate = {};
  await Promise.all(dates.map(async d => {
    try { kalshiByDate[d] = await getKalshiLabel(d); }
    catch { kalshiByDate[d] = null; }
  }));

  // Render rows
  dates.forEach(date => {
    const dayRows = dayMap[date];
    const actual = dayRows.find(r => r.forecast_or_actual==="actual");
    const actualHigh = actual ? rNum(actual.actual_high) : null;
    const actualHighTxt = actual && actual.actual_high ? actual.actual_high+"¬∞F" : "";
    const highTime = actual ? actual.high_time : "";
    let bestIdx=-1, bestErr=999;

    dayRows.forEach((r,i) => {
      if (r.forecast_or_actual !== "forecast" || !r.predicted_high || actualHigh===null) return;
      if (highTime) {
        const fcHour = (r.forecast_time||"").substr(11,5);
        if (fcHour && compareTimes(fcHour, highTime)>0) return;
      }
      const err = Math.abs(Number(r.predicted_high)-actualHigh);
      if (err<bestErr) { bestErr=err; bestIdx=i; }
    });

    const k = kalshiByDate[date];
    const label = k && k.label ? k.label : "";
    const exact = k && k.exactTemp != null ? ` (${k.exactTemp.toFixed(1)}¬∞F)` : "";
    const kalshiCell = (k && k.label)
      ? `<a class="kalshi-badge" href="${k.url}" target="_blank" rel="noopener" title="Kalshi settled range">${k.label}${exact}</a>`
      : `<span style="color: var(--text-light); font-size: 12px;">‚Äî</span>`;

    dayRows.forEach((r,i) => {
      if (r.forecast_or_actual!=="forecast" && r.forecast_or_actual!=="actual") return;
      let cls = r.forecast_or_actual==="actual" ? "actual-row" : "forecast-row";
      if (i===bestIdx && r.forecast_or_actual==="forecast") cls += " best";
      const pred = r.predicted_high ? r.predicted_high+"¬∞F" : "";
      const act = r.actual_high ? r.actual_high+"¬∞F" : actualHighTxt;
      const fTime = r.forecast_time ? r.forecast_time.substr(11,5) : "";
      const errTxt = (r.forecast_or_actual==="forecast" && r.predicted_high && actualHigh!==null)
        ? (Number(r.predicted_high)-actualHigh).toFixed(1) : "";
      tb.innerHTML += `
        <tr class="${cls}">
          <td>${r.timestamp ? r.timestamp.substr(0,10) : ""}</td>
          <td>${fTime}</td>
          <td>${date}</td>
          <td>${pred}</td>
          <td>${act}</td>
          <td>${highTime}</td>
          <td>${errTxt}</td>
          <td>${(i===bestIdx && r.forecast_or_actual==="forecast") ? "‚úì" : ""}</td>
          <td>${kalshiCell}</td>
        </tr>`;
    });
  });
}

    /* ---------------- Boot ---------------- */
    reloadCSV();
    updateObservations();                 // ‚Üê call once on load
    // Auto-refresh summary boxes (includes NWS obs + live Kalshi)
    setInterval(() => {
      updateSummaryBoxes();
      updateObservations();               // ‚Üê refresh obs too
    }, 10 * 60 * 1000); // every 10 minutes
  </script>
</body>
</html>
