<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Access – Daily Dew Point</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter',sans-serif; display:flex; align-items:center; justify-content:center;
      min-height:100vh; margin:0; background:#f1f5f9; color:#0f172a; padding:16px; }
    .card { background:#fff; padding:28px; border-radius:16px; box-shadow:0 8px 28px rgba(0,0,0,.12);
      width:100%; max-width:440px; }
    h1 { font-size:24px; margin:0 0 20px; text-align:center; font-weight:700; }
    input { width:100%; padding:12px; margin:8px 0; border:1px solid #cbd5e1; border-radius:8px; font-size:14px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .row .left { display:flex; align-items:center; gap:8px; }
    .row label { font-size:13px; color:#334155; user-select:none }
    button { width:100%; padding:12px; margin-top:12px; border:none; border-radius:8px;
      background:#2563eb; color:#fff; font-weight:600; font-size:15px; cursor:pointer; }
    button:hover { background:#1e40af; }
    .tabs { display:flex; border-bottom:1px solid #e2e8f0; margin-bottom:20px; }
    .tab { flex:1; text-align:center; padding:10px; font-weight:600; cursor:pointer; border-bottom:3px solid transparent; }
    .tab.active { color:#2563eb; border-color:#2563eb; }
    .hidden { display:none; }
    .help { font-size:12px; color:#64748b; margin-top:8px; text-align:center; }
    .error { background:#fef2f2; border:1px solid #fecaca; color:#7f1d1d; padding:10px; border-radius:8px; font-size:13px; margin-top:8px; display:none; }
    .ok { background:#ecfdf5; border:1px solid #a7f3d0; color:#065f46; padding:10px; border-radius:8px; font-size:13px; margin-top:8px; display:none; }
    .link { color:#2563eb; text-decoration:none; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daily Dew Point</h1>
    <div class="tabs">
      <div id="tab-login" class="tab active">Login</div>
      <div id="tab-signup" class="tab">Sign Up</div>
    </div>

    <!-- Login -->
    <form id="form-login">
      <input id="login-email" type="email" placeholder="Email" autocomplete="email" required />
      <div class="row">
        <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" required style="flex:1">
        <label class="left">
          <input id="show-login-pw" type="checkbox"> Show
        </label>
      </div>
      <div class="row">
        <label class="left"><input id="remember-me" type="checkbox"> Keep me signed in</label>
        <a class="link" href="#" id="forgot-link" title="Use magic link if you forgot your password">Magic link</a>
      </div>
      <button type="submit">Log in</button>
      <div id="login-error" class="error"></div>
    </form>

    <!-- Signup -->
    <form id="form-signup" class="hidden">
      <input id="signup-email" type="email" placeholder="Email" autocomplete="email" required />
      <div class="row">
        <input id="signup-password" type="password" placeholder="Password (min 6 chars)" autocomplete="new-password" required style="flex:1">
        <label class="left">
          <input id="show-signup-pw" type="checkbox"> Show
        </label>
      </div>
      <button type="submit">Create account</button>
      <div id="signup-ok" class="ok"></div>
      <div id="signup-error" class="error"></div>
      <div class="help">You’ll get a verification email.</div>
    </form>

    <div class="help">Subscribers only. <a class="link" href="/subscribe.html">Go to subscribe</a></div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  // Keep sessions persistent; DO NOT store passwords.
  const supabase = createClient(
    "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw",
    { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
  );

  // Quick DOM helpers
  const $  = (s,p=document)=>p.querySelector(s);
  const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

  // Tabs
  const tabLogin  = $("#tab-login");
  const tabSignup = $("#tab-signup");
  const formLogin = $("#form-login");
  const formSignup= $("#form-signup");
  tabLogin.onclick = ()=>{ tabLogin.classList.add("active"); tabSignup.classList.remove("active"); formLogin.classList.remove("hidden"); formSignup.classList.add("hidden"); };
  tabSignup.onclick= ()=>{ tabSignup.classList.add("active"); tabLogin.classList.remove("active"); formSignup.classList.remove("hidden"); formLogin.classList.add("hidden"); };

  // Show/hide password
  $("#show-login-pw").addEventListener("change", (e)=>{
    $("#login-password").type = e.target.checked ? "text" : "password";
  });
  $("#show-signup-pw").addEventListener("change", (e)=>{
    $("#signup-password").type = e.target.checked ? "text" : "password";
  });

  // Remember me (email only). Keeping users signed in is handled by Supabase.
  (function hydrateRemembered(){
    const remembered = localStorage.getItem("remember_email");
    if (remembered) $("#login-email").value = remembered;
    $("#remember-me").checked = !!remembered;
  })();

  function rememberEmailMaybe(email){
    if ($("#remember-me").checked) {
      localStorage.setItem("remember_email", email);
    } else {
      localStorage.removeItem("remember_email");
    }
  }

  // Basic email validation (in addition to type="email")
  function isValidEmail(e){
    return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(String(e).trim());
  }

  // If already signed in, route based on profile
  (async ()=>{
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const { data: profile } = await supabase
      .from("profiles")
      .select("subscription_status")
      .eq("id", session.user.id)
      .single();

    window.location.href = (profile?.subscription_status === "active")
      ? "/index.html"
      : "/subscribe.html";
  })();

  // Login
  formLogin.addEventListener("submit", async (e)=>{
    e.preventDefault();
    $("#login-error").style.display = "none";

    const email = $("#login-email").value.trim();
    const password = $("#login-password").value;

    if (!isValidEmail(email)) {
      $("#login-error").textContent = "Please enter a valid email address.";
      $("#login-error").style.display = "block";
      return;
    }

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      $("#login-error").textContent = error.message;
      $("#login-error").style.display = "block";
      return;
    }

    rememberEmailMaybe(email);

    const { data: { user }} = await supabase.auth.getUser();
    const { data: profile } = await supabase
      .from("profiles")
      .select("subscription_status")
      .eq("id", user.id)
      .single();

    window.location.href = (profile?.subscription_status === "active")
      ? "/index.html"
      : "/subscribe.html";
  });

  // Magic link helper (if they forgot password)
  $("#forgot-link").addEventListener("click", async (e)=>{
    e.preventDefault();
    const email = $("#login-email").value.trim();
    if (!isValidEmail(email)) return alert("Enter your email first.");
    const { error } = await supabase.auth.signInWithOtp({
      email,
     // in login.html, inside supabase.auth.signUp(...)
  options: {
  emailRedirectTo: "https://waheedweather.dewdropventures.com/subscribe.html"
  }

    });
    if (error) return alert(error.message);
    alert("Check your inbox for a magic link.");
  });

  // Signup (handle already-registered + resend verification)
  formSignup.addEventListener("submit", async (e)=>{
    e.preventDefault();
    $("#signup-error").style.display = "none";
    $("#signup-ok").style.display = "none";

    const email = $("#signup-email").value.trim();
    const password = $("#signup-password").value;

    if (!isValidEmail(email)) {
      $("#signup-error").textContent = "Please enter a valid email address.";
      $("#signup-error").style.display = "block";
      return;
    }

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: "https://waheedweather.dewdropventures.com/login.html" }
    });

    if (error) {
      // Supabase typically returns "User already registered" for duplicates
      const msg = (error.message || "").toLowerCase();
      if (msg.includes("already registered") || msg.includes("already exists")) {
        // Offer resend verification instead of creating again
        const wantResend = confirm("You're already registered. Resend verification email?");
        if (wantResend) {
          const { error: resendErr } = await supabase.auth.resend({
            type: "signup",
            email
          });
          if (resendErr) {
            $("#signup-error").textContent = resendErr.message;
            $("#signup-error").style.display = "block";
          } else {
            $("#signup-ok").textContent = "Verification email resent. Check your inbox.";
            $("#signup-ok").style.display = "block";
          }
        }
        return;
      }
      $("#signup-error").textContent = error.message;
      $("#signup-error").style.display = "block";
      return;
    }

    $("#signup-ok").textContent = "Check your inbox to confirm your email!";
    $("#signup-ok").style.display = "block";
  });
</script>
</body>
</html>
