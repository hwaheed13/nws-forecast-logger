<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Access – Daily Dew Point</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; margin: 0; background: #f1f5f9; color: #0f172a; padding: 16px;
    }
    .card {
      background: #fff; padding: 28px; border-radius: 16px; box-shadow: 0 8px 28px rgba(0,0,0,.12);
      width: 100%; max-width: 440px;
    }
    h1 { font-size: 24px; margin: 0 0 20px; text-align: center; font-weight: 700; }

    /* Inputs / labels */
    input[type="email"], input[type="password"] {
      width: 100%; padding: 12px; margin: 8px 0 0 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px;
      outline: none;
    }
    input[type="email"]:focus, input[type="password"]:focus {
      border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    }

    /* Buttons (blue) */
    button {
      width: 100%; padding: 12px; margin-top: 12px; border: none; border-radius: 8px;
      background: #2563eb; color: #fff; font-weight: 600; font-size: 15px; cursor: pointer;
    }
    button:hover { background: #1e40af; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 10px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab.active { color: #2563eb; border-color: #2563eb; }

    /* Helpers */
    .hidden { display: none; }
    .help { font-size: 12px; color: #64748b; margin-top: 8px; text-align: center; }
    .error { background: #fef2f2; border: 1px solid #fecaca; color: #7f1d1d; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 8px; display: none; }
    .ok { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; padding: 10px; border-radius: 8px; font-size: 13px; margin-top: 8px; display: none; }
    .link { color: #2563eb; text-decoration: none; }

    /* Spacing blocks */
    .field { margin-bottom: 12px; }
    .pw-block .toggle,
    .remember-block label,
    .magic-block a {
      display: block;
      margin-top: 6px;
      font-size: 13px;
      color: #334155;
    }
    .pw-block .toggle input,
    .remember-block input {
      transform: translateY(1px);
      margin-right: 8px;
    }
    .pw-block .toggle { text-align: right; }  /* “Show password” on its own line, right-aligned */
    .remember-block label { text-align: left; } /* “Keep me signed in” on its own line */
    .magic-block a { text-align: left; }        /* “Send magic link” on its own line */

    /* Action buttons under errors (login/signup flows) */
    #login-actions, #signup-actions {
      display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
    }
    #login-actions button, #signup-actions button {
      width: auto; padding: 10px 12px; font-size: 13px;
      background: #e2e8f0; color: #0f172a;
    }
    #login-actions button:hover, #signup-actions button:hover { background: #cbd5e1; }

    /* Mobile tweaks */
    @media (max-width: 480px) {
      .pw-block .toggle { text-align: left; }  /* on very narrow devices, left-align the toggle */
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Daily Dew Point</h1>

    <div class="tabs">
      <div id="tab-login" class="tab active">Login</div>
      <div id="tab-signup" class="tab">Sign Up</div>
    </div>

    <!-- Login -->
    <form id="form-login">
      <div class="field">
        <input id="login-email" type="email" placeholder="Email" autocomplete="email" required />
      </div>

      <div class="field pw-block">
        <input id="login-password" type="password" placeholder="Password" autocomplete="current-password" required />
        <label class="toggle"><input id="show-login-pw" type="checkbox"> Show password</label>
      </div>

      <div class="field remember-block">
        <label><input id="remember-me" type="checkbox"> Keep me signed in</label>
      </div>

      <div class="field magic-block">
        <a class="link" href="#" id="forgot-link" title="Send a magic login link">Send magic link</a>
      </div>

      <button type="submit">Log in</button>
      <div id="login-error" class="error"></div>
    </form>

    <!-- Signup -->
    <form id="form-signup" class="hidden">
      <div class="field">
        <input id="signup-email" type="email" placeholder="Email" autocomplete="email" required />
      </div>

      <div class="field pw-block">
        <input id="signup-password" type="password" placeholder="Password (min 6 chars)" autocomplete="new-password" required />
        <label class="toggle"><input id="show-signup-pw" type="checkbox"> Show password</label>
      </div>

      <button type="submit">Create account</button>
      <div id="signup-ok" class="ok"></div>
      <div id="signup-error" class="error"></div>
      <div class="help">You’ll get a verification email.</div>
    </form>

    <div class="help">Subscribers only. <a class="link" href="/dashboard/subscribe.html">Go to subscribe</a></div>
  </div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js";

  const supabase = createClient(
    "https://ztjtuhkjkqchsiuuvmzs.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0anR1aGtqa3FjaHNpdXV2bXpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTUwODIsImV4cCI6MjA3MTg5MTA4Mn0.g7Zq-YbHxBzw732PhVfTf7XGiR080gRndsrzc0YPHfw",
    { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true } }
  );

  // DOM helper
  const $ = (s,p=document)=>p.querySelector(s);

  // Tabs
  const tabLogin  = $("#tab-login");
  const tabSignup = $("#tab-signup");
  const formLogin = $("#form-login");
  const formSignup= $("#form-signup");

  tabLogin.onclick = ()=>{
    tabLogin.classList.add("active");
    tabSignup.classList.remove("active");
    formLogin.classList.remove("hidden");
    formSignup.classList.add("hidden");
  };
  tabSignup.onclick= ()=>{
    tabSignup.classList.add("active");
    tabLogin.classList.remove("active");
    formSignup.classList.remove("hidden");
    formLogin.classList.add("hidden");
  };

  // Show/hide password toggles
  $("#show-login-pw")?.addEventListener("change", (e)=>{
    $("#login-password").type = e.target.checked ? "text" : "password";
  });
  $("#show-signup-pw")?.addEventListener("change", (e)=>{
    $("#signup-password").type = e.target.checked ? "text" : "password";
  });

  // Remember email (optional)
  (function hydrateRemembered(){
    const remembered = localStorage.getItem("remember_email");
    if (remembered) $("#login-email").value = remembered;
    const cb = $("#remember-me"); if (cb) cb.checked = !!remembered;
  })();
  function rememberEmailMaybe(email){
    const cb = $("#remember-me");
    if (cb?.checked) localStorage.setItem("remember_email", email);
    else localStorage.removeItem("remember_email");
  }

  const isValidEmail = (e)=>/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(String(e).trim());
  const ALLOW = new Set(["active","trialing"]);

  async function routeByProfile(userId){
    const { data: profile } = await supabase
      .from("profiles")
      .select("subscription_status")
      .eq("id", userId)
      .maybeSingle();
    const status = profile?.subscription_status ?? "inactive";
    window.location.href = ALLOW.has(status) ? "/dashboard" : "/dashboard/subscribe.html";

  }

  // Password recovery detection
  const urlNow = new URL(window.location.href);
  const isRecovery = urlNow.hash.includes("type=recovery") || urlNow.searchParams.get("type") === "recovery";

  // Inline reset-password UI (after clicking recovery link)
  async function showRecoveryUI() {
    const { data: { session } } = await supabase.auth.getSession();

    // Hide normal UI
    document.querySelector(".tabs")?.classList.add("hidden");
    document.getElementById("form-login")?.classList.add("hidden");
    document.getElementById("form-signup")?.classList.add("hidden");

    const card = document.querySelector(".card");
    const box = document.createElement("div");
    box.style.marginTop = "8px";
    box.innerHTML = `
      <h2 style="font-size:18px;margin:0 0 8px;">Set a new password</h2>
      <p class="help" style="margin:0 0 12px;">Enter a new password for your account.</p>
      <input id="npw" type="password" placeholder="New password (min 6 chars)" style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:8px;margin-bottom:8px;">
      <input id="npw2" type="password" placeholder="Confirm new password" style="width:100%;padding:12px;border:1px solid #cbd5e1;border-radius:8px;margin-bottom:8px;">
      <button id="btn-setpw" style="width:100%;padding:12px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-weight:600;">Set new password</button>
      <div id="pw-ok" class="ok" style="display:none;margin-top:8px;"></div>
      <div id="pw-err" class="error" style="display:none;margin-top:8px;"></div>
    `;
    card.appendChild(box);

    const btn = box.querySelector("#btn-setpw");
    const ok  = box.querySelector("#pw-ok");
    const err = box.querySelector("#pw-err");

    if (!session) {
      err.textContent = "This reset link is invalid or expired. Request a new one.";
      err.style.display = "block";
      return;
    }

    btn.onclick = async () => {
      err.style.display = "none"; ok.style.display = "none";
      const p1 = box.querySelector("#npw").value;
      const p2 = box.querySelector("#npw2").value;
      if (!p1 || p1.length < 6) { err.textContent = "Password must be at least 6 characters."; err.style.display="block"; return; }
      if (p1 !== p2) { err.textContent = "Passwords do not match."; err.style.display="block"; return; }

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) { err.textContent = error.message; err.style.display = "block"; return; }

      ok.textContent = "Password updated. Taking you to your account…";
      ok.style.display = "block";

      const { data: { user } } = await supabase.auth.getUser();
      if (user?.id) await routeByProfile(user.id);
      else location.replace("/login.html");
    };
  }

  // Auto-route / switch logic
  (async ()=>{
    const params = new URLSearchParams(location.search);

    // Explicit account switch
    if (params.get("switch") === "1") {
      await supabase.auth.signOut();
      localStorage.removeItem("remember_email");
      document.getElementById("tab-login")?.click?.();
      return;
    }

    // If arriving from a recovery email, show reset UI and stop here
    if (isRecovery) {
      await showRecoveryUI();
      return;
    }

    // Normal path: if already signed in, route (only if active/trialing)
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user?.id) return;

    await supabase.auth.refreshSession();

    const { data: profile } = await supabase
      .from("profiles")
      .select("subscription_status")
      .eq("id", session.user.id)
      .maybeSingle();

    const status = profile?.subscription_status ?? "inactive";
    if (ALLOW.has(status)) {
    location.replace("/dashboard");
    return;
    }

    // Inactive: show note and a Sign out button to let user switch accounts
    const note = document.getElementById("login-error");
    if (note) {
      note.textContent = "You're signed in but not subscribed. Sign in with a different account or sign out below.";
      note.style.display = "block";
    }

    const signout = document.createElement("button");
    signout.type = "button";
    signout.textContent = "Sign out";
    signout.style.marginTop = "8px";
    signout.onclick = async () => {
      await supabase.auth.signOut();
      localStorage.removeItem("remember_email");
      location.reload();
    };
    document.getElementById("form-login")?.appendChild(signout);
  })();

  // Login submit (with inline recovery actions when it fails)
  formLogin.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const errBox = $("#login-error");
    errBox.style.display = "none";

    // remove any prior action buttons to avoid duplicates
    document.getElementById("login-actions")?.remove();

    const email = $("#login-email").value.trim();
    const password = $("#login-password").value;
    if (!isValidEmail(email)) {
      errBox.textContent = "Please enter a valid email address.";
      errBox.style.display = "block";
      return;
    }

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      const msg = (error.message || "").toLowerCase();

      errBox.textContent = msg.includes("invalid login credentials")
        ? "Wrong email or password."
        : error.message;
      errBox.style.display = "block";

      const actions = document.createElement("div");
      actions.id = "login-actions";

      const reset = document.createElement("button");
      reset.type = "button";
      reset.textContent = "Reset Password";
      reset.onclick = async () => {
        const { error: rErr } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: "https://dailydewpoint.com/dashboard/login.html"
        });
        if (rErr) { errBox.textContent = rErr.message; errBox.style.display = "block"; }
        else { alert("Password reset email sent."); }
      };

      const magic = document.createElement("button");
      magic.type = "button";
      magic.textContent = "Send Magic Link";
      magic.onclick = async () => {
        const { error: otpErr } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: "https://dailydewpoint.com/dashboard/login.html" }
        });
        if (otpErr) { errBox.textContent = otpErr.message; errBox.style.display = "block"; }
        else { alert("Magic link sent. Check your inbox."); }
      };

      actions.append(reset, magic);

      if (msg.includes("confirm") || msg.includes("verify")) {
        const resend = document.createElement("button");
        resend.type = "button";
        resend.textContent = "Resend Verification";
        resend.onclick = async () => {
          const { error: rvErr } = await supabase.auth.resend({ type: "signup", email });
          if (rvErr) { errBox.textContent = rvErr.message; errBox.style.display = "block"; }
          else { alert("Verification email resent."); }
        };
        actions.append(resend);
      }

      errBox.insertAdjacentElement("afterend", actions);
      return;
    }

    // success
    rememberEmailMaybe(email);
    const { data: { user } } = await supabase.auth.getUser();
    if (!user?.id) {
      errBox.textContent = "Sign-in succeeded, but no user session was returned.";
      errBox.style.display = "block";
      return;
    }
    await routeByProfile(user.id);
  });

  // Magic link (login)
  $("#forgot-link")?.addEventListener("click", async (e)=>{
    e.preventDefault();
    const email = $("#login-email").value.trim();
    if (!isValidEmail(email)) return alert("Enter your email first.");
    const { error } = await supabase.auth.signInWithOtp({
      email,
      options: { emailRedirectTo: "https://dailydewpoint.com/dashboard/login.html" }
    });
    if (error) return alert(error.message);
    alert("Check your inbox for a magic link.");
  });

  // Signup with "account exists" UX (even when Supabase returns 200)
  formSignup.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const okBox = $("#signup-ok");
    const errBox = $("#signup-error");
    okBox.style.display = "none";
    errBox.style.display = "none";

    const email = $("#signup-email").value.trim();
    const password = $("#signup-password").value;
    if (!isValidEmail(email)) { errBox.textContent = "Please enter a valid email address."; errBox.style.display = "block"; return; }

    const { data: { session } } = await supabase.auth.getSession();
    if (session?.user?.email && session.user.email.toLowerCase() === email.toLowerCase()) {
      errBox.textContent = "You're already signed in with this email. Use Login or go to Subscribe.";
      errBox.style.display = "block";
      return;
    }

    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: { emailRedirectTo: "https://dailydewpoint.com/dashboard/login.html" }
    });

    const identities = data?.user?.identities ?? [];
    if (!error && identities.length === 0) {
      showExistsActions(errBox, okBox, email);
      return;
    }

    if (error) {
      const msg = (error.message || "").toLowerCase();
      if (msg.includes("already registered") || msg.includes("already exists")) {
        showExistsActions(errBox, okBox, email);
        return;
      }
      errBox.textContent = error.message;
      errBox.style.display = "block";
      return;
    }

    okBox.textContent = "Check your inbox to confirm your email!";
    okBox.style.display = "block";
  });

  function showExistsActions(errBox, okBox, email) {
    errBox.innerHTML = `An account with <strong>${email}</strong> already exists.`;
    errBox.style.display = "block";

    let actions = document.getElementById("signup-actions");
    if (!actions) {
      actions = document.createElement("div");
      actions.id = "signup-actions";

      const toLogin = document.createElement("button");
      toLogin.type = "button";
      toLogin.textContent = "Go to Login";
      toLogin.onclick = () => {
        $("#login-email").value = email;
        tabLogin.click();
      };

      const magic = document.createElement("button");
      magic.type = "button";
      magic.textContent = "Send Magic Link";
      magic.onclick = async () => {
        const { error: otpErr } = await supabase.auth.signInWithOtp({
          email,
          options: { emailRedirectTo: "https://dailydewpoint.com/dashboard/login.html" }
        });
        if (otpErr) { errBox.textContent = otpErr.message; }
        else { okBox.textContent = "Magic link sent. Check your inbox."; okBox.style.display = "block"; }
      };

      const reset = document.createElement("button");
      reset.type = "button";
      reset.textContent = "Reset Password";
      reset.onclick = async () => {
        const { error: rErr } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: "https://dailydewpoint.com/dashboard/login.html"
        });
        if (rErr) { errBox.textContent = rErr.message; errBox.style.display = "block"; }
        else { okBox.textContent = "Password reset email sent."; okBox.style.display = "block"; }
      };

      actions.append(toLogin, magic, reset);
      errBox.insertAdjacentElement("afterend", actions);
    }
  }
</script>
</body>
</html>
